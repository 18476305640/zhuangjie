<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>Jenkins实战 - wolai 笔记</title><link rel="shortcut icon" href="media/unnamed (1)_1.jpg"></link></head><body><header><div class="image has" style="background-position-y: 50%; background-image: url(&quot;https://cdn.wostatic.cn/cover/painting/fQySTPQQe5iV7xgFjbyimZ.jpg&quot;)"></div><div class="title"><div class="banner"><div class="icon icon-image" style="background-image: url(&quot;media/unnamed%20(1).jpg&quot;)"></div></div><div data-title="Jenkins实战" class="main-title"></div></div></header><article><h1 class="wolai-block"><span class="inline-wrap">持续集成实战</span></h1><h2 class="wolai-block"><span class="inline-wrap">【GitLab<span class="jill"></span>仓库 192.168.87.100】</span></h2><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">安装相关依赖</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">yum -y install policycoreutils openssh-server openssh-clients postﬁx</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">启动<span class="jill"></span>ssh<span class="jill"></span>服务&amp;设置为开机启动</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">systemctl enable sshd &amp;&amp; sudo systemctl start sshd</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">设置<span class="jill"></span>postﬁx<span class="jill"></span>开机自启，并启动，postﬁx<span class="jill"></span>支持<span class="jill"></span>gitlab<span class="jill"></span>发信功能</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">yum install postfix
systemctl enable postﬁx &amp;&amp; systemctl start postﬁx</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">开放<span class="jill"></span>ssh<span class="jill"></span>以及<span class="jill"></span>http<span class="jill"></span>服务，然后重新加载防火墙列表</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">firewall-cmd --add-service=ssh --permanent
firewall-cmd --add-service=http --permanent
firewall-cmd --reload</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">如果关闭防火墙就不需要做以上配置</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">下载<span class="jill"></span>gitlab<span class="jill"></span>包，并且安装在线下载安装包：</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">wget </span><span class="inline-wrap"><a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x"><span>https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x</span></a></span><span class="inline-wrap"> 86_64.rpm</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">安装：</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">rpm -i gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">修改<span class="jill"></span>gitlab<span class="jill"></span>配置</span></li></ol><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">vi</span> /etc/gitlab/gitlab.rb
<span class="token comment">###修改gitlab访问地址和端口，默认为80，我们改为82 </span>
<span class="token comment">#修改external_url 'http://192.168.87.100'</span>
<span class="token comment">#加入nginx['listen_port'] = 82</span></pre></div></code-block><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">重载配置及启动<span class="jill"></span>gitlab</span></li></ol><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>gitlab-ctl reconfigure
gitlab-ctl restart</pre></div></code-block><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">把端口添加到防火墙</span></li></ol><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">82</span>/tcp --permanent 
firewall-cmd --reload</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">启动成功后，看到以下修改管理员<span class="jill"></span>root<span class="jill"></span>密码的页面，修改密码后，然后登录即可
9. 卸载<span class="jill"></span>gitlab
[教程]</span><span class="inline-wrap"><a href="https://www.cnblogs.com/peteremperor/p/10837551.html"><span>https://www.cnblogs.com/peteremperor/p/10837551.html</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">10、使用：
先创建一个组，然后创建一个用户，在组中创建一个项目，为项目添加成员，切换到成员，进行日常开发！
</span><span class="inline-wrap"><code>创建组后向组中加入成员</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16346538723901634653872219.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【Jenkins<span class="jill"></span>安装 192.168.87.101】</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">这里介绍两种方法，一种方法将最新版<span class="jill"></span>jenkins<span class="jill"></span>加入到<span class="jill"></span>yum<span class="jill"></span>源，另外一种是下载指定版本的<span class="jill"></span>rpm<span class="jill"></span>包</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）安装<span class="jill"></span>JDK</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）安装<span class="jill"></span>jenkins</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">wget -O ：下载并以不同的文件名保存</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">yum<span class="jill"></span>的<span class="jill"></span>repo<span class="jill"></span>中默认没有<span class="jill"></span>Jenkins，需要先将<span class="jill"></span>Jenkins<span class="jill"></span>存储库添加到<span class="jill"></span>yum repos，执行下面的命令：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#准备</span>
yum  -y <span class="token function">install</span> epel-release
yum -y <span class="token function">install</span> daemonize
<span class="token comment">#正式安装</span>
<span class="token function">wget</span> -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
<span class="token function">rpm</span> --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
yum <span class="token function">install</span> -y jenkins <span class="token comment">#默认安装最新的</span>
systemctl <span class="token builtin class-name">enable</span> jenkins  <span class="token comment">#开机自启</span>
<span class="token comment">#vim /etc/sysconfig/jenkins   #修改内容： JENKINS_USER=“root” JENKINS_PORT=“8888”</span>
<span class="token function">sed</span> -i  <span class="token string">"s/JENKINS_PORT=<span class="token entity" title="\&quot;">\"</span>8080<span class="token entity" title="\&quot;">\"</span>/JENKINS_PORT=<span class="token entity" title="\&quot;">\"</span>8888<span class="token entity" title="\&quot;">\"</span>/"</span> /etc/sysconfig/jenkins
<span class="token function">service</span> jenkins start  <span class="token comment">#启动</span>

<span class="token comment">#开放端口</span>
firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">8888</span>/tcp --permanent
firewall-cmd --reload <span class="token comment">#重载防火墙</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">打开浏览器访问 </span><span class="inline-wrap"><a href="http://192.168.87.101:8888"><span>http://192.168.87.101:8888</span></a></span></div></div><h4 class="wolai-block"><span class="inline-wrap">1、配置<span class="jill"></span>Jenkins</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个管理员用户 -&gt;  实例配置  -&gt; 可以安装推荐的插件或另一种。
</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345225884471634522588357.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）配置为国内插件下载地址：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>cd <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>jenkins<span class="token operator">/</span>updates
sed <span class="token operator">-</span>i <span class="token string">'s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g'</span> <span class="token keyword module">default</span><span class="token punctuation">.</span><span class="token property-access">json</span>
sed <span class="token operator">-</span>i <span class="token string">'s/http:\/\/www.google.com/https:\/\/www.baidu.com/g'</span> <span class="token keyword module">default</span><span class="token punctuation">.</span><span class="token property-access">json</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">Manage Plugins<span class="jill"></span>点击<span class="jill"></span>Advanced，把<span class="jill"></span>Update Site<span class="jill"></span>改为国内插件下载地址：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json"><span>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Sumbit<span class="jill"></span>后，在浏览器输入： </span><span class="inline-wrap"><a href="http://101机器ip:8888/restart"><span>http://101<span class="jill"></span>机器<span class="jill"></span>ip:8888/restart</span></a></span><span class="inline-wrap"> ，重启<span class="jill"></span>Jenkins</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627721279406-1627721279398.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）安装中文插件</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">安装插件的插件后，会帮我们安装中文插件，如果没有搜索&quot;Chinese&quot;，安装</span></div></div><h4 class="wolai-block"><span class="inline-wrap">2、创建与<span class="jill"></span>GitLab<span class="jill"></span>的关联</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：使用普通凭证从<span class="jill"></span>gitlab<span class="jill"></span>上拉取代码 -&gt;  使用<span class="jill"></span>ssh<span class="jill"></span>凭证从<span class="jill"></span>gitlab<span class="jill"></span>上拉取代码</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>实现在<span class="jill"></span>Jenkins<span class="jill"></span>上拉取<span class="jill"></span>Gitlab<span class="jill"></span>上的代码</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>Jenkins<span class="jill"></span>上安装<span class="jill"></span>Credentials Binding ,安装 Git<span class="jill"></span>插件 、在<span class="jill"></span>Jenkins<span class="jill"></span>服务器上安装<span class="jill"></span>git (yum install git -y  &amp;&amp; git --version)</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、创建普通凭证</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626250522291-1626250522234.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>使用<span class="jill"></span>ssh<span class="jill"></span>凭证来拉取</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、使用<span class="jill"></span>ssh-keygen<span class="jill"></span>生成<span class="jill"></span>ssh，打开/root/.ssh/下<span class="jill"></span>cat<span class="jill"></span>公钥  复制到<span class="jill"></span>gitlab<span class="jill"></span>设置中的<span class="jill"></span>ssh：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251665628-1626251665529.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3、配置<span class="jill"></span>ssh<span class="jill"></span>凭证</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626252147796-1626252147756-image-20210714164202919.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">3、构建流水线环境</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">流水线构建项目，构建项目由之前的流程式转为了脚本（Pipeline）,我们创建一个流水线项目后，我们只需编写/生成一个<span class="jill"></span>Pipeline 即可完成对项目的拉取、构建、部署等操作。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：安装插件（Pipeline，安装推荐的插件中包含）  -&gt; 进行项目构建脚本（Pipeline）书写  -&gt;  查看</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>1、安装插件</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626419582840-1626419582796.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">4、Extended Choice Parameter<span class="jill"></span>参数构建</span></h4><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345284507411634528450683.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">示例：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/163453960961759d3f8f4632c99f1cb0ca9307497e741.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">5、注意事项</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">1)拉取代码时，Jenkins<span class="jill"></span>脚本中的<span class="jill"></span>git<span class="jill"></span>凭证是<span class="jill"></span>ssh
</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345397889081634539788897.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">6、代码审查</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>安装</code></span></div></div><blockquote class="wolai-block"><span class="inline-wrap"><b>注意，sonar6.7<span class="jill"></span>版本需要一个<span class="jill"></span>mysql5.7<span class="jill"></span>的数据库，jdk1.8<span class="jill"></span>以上比如<span class="jill"></span>8.5</b></span><span class="inline-wrap"> ，然后再创建一个名为</span><span class="inline-wrap"><code>sonar</code></span><span class="inline-wrap"> 的数据库。然后再开始安装<span class="jill"></span>Sonar，启动后再开放端口且登录获取<span class="jill"></span>token ：</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：保证存在名为<span class="jill"></span>sonar<span class="jill"></span>的数据库 -&gt;  安装<span class="jill"></span>Conar  -&gt; 余下工作</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>保证存在名为<span class="jill"></span>sonar<span class="jill"></span>的数据库</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>安装<span class="jill"></span>Conar</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">下载<span class="jill"></span>sonar<span class="jill"></span>压缩包： </span><span class="inline-wrap"><a href="https://www.sonarqube.org/downloads/"><span>https://www.sonarqube.org/downloads/</span></a></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">wget</span> https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-6.7.4.zip
yum <span class="token function">install</span> <span class="token function">unzip</span>
<span class="token function">unzip</span> sonarqube-6.7.4.zip <span class="token comment">#解压</span>
<span class="token function">mv</span> sonarqube-6.7.4/* /usr/local/ <span class="token comment">#移动文件</span>

<span class="token function">useradd</span> sonar <span class="token comment">#创建sonar用户，必须sonar用于启动，否则报错</span>
<span class="token function">chown</span> -R sonar. /usr/local/sonarqube-6.7.4 <span class="token comment">#更改sonar目录及文件权限修改sonar配置文件</span>

<span class="token function">vim</span> /usr/local/sonarqube-6.7.4/conf/sonar.properties
<span class="token comment">#直接将下面粘贴到配置上去，而端口不作修改（默认9000）</span>

sonar.jdbc.username<span class="token operator">=</span>root
sonar.jdbc.password<span class="token operator">=</span><span class="token number">3333</span>  
sonar.jdbc.url<span class="token operator">=</span>jdbc:mysql://localhost:3306/sonar?useUnicode<span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">characterEncoding</span><span class="token operator">=</span>utf8<span class="token operator">&amp;</span><span class="token assign-left variable">rewriteBatchedStatements</span><span class="token operator">=</span>true<span class="token operator">&amp;</span>useConﬁgs<span class="token operator">=</span> maxPerformance<span class="token operator">&amp;</span><span class="token assign-left variable">useSSL</span><span class="token operator">=</span>false

<span class="token builtin class-name">cd</span> /usr/local/sonarqube-6.7.4

<span class="token comment">#su sonar 不能使用root用户启动！！！所以下面在root用户下使用如下使用启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh start <span class="token comment">#启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh status <span class="token comment">#查看状态</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh stop <span class="token comment">#停止</span>

<span class="token function">tail</span> -f logs/sonar.logs <span class="token comment">#查看日志访问sonar http://192.168.66.101:9000</span>
<span class="token comment">#开放端口</span>
firewall-cmd  --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">9000</span>/tcp --permanent
firewall-cmd --reload
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>余下工作</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2)登录：默认  admin/admin</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	获取<span class="jill"></span>token:</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	输入<span class="jill"></span>admin , 得到如下信息,需要摘取保存<span class="jill"></span>token</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	admin: </span><span class="inline-wrap"><b>d6065dbc1e1cfcd3a9714614b16d6bd816246d29</b></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626709303395-1626709303372.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">Sonar<span class="jill"></span>与<span class="jill"></span>Jenkins<span class="jill"></span>整合</span></h4><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925229389-1626925229368.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>安装插件</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">
</span><br/></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345655278061634565527688.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>在<span class="jill"></span>Jenkins<span class="jill"></span>安装<span class="jill"></span>Sonar-Scanner<span class="jill"></span>工具</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">
</span><br/></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925200244-1626925200242-image-20210720211841704.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Manage Jenkins-&gt;Global Tool Conﬁguration  添加一个凭证</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925096630-1626925096623-image-20210720211228770.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>在<span class="jill"></span>jenkins“系统配置”中，作如下配置</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925064354-1626925064346-image-20210720211416805.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>在项目<span class="jill"></span>Jenkins<span class="jill"></span>脚本中</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16345668961331634566895867.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">7、编译打包</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>环境准备</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">需要确保，jenkin<span class="jill"></span>主机安装了<span class="jill"></span>jdk、maven（配置好阿里云镜像，然后再看下面）
2、Jenkins<span class="jill"></span>上配置</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>1：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259189981-1626259189950.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259391664-1626259391644.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>2：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627725746059-1627725746011.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>对于公共模块</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">我们需要将公共依赖进行安装，所以需要编辑项目根目录下 “Jenkinsfile”  脚本,加入“编译，安装公共子工程” 这个 阶段：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"3b3eca2f-e2d7-44e5-8e11-e98ee29953dc"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.133:zhuangjie/tensquare_back.git"</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">""</span>"
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后在确保各个模块&quot;pom.xml&quot; 存在打包插件(父工程的该插件可以删除了)：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Xml" class="marker"></div><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>父模块上传到服务</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">这样就能确保依赖安装能完成了。下面我们就进行对可运行的微服务进行打包：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">因为<span class="jill"></span>zull<span class="jill"></span>这个模块时依赖了父模块，所以我们需要确保服务器的本地仓库有父工程：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/root/.m2/repository/com/tensquare
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># mv /home/zhuangjie/桌面/tensquare_parent/ ./</span>
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># ll</span>
drwxr-xr-x. <span class="token number">3</span> root      root      <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:18 tensquare_common
drwxrwxrwx. <span class="token number">3</span> zhuangjie zhuangjie <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:37 tensquare_parent</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">我们移动的文件目录：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549375224-1627549375170.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后再进行构建。这样我们在拉取的代码目录中就打包好了该模块的<span class="jill"></span>jar<span class="jill"></span>文件（测试<span class="jill"></span>jar<span class="jill"></span>可正常运行）。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549978651-1627549978565.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">8、Docker<span class="jill"></span>环境</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">简单一句话总结：Docker</span><span class="inline-wrap"><b>技术就是让我们更加高效轻松地将任何应用在</b></span><span class="inline-wrap">Linux</span><span class="inline-wrap"><b>服务器部署和使用</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">`【Docker<span class="jill"></span>安装】``</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）卸载旧版本</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum list installed <span class="token operator">|</span> <span class="token function">grep</span> docker <span class="token comment">#列出当前所有docker的包</span>
yum -y remove docker  <span class="token comment">#的包名称 卸载docker包</span>
<span class="token function">rm</span> -rf /var/lib/docker <span class="token comment">#删除docker的所有镜像和容器</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）安装必要的软件包</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils  device-mapper-persistent-data  lvm2</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）设置下载的镜像仓库</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
<span class="token comment">#或使用加速镜像:  yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）列出需要安装的版本列表</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum list docker-ce --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -r  </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）安装指定版本（这里使用<span class="jill"></span>18.0.1<span class="jill"></span>版本）</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce-18.06.1.ce</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">6）查看版本&amp;设置开机自启</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker -v
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> docker <span class="token comment">#设置开机启动  </span>
systemctl is-enabled docker  <span class="token comment">#查看是否设置为开机自启</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">7）启动<span class="jill"></span>Docker</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> systemctl start docker <span class="token comment">#启动</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">8）添加阿里云镜像下载地址（除此还是拉取与推送的信任列表）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">vi /etc/docker/daemon.json</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Json" class="marker"></div><pre><span class="token punctuation">{</span> 
  <span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"https://zydiol88.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">9）重启<span class="jill"></span>Docker</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> systemctl restart docker  
systemctl status docker  <span class="token comment">#查看docker状态</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">离线安装方式请参考：</span><span class="inline-wrap"><a href="https://www.cnblogs.com/kingsonfu/p/11576797.html"><span>https://www.cnblogs.com/kingsonfu/p/11576797.html</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>【docker<span class="jill"></span>命令】</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）镜像命令：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">镜像：相当于应用的安装包，在<span class="jill"></span>Docker<span class="jill"></span>部署的任何应用都需要先构建成为镜像</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker search 镜像名称 <span class="token comment">#搜索镜像</span>
docker pull 镜像名称 <span class="token comment">#拉取镜像 示例：docker pull nginx</span>
docker images <span class="token comment">#查看本地所有镜像</span>
docker rmi -f 镜像名称 <span class="token comment">#删除镜像(即使在运行)</span>
docker rmi -f <span class="token variable"><span class="token variable">$(</span>docker images -qa<span class="token variable">)</span></span> <span class="token comment">#删除所有镜像</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）容器命令</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">容器：容器是由镜像创建而来。容器是<span class="jill"></span>Docker<span class="jill"></span>运行应用的载体，每个应用都分别运行在<span class="jill"></span>Docker<span class="jill"></span>的每个
容器中。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker run -di -p 对应宿主机那个端口:开放应用端口  镜像名称:标签 <span class="token comment">#运行容器（默认是前台运行），di:i是运行，d是后台;  -p是public的意思;</span>
docker <span class="token function">ps</span> <span class="token comment">#查看运行的容器</span>
docker <span class="token function">ps</span> -a <span class="token comment">#查询所有容器</span>

docker <span class="token builtin class-name">exec</span> -it 容器ID/容器名称 /bin/bash <span class="token comment">#进入容器内部</span>
docker start/stop/restart 容器名称/ID <span class="token comment">#启动/停止/重启容器</span>
docker <span class="token function">rm</span> -f 容器名称/ID <span class="token comment">#删除容器</span>
docker <span class="token function">rm</span> <span class="token variable"><span class="token variable">`</span>docker <span class="token function">ps</span> -a -q<span class="token variable">`</span></span> <span class="token comment">#删除所有容器</span>
docker logs -f -t --tail 行数 容器名  <span class="token comment">#查看容器运行日志</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>【镜像的制作】</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面将 &quot;ttensquare_eureka_server-1.0-SNAPSHOT.jar&quot; enreka<span class="jill"></span>微服务制作成一个<span class="jill"></span>docker<span class="jill"></span>镜像</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）上传<span class="jill"></span>Eureka<span class="jill"></span>的微服务<span class="jill"></span>jar<span class="jill"></span>包到<span class="jill"></span>linux
2）编写<span class="jill"></span>Dockerfile</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>FROM openjdk:8-jdk-alpine
ARG JAR_FILE
COPY <span class="token variable">${JAR_FILE}</span> app.jar
EXPOSE <span class="token number">10086</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>,<span class="token string">"-jar"</span>,<span class="token string">"/app.jar"</span><span class="token punctuation">]</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）构建镜像</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker build --build-arg <span class="token assign-left variable">JAR_FILE</span><span class="token operator">=</span>tensquare_eureka_server-1.0-SNAPSHOT.jar -t eureka:v1 <span class="token builtin class-name">.</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）查看镜像是否创建成功</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker images</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）创建容器</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker run -i --name<span class="token operator">=</span>eureka -p <span class="token number">10086</span>:10086 eureka:v1</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">6）访问容器
</span><span class="inline-wrap"><a href="http://192.168.66.101:10086"><span>http://192.168.66.101:10086</span></a></span></div></div><h4 class="wolai-block"><span class="inline-wrap">9、镜像制作</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在这个过程中不需要在<span class="jill"></span>Jenkins<span class="jill"></span>中安装插件来辅助，假如<span class="jill"></span>jenkins<span class="jill"></span>所在机器要向<span class="jill"></span>harbor<span class="jill"></span>机器推送容器，只需要<span class="jill"></span>jenkins<span class="jill"></span>对<span class="jill"></span>docker<span class="jill"></span>配置将<span class="jill"></span>harbor<span class="jill"></span>加入信任列表且能登录到<span class="jill"></span>Harbor<span class="jill"></span>服务器即可，Harbor<span class="jill"></span>能被登录成功即可！
而对于项目内部，需要加入&quot;Dockerfile&quot; 文件</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">当程序在项目根目录下执行“mvn -f ${currentProjectName}  clean package dockerfile:build” 时，就会进行编译打包，制作成镜像！</span></div></div><h2 class="wolai-block"><span class="inline-wrap">【Harbor<span class="jill"></span>环境 192.168.87.102】</span></h2><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627212945189-1627212945174.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">简介：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Harbor（港口，港湾）是一个用于存储和分发<span class="jill"></span>Docker<span class="jill"></span>镜像的企业级<span class="jill"></span>Registry<span class="jill"></span>服务器。
除了<span class="jill"></span>Harbor<span class="jill"></span>这个私有镜像仓库之外，还有<span class="jill"></span>Docker<span class="jill"></span>官方提供的<span class="jill"></span>Registry。相对<span class="jill"></span>Registry，Harbor<span class="jill"></span>具有很
多优势：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">提供分层传输机制，优化网络传输 Docker<span class="jill"></span>镜像是是分层的，而如果每次传输都使用全量文件(所以
用<span class="jill"></span>FTP<span class="jill"></span>的方式并不适合)，显然不经济。必须提供识别分层传输的机制，以层的<span class="jill"></span>UUID<span class="jill"></span>为标识，确定
传输的对象。</span></li><li><div class="marker"></div><span class="inline-wrap">提供<span class="jill"></span>WEB<span class="jill"></span>界面，优化用户体验 只用镜像的名字来进行上传下载显然很不方便，需要有一个用户界
面可以支持登陆、搜索功能，包括区分公有、私有镜像。</span></li><li><div class="marker"></div><span class="inline-wrap">支持水平扩展集群 当有用户对镜像的上传下载操作集中在某服务器，需要对相应的访问压力作分
解。</span></li><li><div class="marker"></div><span class="inline-wrap">良好的安全机制 企业中的开发团队有很多不同的职位，对于不同的职位人员，分配不同的权限，
具有更好的安全性。</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）先安装<span class="jill"></span>Docker<span class="jill"></span>并启动<span class="jill"></span>Docker（已完成）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">参考之前的安装过程
2）先安装<span class="jill"></span>docker-compose</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> <span class="token function">curl</span> -L https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -s<span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -m<span class="token variable">`</span></span> -o /usr/local/bin/docker-compose  <span class="token comment">#安装</span>
<span class="token comment">#加速版 curl -L "https://get.daocloud.io/docker/compose/releases/download/1.27.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose  
docker-compose --version  <span class="token comment">#查看版本</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）下载<span class="jill"></span>Harbor<span class="jill"></span>的压缩包（本课程版本为：v1.9.2）
</span><span class="inline-wrap"><a href="https://github.com/goharbor/harbor/releases"><span>https://github.com/goharbor/harbor/releases</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）安装开始</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">tar</span> -xzf harbor-offline-installer-v1.9.2.tgz -C /usr/local/
<span class="token builtin class-name">cd</span> /usr/local/harbor

<span class="token function">vim</span> harbor.yml
<span class="token comment">#修改内容1:   hostname: 192.168.87.102</span>
<span class="token comment">#修改内容2:   port: 85</span>
<span class="token comment">#还可以修改登录密码，这里不作配置，下面使用的是默认的密码进行登录</span>

./install.sh
docker-compose up -d <span class="token comment">#启动</span>
<span class="token comment">#docker-compose down -v #停止</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）添加为开机自启
vim /lib/systemd/system/harbor.service</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Shell=" class="marker"></div><pre><span class="token punctuation">[</span><span class="token maybe-class-name">Unit</span><span class="token punctuation">]</span>
<span class="token maybe-class-name">Description</span><span class="token operator">=</span><span class="token maybe-class-name">Harbor</span>
<span class="token maybe-class-name">After</span><span class="token operator">=</span>docker<span class="token punctuation">.</span><span class="token property-access">service</span> systemd<span class="token operator">-</span>networkd<span class="token punctuation">.</span><span class="token property-access">service</span> systemd<span class="token operator">-</span>resolved<span class="token punctuation">.</span><span class="token property-access">service</span>
<span class="token maybe-class-name">Requires</span><span class="token operator">=</span>docker<span class="token punctuation">.</span><span class="token property-access">service</span>
<span class="token maybe-class-name">Documentation</span><span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>vmware<span class="token operator">/</span>harbor

<span class="token punctuation">[</span><span class="token maybe-class-name">Service</span><span class="token punctuation">]</span>
<span class="token maybe-class-name">Type</span><span class="token operator">=</span>simple
<span class="token maybe-class-name">Restart</span><span class="token operator">=</span>on<span class="token operator">-</span>failure
<span class="token maybe-class-name">RestartSec</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token maybe-class-name">ExecStart</span><span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>docker<span class="token operator">-</span>compose <span class="token operator">-</span>f  <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>harbor<span class="token operator">/</span>docker<span class="token operator">-</span>compose<span class="token punctuation">.</span><span class="token property-access">yml</span> up
<span class="token maybe-class-name">ExecStop</span><span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>docker<span class="token operator">-</span>compose <span class="token operator">-</span>f <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>harbor<span class="token operator">/</span>docker<span class="token operator">-</span>compose<span class="token punctuation">.</span><span class="token property-access">yml</span> down

<span class="token punctuation">[</span><span class="token maybe-class-name">Install</span><span class="token punctuation">]</span>
<span class="token maybe-class-name">WantedBy</span><span class="token operator">=</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span><span class="token property-access">target</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">systemctl enable harbor
systemctl is-enabled harbor</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">8）访问<span class="jill"></span>Harbor
</span><span class="inline-wrap"><a href="http://192.168.66.102:85"><span>http://192.168.66.102:85</span></a></span><span class="inline-wrap">
默认账户密码：admin/Harbor12345</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">你可能会遇到的问题：</span><span class="inline-wrap"><a href="https://www.cnblogs.com/hallejuayahaha/p/13926575.html"><span>https://www.cnblogs.com/hallejuayahaha/p/13926575.html</span></a></span><span class="inline-wrap"> （参考）博主遇到了<span class="jill"></span>docker-compose<span class="jill"></span>过低找不到，导致启动报错：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token punctuation">[</span>root@localhost zhuangjie<span class="token punctuation">]</span># docker<span class="token operator">-</span>compose up <span class="token operator">-</span>d #启动
<span class="token constant">ERROR</span><span class="token operator">:</span> 
        <span class="token maybe-class-name">Can</span>'t find a suitable configuration file <span class="token keyword">in</span> <span class="token keyword">this</span> directory or any
        parent<span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Are</span></span> you <span class="token keyword">in</span> the right directory<span class="token operator">?</span>

        <span class="token maybe-class-name">Supported</span> filenames<span class="token operator">:</span> docker<span class="token operator">-</span>compose<span class="token punctuation">.</span><span class="token property-access">yml</span><span class="token punctuation">,</span> docker<span class="token operator">-</span>compose<span class="token punctuation">.</span><span class="token property-access">yaml</span>
        </pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#方法一重启</span>

<span class="token comment">#方法二：</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -s<span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -m<span class="token variable">`</span></span> -o /usr/local/bin/docker-compose
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose
docker-compose --version

./install.sh <span class="token comment">#注意还要cd到Harbor根目录执行</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">【项目与用户】</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">登录后：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）创建私有项目（项目分为公开项目与私有项目）</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627218066729-1627218066687.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）创建用户</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217685972-1627217685963.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）为项目添加成员：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217922413-1627217922383.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 370px"><span class="inline-wrap">角色</span></th><th style="width: 370px"><span class="inline-wrap">权限说明</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">访客</span></td><td><span class="inline-wrap">对于指定项目拥有只读权限</span></td></tr><tr><td><span class="inline-wrap">开发人员</span></td><td><span class="inline-wrap">对于指定项目拥有读写权限</span></td></tr><tr><td><span class="inline-wrap">维护人员</span></td><td><span class="inline-wrap">对于指定项目拥有读写权限，创建 Webhooks</span></td></tr><tr><td><span class="inline-wrap">项目管理员</span></td><td><span class="inline-wrap">除了读写权限，同时拥有用户管理/镜像扫描等管理权限</span></td></tr></tbody></table></div><h4 class="wolai-block"><span class="inline-wrap">1、推送镜像到<span class="jill"></span>Harbor</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）给镜像打上标签</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker tag eureka:v1 <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）推送镜像(会遇到二个问题，请解决)</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">问题<span class="jill"></span>1：需要把<span class="jill"></span>Harbor<span class="jill"></span>地址加入到<span class="jill"></span>Docker<span class="jill"></span>信任列表,不解决，推送会提示：</span><span class="inline-wrap">
</span><span class="inline-wrap">vi /etc/docker/daemon.json</span><span class="inline-wrap">
</span><span class="inline-wrap">需要重启<span class="jill"></span>Docker</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token maybe-class-name">The</span> push refers to repository <span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>tensquare<span class="token operator">/</span>eureka<span class="token punctuation">]</span>
<span class="token maybe-class-name">Get</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>v2<span class="token operator">/</span><span class="token operator">:</span> http<span class="token operator">:</span> server gave <span class="token constant">HTTP</span> response to <span class="token constant">HTTPS</span>
client</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">{</span> 
 <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://zydiol88.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
 <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.208.157:85"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">问题<span class="jill"></span>2：权限不足，不解决，推送会提示：“denied: requested access to the resource is denied”</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#docker login -u 用户名 -p 密码 192.168.66.102:85</span>

<span class="token punctuation">[</span>root@localhost 桌面<span class="token punctuation">]</span><span class="token comment"># docker login -u zhuangjie  -p gkmzjaznH21  192.168.87.102:85</span>
Login Succeeded</pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">推送</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker push <span class="token number">192.168</span>.208.157:85/uplog/eureka</pre></div></code-block></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）登录<span class="jill"></span>Harbor<span class="jill"></span>查看</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627219857216-1627219857185.png" style="width: 760px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">2、拉取镜像从<span class="jill"></span>Harbor</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">存在<span class="jill"></span>Docker<span class="jill"></span>后，我们做以下准备，这样才能确保我们能从<span class="jill"></span>Harbor<span class="jill"></span>中拉取镜像：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">需要把<span class="jill"></span>Harbor<span class="jill"></span>地址加入到<span class="jill"></span>Docker<span class="jill"></span>信任列表,不解决，推送会提示：</span><span class="inline-wrap">
</span><span class="inline-wrap">vi /etc/docker/daemon.json</span><span class="inline-wrap">
</span><span class="inline-wrap">需要重启<span class="jill"></span>Docker</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token maybe-class-name">The</span> push refers to repository <span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>tensquare<span class="token operator">/</span>eureka<span class="token punctuation">]</span>
<span class="token maybe-class-name">Get</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>v2<span class="token operator">/</span><span class="token operator">:</span> http<span class="token operator">:</span> server gave <span class="token constant">HTTP</span> response to <span class="token constant">HTTPS</span>
client</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">{</span> 
 <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://zydiol88.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
 <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.208.157:85"</span><span class="token punctuation">]</span>  
<span class="token punctuation">}</span></pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">准备拉取</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker login -u zhuangjie -p zhuangJIE3333 <span class="token number">192.168</span>.208.157:85  <span class="token comment">#登录</span>
docker pull <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1  <span class="token comment">#拉取，该拉取命令直接从Harbor上一键复制</span>
docker images  <span class="token comment">#查看本地镜像</span></pre></div></code-block></li></ol><h2 class="wolai-block"><span class="inline-wrap">【Web<span class="jill"></span>服务器 192.168.87.103】</span></h2><h4 class="wolai-block"><span class="inline-wrap">1、应用部署</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">分布式应用部署，我们需要再加入一台<span class="jill"></span>web<span class="jill"></span>服务器：
环境初始化：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>systemctl enable sshd <span class="token operator">&amp;&amp;</span> sudo systemctl start sshd

firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>add<span class="token operator">-</span>service<span class="token operator">=</span>ssh <span class="token operator">--</span>permanent
firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>add<span class="token operator">-</span>service<span class="token operator">=</span>http <span class="token operator">--</span>permanent
firewall<span class="token operator">-</span>cmd <span class="token operator">--</span>reload</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">环境：必须安装<span class="jill"></span>jdk, docker（然后将<span class="jill"></span>harbor<span class="jill"></span>加入信任列表：），</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">vi /etc/docker/daemon.json</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token punctuation">{</span>
 <span class="token string">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"https://zydiol88.mirror.aliyuncs.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token string">"insecure-registries"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.87.102:85"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">sudo systemctl restart docker   #重启
systemctl status docker  #查看<span class="jill"></span>docker<span class="jill"></span>状态</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">jenkins<span class="jill"></span>安装 “Publish over SSH” 插件，现在的问题是如何通过<span class="jill"></span>ssh<span class="jill"></span>控制一<span class="jill"></span>web<span class="jill"></span>服务器了。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）需要在<span class="jill"></span>jenkins<span class="jill"></span>服务器中执行  ssh-copy-id 192.168.87.104 到新的<span class="jill"></span>web<span class="jill"></span>的服务器，然后再到<span class="jill"></span>jenkins<span class="jill"></span>配置一下，就可以使用这个<span class="jill"></span>web<span class="jill"></span>服务器进行部署了</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）在<span class="jill"></span>jenkins 的”全局配置“中配置&quot;Publish over SSH&quot; 的内容。怎么配置？</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">【Passphrse】密码，好像没有设置，如果设置了，需要填写。
【Path to key】key<span class="jill"></span>文件的路径（私钥）/root/.ssh/id_rsa
【Key】为空，也 可以测试成功**。注意如果 “/root/.ssh/id_rsa” 文件找不到需要将.ssh<span class="jill"></span>的私钥粘贴到文本框中，至于是<span class="jill"></span>root<span class="jill"></span>还是其它用户，要看使用<span class="jill"></span>copy<span class="jill"></span>命令时用的是哪个用户执行的了。**</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">【SSH Server Name】标识的名字，随便你取什么名字
【Hostname】需要连接<span class="jill"></span>ssh<span class="jill"></span>的主机名或<span class="jill"></span>ip<span class="jill"></span>地址，此处填写应用服务器<span class="jill"></span>IP（建议<span class="jill"></span>ip）
【Username】用户名
【Remote Directory】远程目录(根据需要填写文件传到此目录下)
【Test Configuration】配置完成，点击<span class="jill"></span>test<span class="jill"></span>会显示<span class="jill"></span>Success![]</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093028483-1628093028472.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628083784632-1628083784445.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">完整”Jenkinsfile“:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"da1d1333-c35f-415a-903c-b8d58c870c56"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.100:zhuangjie/tensquare_back.git"</span>

<span class="token comment">//镜像的版本号</span>
def tag <span class="token operator">=</span> <span class="token string">"latest"</span>
<span class="token comment">//Harbor的url地址</span>
def harbor_url <span class="token operator">=</span> <span class="token string">"192.168.87.102:85"</span>
<span class="token comment">//镜像库项目名称</span>
def harbor_project <span class="token operator">=</span> <span class="token string">"uplog"</span>
<span class="token comment">//Harbor的登录凭证ID</span>
def harbor_auth <span class="token operator">=</span> <span class="token string">"ef2651c8-92a7-4edb-b4ca-4e182fadf0ca"</span>

node <span class="token punctuation">{</span>
    <span class="token comment">//获取当前选择的项目名称</span>
    def selectedProjectNames <span class="token operator">=</span> <span class="token string">"${project_name}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
    <span class="token comment">//把选择的服务器信息转为数组</span>
    def selectedServers <span class="token operator">=</span> <span class="token string">"${publish_server}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>int i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>selectedProjectNames<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//tensquare_eureka_server@10086</span>
            def projectInfo <span class="token operator">=</span> selectedProjectNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//当前遍历的项目名称</span>
            def currentProjectName <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment">//当前遍历的项目端口</span>
            def currentProjectPort <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
            <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'SonarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
                cd $<span class="token punctuation">{</span>currentProjectName<span class="token punctuation">}</span>
                $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
              <span class="token string">""</span>"
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程，上传镜像'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>int i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>selectedProjectNames<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//tensquare_eureka_server@10086</span>
            def projectInfo <span class="token operator">=</span> selectedProjectNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//当前遍历的项目名称</span>
            def currentProjectName <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment">//当前遍历的项目端口</span>
            def currentProjectPort <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            sh <span class="token string">"echo '开始制作镜像'"</span>
            sh <span class="token string">"mvn -f ${currentProjectName}  clean package dockerfile:build"</span>
            sh <span class="token string">"echo '镜像制作好了'"</span>
            <span class="token comment">//定义镜像名称</span>
            def imageName <span class="token operator">=</span> <span class="token string">"${currentProjectName}:${tag}"</span>
            <span class="token comment">//对镜像打上标签</span>
            sh <span class="token string">"docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}"</span>
            <span class="token comment">//把镜像推送到Harbor</span>
            <span class="token function">withCredentials</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">usernamePassword</span><span class="token punctuation">(</span>credentialsId<span class="token operator">:</span> <span class="token string">"${harbor_auth}"</span><span class="token punctuation">,</span> passwordVariable<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> usernameVariable<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//登录到Harbor</span>
                    sh <span class="token string">"docker login -u ${username} -p ${password} ${harbor_url}"</span>
                    <span class="token comment">//镜像上传</span>
                    sh <span class="token string">"docker push ${harbor_url}/${harbor_project}/${imageName}"</span>
                    sh <span class="token string">"echo 镜像上传成功"</span>
            <span class="token punctuation">}</span>
           <span class="token comment">//=====以下为远程调用进行项目部署========</span>
           <span class="token keyword control-flow">for</span><span class="token punctuation">(</span>int j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>selectedServers<span class="token punctuation">.</span><span class="token method function property-access">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token comment">//每个服务名称</span>
               def currentServer <span class="token operator">=</span> selectedServers<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
               <span class="token comment">//添加微服务运行时的参数：spring.profiles.active</span>
               def activeProfile <span class="token operator">=</span> <span class="token string">"--spring.profiles.active="</span>
               <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>currentServer<span class="token operator">==</span><span class="token string">"master_server"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    activeProfile <span class="token operator">=</span> activeProfile<span class="token operator">+</span><span class="token string">"eureka-server1"</span>
               <span class="token punctuation">}</span><span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>currentServer<span class="token operator">==</span><span class="token string">"slave_server1"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    activeProfile <span class="token operator">=</span> activeProfile<span class="token operator">+</span><span class="token string">"eureka-server2"</span>
               <span class="token punctuation">}</span>
                sh <span class="token string">"echo '应用部署开始'"</span>
                <span class="token function">sshPublisher</span><span class="token punctuation">(</span>publishers<span class="token operator">:</span> <span class="token punctuation">[</span>
                       <span class="token function">sshPublisherDesc</span><span class="token punctuation">(</span>configName<span class="token operator">:</span> <span class="token string">"${currentServer}"</span><span class="token punctuation">,</span>
                       transfers<span class="token operator">:</span> <span class="token punctuation">[</span>
                           <span class="token function">sshTransfer</span><span class="token punctuation">(</span>cleanRemote<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           excludes<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                           <span class="token comment">// 触发的命令，deploy.sh</span>
                           execCommand<span class="token operator">:</span> <span class="token string">"/opt/jenkins_shell/deployCluster.sh $harbor_url $harbor_project $currentProjectName $tag $currentProjectPort"</span><span class="token punctuation">,</span>
                           execTimeout<span class="token operator">:</span> <span class="token number">120000</span><span class="token punctuation">,</span>
                           flatten<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           makeEmptyDirs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           noDefaultExcludes<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           patternSeparator<span class="token operator">:</span> <span class="token string">'[ , ]+'</span><span class="token punctuation">,</span>
                           remoteDirectory<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                           remoteDirectorySDF<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           removePrefix<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                           sourceFiles<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
                       <span class="token punctuation">]</span><span class="token punctuation">,</span>
                       usePromotionTimestamp<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                       useWorkspaceInPromotion<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                       verbose<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span>
                sh <span class="token string">"echo '应用部署结束'"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）在两个生产服务器中 &quot;/opt/jenkins_shell&quot; 目录下加入 &quot;deployCluster.sh&quot; 脚本，并授予执行权限；</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648361824-1628648361791-image-20210811001811353.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">deployCluster.sh</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token shebang important">#! /bin/sh</span>
<span class="token comment">#接收外部参数</span>
<span class="token assign-left variable">harbor_url</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">harbor_project_name</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">project_name</span><span class="token operator">=</span><span class="token variable">$3</span>
<span class="token assign-left variable">tag</span><span class="token operator">=</span><span class="token variable">$4</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$5</span>
<span class="token assign-left variable">profile</span><span class="token operator">=</span><span class="token variable">$6</span>

<span class="token assign-left variable">imageName</span><span class="token operator">=</span><span class="token variable">$harbor_url</span>/<span class="token variable">$harbor_project_name</span>/<span class="token variable">$project_name</span><span class="token builtin class-name">:</span><span class="token variable">$tag</span>

<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$imageName</span>"</span>

<span class="token comment">#查询容器是否存在，存在则删除</span>
<span class="token assign-left variable">containerId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>docker <span class="token function">ps</span> -a <span class="token operator">|</span> <span class="token function">grep</span> -w $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>:$<span class="token punctuation">{</span>tag<span class="token punctuation">}</span>  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$containerId</span>"</span> <span class="token operator">!=</span>  <span class="token string">""</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token comment">#停掉容器</span>
    docker stop <span class="token variable">$containerId</span>

    <span class="token comment">#删除容器</span>
    docker <span class="token function">rm</span> <span class="token variable">$containerId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">"成功删除容器"</span>
<span class="token keyword">fi</span>

<span class="token comment">#查询镜像是否存在，存在则删除</span>
<span class="token assign-left variable">imageId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>docker images <span class="token operator">|</span> <span class="token function">grep</span> -w $project_name  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $3}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$imageId</span>"</span> <span class="token operator">!=</span>  <span class="token string">""</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
      
    <span class="token comment">#删除镜像</span>
    docker rmi -f <span class="token variable">$imageId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">"成功删除镜像"</span>
<span class="token keyword">fi</span>


<span class="token comment"># 登录Harbor</span>
docker login -u zhuangjie -p gkmzjaznH21 <span class="token variable">$harbor_url</span>

<span class="token comment"># 下载镜像</span>
docker pull <span class="token variable">$imageName</span>

<span class="token comment"># 启动容器</span>
docker run -di -p <span class="token variable">$port</span><span class="token builtin class-name">:</span><span class="token variable">$port</span> <span class="token variable">$imageName</span> <span class="token variable">$profile</span>

<span class="token builtin class-name">echo</span> <span class="token string">"容器启动成功"</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">注意：需要修改 Harbor 登录信息。</span></div></div><h4 class="wolai-block"><span class="inline-wrap">2、高可用的<span class="jill"></span>nginx</span></h4><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628686966488-1628686966378.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）安装<span class="jill"></span>Nginx（已完成）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）配置<span class="jill"></span>nginx</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>upstream zuulServer <span class="token punctuation">{</span>
        server <span class="token number">192.168</span><span class="token number">.87</span><span class="token number">.103</span><span class="token operator">:</span><span class="token number">10020</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        server <span class="token number">192.168</span><span class="token number">.87</span><span class="token number">.104</span><span class="token operator">:</span><span class="token number">10020</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
        listen       <span class="token number">9090</span><span class="token punctuation">;</span>
        listen       <span class="token punctuation">[</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">;</span>
        server_name  _<span class="token punctuation">;</span>
        root         <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>

        # <span class="token maybe-class-name">Load</span> configuration files <span class="token keyword control-flow">for</span> the <span class="token keyword module">default</span> server block<span class="token punctuation">.</span>
        <span class="token property-access">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword module">default</span><span class="token punctuation">.</span><span class="token property-access">d</span><span class="token comment">/*.conf;

        location / {
           proxy_pass http://zuulServer/;
    }
...
</span></pre></div></code-block></article><footer></footer></body></html>