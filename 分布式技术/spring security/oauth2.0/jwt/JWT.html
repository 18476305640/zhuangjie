<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>JWT - wolai 笔记</title><link rel="shortcut icon" href="media/image_proxy_1.svg"></link></head><body><header><div class="image has" style="background-position-y: 50%; background-image: url(&quot;https://cdn.wostatic.cn/cover/2022tiger/nKND5fEPoNHRrBBTZ56Qf6.jpg&quot;)"></div><div class="title"><div class="banner"><div class="icon icon-image" style="background-image: url(&quot;media/image_proxy.svg&quot;)"></div></div><div data-title="JWT" class="main-title"></div></div></header><article><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16468067679271646806767868.png" style="width: 100%"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">1.1 Jwt<span class="jill"></span>结构概述</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Session<span class="jill"></span>与<span class="jill"></span>Token：</b></span></div></div><blockquote class="wolai-block"><span class="inline-wrap">单体应用时，使用<span class="jill"></span>session+cookie<span class="jill"></span>就可以，并且<span class="jill"></span>session<span class="jill"></span>的信息也是可以确认用户的信息的，用户认证成功后，在服务端生成用户相关的数据保存在<span class="jill"></span>session(当前会话)，而发
给客户端的 sesssion_id 存放到 cookie 中，这样用客户端请求时带上 session_id 就可以验证服务器端是否存在<span class="jill"></span>session 数据，以此完成用户的合法校验。当用户退出系统或<span class="jill"></span>session<span class="jill"></span>过期销毁时,客户端的<span class="jill"></span>session_id<span class="jill"></span>也就无效了 ，</span><span class="inline-wrap"><a href="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16468913969251646891396134.png"><span>更多&gt;&gt;</span></a></span><span class="inline-wrap"> 。但如果是分布式场景时，此时就会存在问题了，多个服务之间，session<span class="jill"></span>是不同步的，为解决这个问题我们就有了&quot;session<span class="jill"></span>黏贴&quot;，但这缺点很明显，当我们该服务宕机时，那么前端是无法获取请求了，还有在不同微服务间还是不适用的。这个问题仍然存在，然后又有了&quot;session<span class="jill"></span>复制&quot;，但当我们访问很快时，服务器复制还没完成时，那么当我们访问了没有<span class="jill"></span>session<span class="jill"></span>时，就会让我们重新登录了。这又是一个问题。从而又引出了&quot;session<span class="jill"></span>的集中存储&quot;，可以使用<span class="jill"></span>Redis<span class="jill"></span>进行存储，但美中不足的是<span class="jill"></span>session<span class="jill"></span>是放在服务端的，当我们并发访问过多时，有可能出现问题。从而引出了<span class="jill"></span>token<span class="jill"></span>的方式，这是一种无状态的。token<span class="jill"></span>存储在客户端<span class="jill"></span>cookie<span class="jill"></span>时。</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>JWT<span class="jill"></span>令牌：</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Jwt<span class="jill"></span>令牌可以存储用户的信息，可以让服务知道是哪个用户的访问。如果是普通的令牌，它只是一串无意义的令牌 ，那么服务是不知道访问的用户的，服务还需要进行请求来获取用户的信息。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>具体结构：</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">JWT<span class="jill"></span>分为三部分，分别是<span class="jill"></span>Header（头部）、Payload（负载）、Signature（签名）。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16468066799781646806679905.png" style="width: 100%"/></figure></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Header 部分是一个 JSON 对象，描述 JWT 的元数据，通常是下面的样子。</span><span class="inline-wrap"><code>alt</code></span><span class="inline-wrap"> 是最后加密的签名方式，</span><span class="inline-wrap"><code>typ</code></span><span class="inline-wrap"> 是<span class="jill"></span>JWT,JWT<span class="jill"></span>令牌统一写为&#39;jwt&#39;。</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token punctuation">{</span>
  <span class="token string">"alg"</span><span class="token operator">:</span> <span class="token string">"HS256"</span><span class="token punctuation">,</span>
  <span class="token string">"typ"</span><span class="token operator">:</span> <span class="token string">"JWT"</span>
<span class="token punctuation">}</span></pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Plyload：Payload 部分也是一个 JSON 对象，存放的是能代表用户，注意不要存放私密的信息。用来存放实际需要传递的数据。JWT 规定了<span class="jill"></span>7<span class="jill"></span>个官方字段，供选用。</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token function">iss</span> <span class="token punctuation">(</span>issuer<span class="token punctuation">)</span>：签发人
<span class="token function">exp</span> <span class="token punctuation">(</span>expiration time<span class="token punctuation">)</span>：过期时间
<span class="token function">sub</span> <span class="token punctuation">(</span>subject<span class="token punctuation">)</span>：主题
<span class="token function">aud</span> <span class="token punctuation">(</span>audience<span class="token punctuation">)</span>：受众
<span class="token function">nbf</span> <span class="token punctuation">(</span>Not Before<span class="token punctuation">)</span>：生效时间
<span class="token function">iat</span> <span class="token punctuation">(</span>Issued At<span class="token punctuation">)</span>：签发时间
<span class="token function">jti</span> <span class="token punctuation">(</span>JWT ID<span class="token punctuation">)</span>：编号</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">Plyload<span class="jill"></span>例子：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="JSON" class="marker"></div><pre><span class="token punctuation">{</span>
  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>
  <span class="token property">"admin"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Signature 部分是对前两部分的签名，防止数据篡改。</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">Signature 信息是如何生成的呢？首先需要我们自定义一个密钥(比如&quot;secret&quot;)，用来加密这个数据，</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token function">HMACSHA256</span><span class="token punctuation">(</span>
  <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span><span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"secret"</span><span class="token punctuation">)</span></pre></div></code-block></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">2.1 Jwt<span class="jill"></span>的使用</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">maven<span class="jill"></span>依赖：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="XML" class="marker"></div><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zjazn<span class="token punctuation">.</span>jwt</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> main <span class="token punctuation">{</span>
    <span class="token comment">//加解密使用</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"zjazn"</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">en</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">long</span> time_length <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">12</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">//一天的毫秒数</span>
        <span class="token class-name">JwtBuilder</span> jwtBuilder <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jwtToken <span class="token operator">=</span> jwtBuilder
                <span class="token comment">//header</span>
                <span class="token punctuation">.</span><span class="token function">setHeaderParam</span><span class="token punctuation">(</span><span class="token string">"typ"</span><span class="token punctuation">,</span><span class="token string">"JWT"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHeaderParam</span><span class="token punctuation">(</span><span class="token string">"alg"</span><span class="token punctuation">,</span><span class="token string">"HS256"</span><span class="token punctuation">)</span>
                <span class="token comment">//payload</span>
                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span><span class="token string">"zhuangjie"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">,</span><span class="token string">"admin"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"admin-test"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> time_length<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//signature</span>
                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>HS256<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1、生成的jwtToken:\n"</span><span class="token operator">+</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//去解密</span>
        <span class="token function">parse</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JwtParser</span> jwtParser <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">></span></span> claimsJws <span class="token operator">=</span> jwtParser<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Claims</span> body <span class="token operator">=</span> claimsJws<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2、解密的内容："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//自定义的</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//jwt内置</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>