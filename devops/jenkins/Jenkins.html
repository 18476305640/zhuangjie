<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../css/wolai.css"/><title>Jenkins - wolai 笔记</title><link rel="shortcut icon" href="media/unnamed (1)_1.jpg"></link></head><body><header><div class="image has" style="background-position-y: 50%; background-image: url(&quot;https://cdn.wostatic.cn/cover/shuimo/7BqJuJitWMY9cWjzN65zQ8.png&quot;)"></div><div class="title"><div class="banner"><div class="icon icon-image" style="background-image: url(&quot;media/unnamed%20(1).jpg&quot;)"></div></div><div data-title="Jenkins" class="main-title"></div></div></header><article><h2 class="wolai-block"><span class="inline-wrap">【环境的安装】</span></h2><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626248340612-1626248340557.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：创建<span class="jill"></span>Gitlab<span class="jill"></span>服务器与配置-&gt; 创建<span class="jill"></span>Jenkins<span class="jill"></span>服务与配置</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面两个步骤请参考：</span><span class="inline-wrap"><a href="https://blog.csdn.net/hancoder/article/details/118233786"><span>https://blog.csdn.net/hancoder/article/details/118233786</span></a></span></div></div><h3 class="wolai-block"><span class="inline-wrap">【GitLab<span class="jill"></span>安装】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Gitlab<span class="jill"></span>安装</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">安装相关依赖</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">yum -y install policycoreutils openssh-server openssh-clients postﬁx</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">启动<span class="jill"></span>ssh<span class="jill"></span>服务&amp;设置为开机启动</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">systemctl enable sshd &amp;&amp; sudo systemctl start sshd</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">设置<span class="jill"></span>postﬁx<span class="jill"></span>开机自启，并启动，postﬁx<span class="jill"></span>支持<span class="jill"></span>gitlab<span class="jill"></span>发信功能</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">systemctl enable postﬁx &amp;&amp; systemctl start postﬁx</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">开放<span class="jill"></span>ssh<span class="jill"></span>以及<span class="jill"></span>http<span class="jill"></span>服务，然后重新加载防火墙列表 ﬁrewall-cmd --add-service=ssh --permanent ﬁrewall-cmd --add-service=http --permanent ﬁrewall-cmd --reload</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">如果关闭防火墙就不需要做以上配置</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">下载<span class="jill"></span>gitlab<span class="jill"></span>包，并且安装在线下载安装包：</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">wget </span><span class="inline-wrap"><a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x"><span>https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x</span></a></span><span class="inline-wrap"> 86_64.rpm</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">安装：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">rpm -i gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">修改<span class="jill"></span>gitlab<span class="jill"></span>配置</span></li></ol><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">vi</span> /etc/gitlab/gitlab.rb
<span class="token comment">#修改gitlab访问地址和端口，默认为80，我们改为82 external_url ‘http://192.168.66.100:82’</span>
<span class="token comment">#nginx[‘listen_port’] = 82</span></pre></div></code-block><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">重载配置及启动<span class="jill"></span>gitlab</span></li></ol><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>gitlab-ctl reconﬁgure
gitlab-ctl restart</pre></div></code-block><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">把端口添加到防火墙</span></li></ol><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>ﬁrewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">82</span>/tcp --permanent 
ﬁrewall-cmd --reload</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">启动成功后，看到以下修改管理员<span class="jill"></span>root<span class="jill"></span>密码的页面，修改密码后，然后登录即可</span></div></div><h3 class="wolai-block"><span class="inline-wrap">【Jenkins<span class="jill"></span>安装】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">这里介绍两种方法，一种方法将最新版<span class="jill"></span>jenkins<span class="jill"></span>加入到<span class="jill"></span>yum<span class="jill"></span>源，另外一种是下载指定版本的<span class="jill"></span>rpm<span class="jill"></span>包</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）安装<span class="jill"></span>JDK</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）安装<span class="jill"></span>jenkins</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">wget -O ：下载并以不同的文件名保存</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">yum<span class="jill"></span>的<span class="jill"></span>repo<span class="jill"></span>中默认没有<span class="jill"></span>Jenkins，需要先将<span class="jill"></span>Jenkins<span class="jill"></span>存储库添加到<span class="jill"></span>yum repos，执行下面的命令：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">wget</span> -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
<span class="token function">rpm</span> --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
yum <span class="token function">install</span> -y jenkins <span class="token comment">#默认安装最新的</span>
systemctl <span class="token builtin class-name">enable</span> jenkins  <span class="token comment">#开机自启</span>
<span class="token function">vim</span> /etc/sysconfig/jenkins   <span class="token comment">#修改内容： JENKINS_USER=“root” JENKINS_PORT=“8888”</span>
<span class="token function">service</span> jenkins start  <span class="token comment">#启动</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">打开浏览器访问 </span><span class="inline-wrap"><a href="http://电脑ip:8888"><span>http://电脑<span class="jill"></span>ip:8888</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个管理员用户 -&gt;  实例配置  -&gt; 可以安装推荐的插件或另一种。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）配置为国内插件下载地址：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>cd <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>jenkins<span class="token operator">/</span>updates
sed <span class="token operator">-</span>i <span class="token string">'s/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g'</span> <span class="token keyword module">default</span><span class="token punctuation">.</span><span class="token property-access">json</span>
sed <span class="token operator">-</span>i <span class="token string">'s/http:\/\/www.google.com/https:\/\/www.baidu.com/g'</span> <span class="token keyword module">default</span><span class="token punctuation">.</span><span class="token property-access">json</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">Manage Plugins<span class="jill"></span>点击<span class="jill"></span>Advanced，把<span class="jill"></span>Update Site<span class="jill"></span>改为国内插件下载地址：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json"><span>https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Sumbit<span class="jill"></span>后，在浏览器输入： </span><span class="inline-wrap"><a href="http://101机器ip:8888/restart"><span>http://101<span class="jill"></span>机器<span class="jill"></span>ip:8888/restart</span></a></span><span class="inline-wrap"> ，重启<span class="jill"></span>Jenkins</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627721279406-1627721279398.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）安装中文插件</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">安装插件的插件后，会帮我们安装中文插件，如果没有搜索&quot;Chinese&quot;，安装</span></div></div><h2 class="wolai-block"><span class="inline-wrap">从<span class="jill"></span>gitlab<span class="jill"></span>上拉取代码</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：使用普通凭证从<span class="jill"></span>gitlab<span class="jill"></span>上拉取代码 -&gt;  使用<span class="jill"></span>ssh<span class="jill"></span>凭证从<span class="jill"></span>gitlab<span class="jill"></span>上拉取代码</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>实现在<span class="jill"></span>Jenkins<span class="jill"></span>上拉取<span class="jill"></span>Gitlab<span class="jill"></span>上的代码</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>Kenkins<span class="jill"></span>上安装<span class="jill"></span>Credentials Binding ,安装 Git<span class="jill"></span>插件 、在<span class="jill"></span>Kenkins<span class="jill"></span>服务器上安装<span class="jill"></span>git (yum install git -y  &amp;&amp; git --version)</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、创建普通凭证</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626250522291-1626250522234.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、创建一个项目，从<span class="jill"></span>gitlab<span class="jill"></span>上拉取代码</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251037486-1626251037450-image-20210714162315906.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3、拉取</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251148690-1626251148679.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>使用<span class="jill"></span>ssh<span class="jill"></span>凭证来拉取</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、使用<span class="jill"></span>ssh-keygen<span class="jill"></span>生成<span class="jill"></span>ssh，打开/root/.ssh/下<span class="jill"></span>cat<span class="jill"></span>公钥  复制到<span class="jill"></span>gitlab<span class="jill"></span>设置中的<span class="jill"></span>ssh：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251665628-1626251665529.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、配置<span class="jill"></span>ssh<span class="jill"></span>凭证</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626252147796-1626252147756-image-20210714164202919.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3、在<span class="jill"></span>Jenkins<span class="jill"></span>项目中</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626252294465-1626252294427.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">4、拉取</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626251148690-1626251148679.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">加入<span class="jill"></span>Maven<span class="jill"></span>进行自动构建打包</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">就是可以在<span class="jill"></span>Jenkins<span class="jill"></span>对拉取的代码进行打包</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626258766265-1626258766237.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：服务器上配置需要的环境   --&gt;  Jenkins<span class="jill"></span>上配置 --&gt;  对项目进行打包</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、在<span class="jill"></span>jenkins<span class="jill"></span>的服务器上安装<span class="jill"></span>java 、 maven<span class="jill"></span>配置环境；</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/local/jdk/jdk1.8.0_291
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JAVA_HOME</span>/jre/bin:<span class="token environment constant">$PATH</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/lib:<span class="token variable">$JAVA_HOME</span>/jre/lib

<span class="token comment">#maven</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MAVEN_HOME</span><span class="token operator">=</span>/usr/local/maven
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$MAVEN_HOME</span>/bin</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、Jenkins<span class="jill"></span>上配置</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>1：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259189981-1626259189950.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259391664-1626259391644.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>2：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627725746059-1627725746011.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3、对项目进行打包</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626259620762-1626259620743.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【Web<span class="jill"></span>服务器】项目部署服务器的创建与配置</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">就是创建项目运行所需的环境，即安装有<span class="jill"></span>tomcat<span class="jill"></span>服务器，然后配置<span class="jill"></span>tomcat</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626248340612-1626248340557.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、创建服务器在服务器上安装与配置<span class="jill"></span>tomcat</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">下载</span><span class="inline-wrap"> ：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317633809-1626317633802.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">启动<span class="jill"></span>tomcat:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/usr/local/tomcat/apache-tomcat-8.5.69/bin
<span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># ./startup.sh</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">开放<span class="jill"></span>tomcat<span class="jill"></span>的<span class="jill"></span>8080<span class="jill"></span>端口：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">8080</span>/tcp --permanent  <span class="token comment">#开放8080端口</span>
firewall-cmd --reload  <span class="token comment">#重启防火墙</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">访问服务器的<span class="jill"></span>8080<span class="jill"></span>端口，进入指定页面：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626316981745-1626316981736.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>1（配置了登录信息）:</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">vim  /usr/local/tomcat/apache-tomcat-8.5.69/conf/tomcat-users.xml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Xml" class="marker"></div><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tomcat-users</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tomcat<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>role1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manager-script<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manager-gui<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manager-status<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>admin-gui<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>role</span> <span class="token attr-name">rolename</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>admin-script<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">username</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tomcat<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tomcat<span class="token punctuation">"</span></span> <span class="token attr-name">roles</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manager-gui,manager-script,tomcat,admin-gui,admin-script<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tomcat-users</span><span class="token punctuation">></span></span></pre></div></code-block><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317427813-1626317427807.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配置<span class="jill"></span>2：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">vim   /usr/local/tomcat/apache-tomcat-8.5.69/webapps/manager/META-INF/context.xml</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317357259-1626317357234.png" style="width: 752px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">重启</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>./shutdown.sh <span class="token comment">#停止</span>
./startup.sh <span class="token comment">#启动</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">再次访问或刷新刚才的<span class="jill"></span>403<span class="jill"></span>页面（上面配置了登录信息是：tomcat  tomcat）：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317528836-1626317528820.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">显示：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626317555591-1626317555588.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【构建】实现自由风格的项目构建</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">就是<span class="jill"></span>jenkins<span class="jill"></span>服务器向<span class="jill"></span>gitlab<span class="jill"></span>服务器获取代码后进行构建，然后将构建好生成的<span class="jill"></span>war<span class="jill"></span>包部署到<span class="jill"></span>tomcat<span class="jill"></span>服务器上。我们要做的是设置构建过程。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：gitlab<span class="jill"></span>服务器项目的准备 -&gt;  jenkins<span class="jill"></span>构建环境的准备  -&gt; 开始构建部署</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>1、gitlab<span class="jill"></span>服务器项目的准备</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">项目准备：</span><span class="inline-wrap"><a href="https://github.com/18476305640/web_dome"><span>https://github.com/18476305640/web_dome</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>gitlab<span class="jill"></span>上创建一个项目，提交上传，得到：</span><span class="inline-wrap"><a href="mailto:git@192.168.208.136"><span>git@192.168.208.136</span></a></span><span class="inline-wrap">:zhuangjie/web_demo_freestyle.git</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>2、jenkins<span class="jill"></span>构建环境的准备</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	1）安装插件</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626409798823-1626409798816.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	2）源码管理</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626410689844-1626410689829.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	3）构建</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626409915126-1626409915107.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	4）构建后操作（新内容）</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626410192277-1626410192254-image-20210716123603979.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	</span><span class="inline-wrap"><b>3、开始构建</b></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626410540606-1626410540586.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">改动后持续集成</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">我们能实现三个服务器的联动工作后，我们日常只需要使用<span class="jill"></span>git push 将代码上传到<span class="jill"></span>gitlab<span class="jill"></span>上，然后在<span class="jill"></span>jenkins<span class="jill"></span>中进行构建即可。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">【构建】使用<span class="jill"></span>Maven<span class="jill"></span>进行项目构建</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面我们使用的是自由风格进行了项目构建，现在我们要进行<span class="jill"></span>maven<span class="jill"></span>风格来进行项目构建，与之不同的地方并不多。下面就来演示一下：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：安装插件  -&gt;  构建项目  -&gt; 查看</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>1、安装插件</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Maven Integration<span class="jill"></span>插件，不用重启也可用。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>2、构建项目</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626417502304-1626417502240.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">部署：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">修改代码，push<span class="jill"></span>后，点击构建项目</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626417981588-1626417981549.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>3、查看</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626418094970-1626418094944.png" style="width: 668.6666666666666px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【构建】使用流水线进行项目构建</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">流水线构建项目，构建项目由之前的流程式转为了脚本（Pipeline）,我们创建一个流水线项目后，我们只需编写/生成一个<span class="jill"></span>Pipeline 即可完成对项目的拉取、构建、部署等操作。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：安装插件（Pipeline，安装推荐的插件中包含）  -&gt; 进行项目构建脚本（Pipeline）书写  -&gt;  查看</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>1、安装插件</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626419582840-1626419582796.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、创建一个流水线的项目</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626425094651-1626425094634.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3、编写/生成 Pipeline<span class="jill"></span>脚本实现项目的拉取、构建、部署</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626425126026-1626425126010.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">来自：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626424995322-1626424995301.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">改为项目本地：</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、在流水线项目上修改：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626426369402-1626426369370.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、项目中，添加一个文件：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626426478007-1626426477966.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【触发】项目构建触发器</span></h2><h3 class="wolai-block"><span class="inline-wrap">1、触发远程构建</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626459590220-1626459590214.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">2、其它工程构建后触发</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626459881414-1626459881392.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">3、定时构建</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626489980663-1626489980633.png" style="width: 760px"/></figure></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>每<span class="token number">30</span>分钟构建一次：<span class="token constant">H</span>代表形参 <span class="token constant">H</span><span class="token operator">/</span><span class="token number">30</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">02</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">32</span>

每<span class="token number">2</span>个小时构建一次<span class="token operator">:</span> <span class="token constant">H</span> <span class="token constant">H</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span>

<span class="token function">每天的8点，12点，22点，一天构建3次：</span> <span class="token punctuation">(</span>多个时间点中间用逗号隔开<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">22</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span>

每天中午<span class="token number">12</span>点定时构建一次 <span class="token constant">H</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span>

每天下午<span class="token number">18</span>点定时构建一次 <span class="token constant">H</span> <span class="token number">18</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span>

在每个小时的前半个小时内的每<span class="token number">10</span>分钟 <span class="token constant">H</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span>

<span class="token function">每两小时一次，每个工作日上午9点到下午5点</span><span class="token punctuation">(</span>也许是上午<span class="token number">10</span><span class="token operator">:</span><span class="token number">38</span>，下午<span class="token number">12</span><span class="token operator">:</span><span class="token number">38</span>，下午<span class="token number">2</span><span class="token operator">:</span><span class="token number">38</span>，下午<span class="token number">4</span><span class="token operator">:</span><span class="token number">38</span><span class="token punctuation">)</span> <span class="token constant">H</span> <span class="token constant">H</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">4、轮询 SCM</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626490561413-1626490561372.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">5、代码仓库触发构建</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">前面的几种构建触发器都不够好，就算是轮询<span class="jill"></span>SCM<span class="jill"></span>也会消耗我们的系统资源，拖慢<span class="jill"></span>jenkins<span class="jill"></span>的运行速度。下面我们就演示如果让<span class="jill"></span>gitlab<span class="jill"></span>来触发<span class="jill"></span>jenkins<span class="jill"></span>的项目构建。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493715277-1626493715263.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">需要安装<span class="jill"></span>GitlabHook<span class="jill"></span>插件：需要安装两个插件： Gitlab Hook<span class="jill"></span>和<span class="jill"></span>GitLab</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	1）项目触发器（复制下面图片首行的那个链接，备用）</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626492610080-1626492610030.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	2）在<span class="jill"></span>Jenkins<span class="jill"></span>中，Manage Jenkins-&gt;Conﬁgure System</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">不取消勾选，jenkins<span class="jill"></span>将不能正常接收<span class="jill"></span>gitlab<span class="jill"></span>发送的触发信息。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626492754499-1626492754469-382093cee2597d9990ee111babc36b21.jpg" style="width: 759.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）gitlab：使用<span class="jill"></span>root<span class="jill"></span>管理员帐号登录，开启对应服务</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493399071-1626493399029.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）使用项目账号登录，进入项目</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493574213-1626493574200.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">进行如下 测试，回到<span class="jill"></span>jenkins<span class="jill"></span>发现触发了项目构建！</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626493633032-1626493633021.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【副加】参数化构建</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、jenkins<span class="jill"></span>项目中设置参数</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626510691515-1626510691500.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、在<span class="jill"></span>pipelish<span class="jill"></span>脚本中使用该参数</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626510755563-1626510755554.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3、执行参数化构建项目 （已测试）</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626510632687-1626510632683.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【邮箱】邮箱功能</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：邮箱服务开启  -&gt;   jenkins<span class="jill"></span>配置</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>邮箱服务开启  </code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626516270004-1626516269977.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">比如得到的授权码：CAPOTZETCGUFSOVC</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>jenkins<span class="jill"></span>配置</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">安装插件：Email Extension<span class="jill"></span>插件 template</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626515704616-1626515704587.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626516328030-1626516328027.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626516132502-1626516132500.png" style="width: 760px"/></figure></div><blockquote class="wolai-block"><span class="inline-wrap">配置好上面后，现在我们开始应用到项目中。</span><span class="inline-wrap">
</span><span class="inline-wrap">现在流程是这样的，现在我们在<span class="jill"></span>jenkins<span class="jill"></span>项目中，该项目是一个流水线<span class="jill"></span>+<span class="jill"></span>参数化的构建项目，在<span class="jill"></span>jenkins<span class="jill"></span>中需要设置拉取构建流程的&quot;jenkinsfile&quot; 的<span class="jill"></span>pipelish<span class="jill"></span>脚本文件。它可以不是项目本身：</span><span class="inline-wrap">
</span></blockquote><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626699189512-1626699189503.png" style="width: 760px"/></figure></div><blockquote class="wolai-block"><span class="inline-wrap">具体的项目构建由该脚本决定的<span class="jill"></span>~</span></blockquote><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre>pipeline <span class="token punctuation">{</span>
   agent any

   stages <span class="token punctuation">{</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'pull code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">'*/${branch}'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">'b632ed00-fc81-43c8-a746-5aa0673b2658'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'git@192.168.208.149:zhuangjie/web_demo_freestyle.git'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'build project'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            sh <span class="token string">'mvn clean package'</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'publish project'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            deploy adapters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tomcat8</span><span class="token punctuation">(</span>credentialsId<span class="token operator">:</span> <span class="token string">'54dea36f-c9ed-4925-9d25-ea4ba77d7b78'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://192.168.208.151:8080'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> contextPath<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> war<span class="token operator">:</span> <span class="token string">'target/*.war'</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
   post <span class="token punctuation">{</span>
         always <span class="token punctuation">{</span>
             <span class="token function">emailext</span><span class="token punctuation">(</span>
                 subject<span class="token operator">:</span> <span class="token string">'构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} -${BUILD_STATUS}!'</span><span class="token punctuation">,</span>
                 body<span class="token operator">:</span> <span class="token string">'${FILE,path="email.html"}'</span><span class="token punctuation">,</span>
                 <span class="token keyword">to</span><span class="token operator">:</span> <span class="token string">'2119299531@qq.com'</span>
             <span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">分析：pipeline  {stages...   post... }  其中<span class="jill"></span>stages<span class="jill"></span>是构建流程，</span><span class="inline-wrap"><code>post</code></span><span class="inline-wrap">是构建成功后的操作。我们在此下的<span class="jill"></span>always（不管成功或失败，当然也可以是成功或失败）中发送邮件。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">该脚本使用了以下作为邮件模板，位于项目的根目录下：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626699623460-1626699623452.png" style="width: 386px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">email.html</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Html" class="marker"></div><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>${ENV, var="JOB_NAME"}-第${BUILD_NUMBER}次构建日志<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">leftmargin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span> <span class="token attr-name">marginwidth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">topmargin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span> <span class="token attr-name">marginheight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span>
      <span class="token attr-name">offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>95%<span class="token punctuation">"</span></span> <span class="token attr-name">cellpadding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">cellspacing</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
       <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token unit">pt</span><span class="token punctuation">;</span> <span class="token property">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> sans-serif</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>(本邮件是程序自动下发的，请勿回复！)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#0000FF<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>构建结果 - ${BUILD_STATUS}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#0B610B<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>构建信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>项目名称<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>${PROJECT_NAME}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>构建编号<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>第${BUILD_NUMBER}次构建<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>触发原因：<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>${CAUSE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>构建日志：<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${BUILD_URL}console<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>${BUILD_URL}console<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>构建<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>Url<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${BUILD_URL}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>${BUILD_URL}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>工作目录<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${PROJECT_URL}ws<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>${PROJECT_URL}ws<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>项目<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>Url<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>：<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${PROJECT_URL}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>${PROJECT_URL}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#0B610B<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Changes Since Last
      Successful Build:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>历史变更记录 : <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${PROJECT_URL}changes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>${PROJECT_URL}changes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span> ${CHANGES_SINCE_LAST_SUCCESS,reverse=true, format="Changes for Build #%n:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>%c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>",showPaths=true,changesFormat="<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">></span></span>[%a]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span>%m<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span>",pathFormat="<span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span><span class="token entity named-entity" title="&nbsp;">&amp;nbsp;</span>%p"}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span>Failed Test Results<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span>
            <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token unit">pt</span><span class="token punctuation">;</span> <span class="token property">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> sans-serif</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>$FAILED_TESTS<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font</span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#0B610B<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>构建日志 (最后 100行):<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100%<span class="token punctuation">"</span></span> <span class="token attr-name">align</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>80<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>readonly<span class="token punctuation">"</span></span>
                  <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-family</span><span class="token punctuation">:</span> Courier New</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>${BUILD_LOG, maxLines=100}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">除此，还需要设置邮箱这<span class="jill"></span>html<span class="jill"></span>格式进行发送：（在这下面搜索<span class="jill"></span>html,好像没有，但教程是这样的）</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626704078478-1626704078470-image-20210719221412626.png" style="width: 705px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【Sonar<span class="jill"></span>代码审查】</span></h2><h3 class="wolai-block"><span class="inline-wrap">安装</span></h3><blockquote class="wolai-block"><span class="inline-wrap"><b>注意，sonar6.7<span class="jill"></span>版本需要一个<span class="jill"></span>mysql5.7<span class="jill"></span>的数据库，jdk1.8<span class="jill"></span>以上比如<span class="jill"></span>8.5</b></span><span class="inline-wrap"> ，然后再创建一个名为</span><span class="inline-wrap"><code>sonar</code></span><span class="inline-wrap"> 的数据库。然后再开始安装<span class="jill"></span>Sonar，启动后再开放端口且登录获取<span class="jill"></span>token ：</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：保证存在名为<span class="jill"></span>sonar<span class="jill"></span>的数据库 -&gt;  安装<span class="jill"></span>Conar  -&gt; 余下工作</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>保证存在名为<span class="jill"></span>sonar<span class="jill"></span>的数据库</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>安装<span class="jill"></span>Conar</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">下载<span class="jill"></span>sonar<span class="jill"></span>压缩包： </span><span class="inline-wrap"><a href="https://www.sonarqube.org/downloads/"><span>https://www.sonarqube.org/downloads/</span></a></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum <span class="token function">install</span> <span class="token function">unzip</span>
<span class="token function">unzip</span> sonarqube-6.7.4.zip <span class="token comment">#解压</span>
<span class="token function">mkdir</span> /opt/sonar <span class="token comment">#创建目录</span>
<span class="token function">mv</span> sonarqube-6.7.4/* /opt/sonar <span class="token comment">#移动文件</span>

<span class="token function">useradd</span> sonar <span class="token comment">#创建sonar用户，必须sonar用于启动，否则报错</span>
<span class="token function">chown</span> -R sonar. /opt/sonar <span class="token comment">#更改sonar目录及文件权限修改sonar配置文件</span>
<span class="token function">chown</span> -R sonar. /usr/local/jdk/  <span class="token comment">#不确定是否需要这个授权！！！</span>
<span class="token function">vi</span>  /opt/sonarqube-6.7.4/conf/sonar.properties
<span class="token comment">#编辑内容：四个地方设置username  passowrd  url  端口（不理默认9000）</span>

sonar.jdbc.username<span class="token operator">=</span>root
sonar.jdbc.password<span class="token operator">=</span>Root@123  
sonar.jdbc.url<span class="token operator">=</span>jdbc:mysql://localhost:3306/sonar?useUnicode<span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">characterEncoding</span><span class="token operator">=</span>utf8<span class="token operator">&amp;</span><span class="token assign-left variable">rewriteBatchedStatements</span><span class="token operator">=</span>true<span class="token operator">&amp;</span>useConﬁgs<span class="token operator">=</span> maxPerformance<span class="token operator">&amp;</span><span class="token assign-left variable">useSSL</span><span class="token operator">=</span>false

<span class="token builtin class-name">cd</span> /opt/sonarqube-6.7.4

<span class="token comment">#su sonar 不能使用root用户启动！！！所以下面在root用户下使用如下使用启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh start <span class="token comment">#启动</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh status <span class="token comment">#查看状态</span>
<span class="token function">su</span> sonar ./bin/linux-x86-64/sonar.sh stop <span class="token comment">#停止</span>

<span class="token function">tail</span> -f logs/sonar.logs <span class="token comment">#查看日志访问sonar http://192.168.66.101:9000</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>余下工作</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1)开放端口：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>firewall-cmd --zone<span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">9000</span>/tcp --permanent <span class="token comment">#永久开放该端口</span>
firewall-cmd --reload  <span class="token comment">#重启防火墙</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2)登录：默认  admin/admin</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	获取<span class="jill"></span>token:</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	输入<span class="jill"></span>admin , 得到如下信息,需要摘取保存<span class="jill"></span>token</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	admin: </span><span class="inline-wrap"><b>30ab099e4edef87ef92ca6217da084c0260de47c</b></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626709303395-1626709303372.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">Sonar<span class="jill"></span>与<span class="jill"></span>Jenkins<span class="jill"></span>整合</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925229389-1626925229368.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1、在<span class="jill"></span>Jenkins<span class="jill"></span>安装<span class="jill"></span>Sonar-Scanner<span class="jill"></span>工具</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925200244-1626925200242-image-20210720211841704.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2、整合</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	1)在<span class="jill"></span>Jenkins<span class="jill"></span>中安装<span class="jill"></span>SonarQube Scanner<span class="jill"></span>插件，用于连接<span class="jill"></span>ConarQube</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	2)、Manage Jenkins-&gt;Global Tool Conﬁguration  添加一个凭证</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925096630-1626925096623-image-20210720211228770.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">​	3)在<span class="jill"></span>jenkins“系统配置”中，作如下配置</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925064354-1626925064346-image-20210720211416805.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">应用到项目构建中</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>JAVA_HOME<span class="jill"></span>等环境变量需要设置好！</b></span><span class="inline-wrap"> 我们应用在流水线的项目构建中，而其它的构建方式会相对简单。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤： 在项目中加入<span class="jill"></span>sonar-project.properties<span class="jill"></span>审查文件  -&gt;  在<span class="jill"></span>pipelish<span class="jill"></span>脚本加入代码审查步骤</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>1、在项目中加入<span class="jill"></span>sonar-project.properties<span class="jill"></span>审查文件</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在根目录下加入：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">sonar-project.properties</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre># must be unique <span class="token keyword">in</span> a given <span class="token maybe-class-name">SonarQube</span> instance
sonar<span class="token punctuation">.</span><span class="token property-access">projectKey</span><span class="token operator">=</span>web_demo_pipline
# <span class="token keyword">this</span> is the name and version displayed <span class="token keyword">in</span> the <span class="token maybe-class-name">SonarQube</span> <span class="token constant">UI</span><span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Was</span></span> mandatory prior to <span class="token maybe-class-name">SonarQube</span> <span class="token number">6.1</span><span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">projectName</span><span class="token operator">=</span>web_demo_pipline
sonar<span class="token punctuation">.</span><span class="token property-access">projectVersion</span><span class="token operator">=</span><span class="token number">1.0</span>

# <span class="token maybe-class-name">Path</span> is relative to the sonar<span class="token operator">-</span>project<span class="token punctuation">.</span><span class="token property-access">properties</span> file<span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Replace</span></span> <span class="token string">"\" by "</span><span class="token operator">/</span>" on <span class="token maybe-class-name">Windows</span><span class="token punctuation">.</span>
# <span class="token maybe-class-name">This</span> property is optional <span class="token keyword control-flow">if</span> sonar<span class="token punctuation">.</span><span class="token property-access">modules</span> is set<span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">sources</span><span class="token operator">=</span><span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">exclusions</span><span class="token operator">=</span><span class="token operator">**</span><span class="token operator">/</span>test<span class="token doc-comment comment">/**,**/</span>target<span class="token doc-comment comment">/**

sonar.java.source=1.8
sonar.java.target=1.8

# Encoding of the source code. Default is default system encoding
sonar.sourceEncoding=UTF-8</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>2、在<span class="jill"></span>pipelish<span class="jill"></span>脚本加入代码审查步骤</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在代码构建打包好后（生成<span class="jill"></span>target<span class="jill"></span>后），进行代码的审查</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>pipeline <span class="token punctuation">{</span>
   agent any

   stages <span class="token punctuation">{</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'pull code'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">'*/${branch}'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">'b632ed00-fc81-43c8-a746-5aa0673b2658'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'git@192.168.208.149:zhuangjie/web_demo_freestyle.git'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'code checking'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          steps <span class="token punctuation">{</span>
              script <span class="token punctuation">{</span>
                   <span class="token comment">//引入SonarQubeScanner工具</span>
                  scannerHome <span class="token operator">=</span> tool <span class="token string">'SonarQube-Scanner'</span>   <span class="token comment">//第二步整合中安装Sonar-Scanner工具起的名字</span>
              <span class="token punctuation">}</span>
              <span class="token comment">//引入SonarQube的服务器环境</span>
              <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//第二步整合中配置进Jenkins中起的服务的名字</span>
                  sh <span class="token string">"${scannerHome}/bin/sonar-scanner"</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'build project'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            sh <span class="token string">'mvn clean package'</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'publish project'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         steps <span class="token punctuation">{</span>
            deploy adapters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tomcat8</span><span class="token punctuation">(</span>credentialsId<span class="token operator">:</span> <span class="token string">'54dea36f-c9ed-4925-9d25-ea4ba77d7b78'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://192.168.208.153:8080'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> contextPath<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span> war<span class="token operator">:</span> <span class="token string">'target/*.war'</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
   post <span class="token punctuation">{</span>
         always <span class="token punctuation">{</span>
             <span class="token function">emailext</span><span class="token punctuation">(</span>
                 subject<span class="token operator">:</span> <span class="token string">'构建通知：${PROJECT_NAME} - Build # ${BUILD_NUMBER} -${BUILD_STATUS}!'</span><span class="token punctuation">,</span>
                 body<span class="token operator">:</span> <span class="token string">'${FILE,path="email.html"}'</span><span class="token punctuation">,</span>
                 to<span class="token operator">:</span> <span class="token string">'2119299531@qq.com'</span>
             <span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后进行代码的构建！首次会进行下载安装<span class="jill"></span>SonarQube Scanner</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">加入异常代码后进行构建，SonarQube<span class="jill"></span>中：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1626925023961-1626925023954-image-20210720223752856.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【分布式项目部署】</span></h2><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627046616524-1627046616423.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">大致流程说明：
1）开发人员每天把代码提交到<span class="jill"></span>Gitlab<span class="jill"></span>代码仓库
2）Jenkins<span class="jill"></span>从<span class="jill"></span>Gitlab<span class="jill"></span>中拉取项目源码，编译并打成<span class="jill"></span>jar<span class="jill"></span>包，然后构建成<span class="jill"></span>Docker<span class="jill"></span>镜像，将镜像上传到
Harbor<span class="jill"></span>私有仓库。
3）Jenkins<span class="jill"></span>发送<span class="jill"></span>SSH<span class="jill"></span>远程命令，让生产部署服务器到<span class="jill"></span>Harbor<span class="jill"></span>私有仓库拉取镜像到本地，然后创建容器。
4）最后，用户可以访问到容器</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">【Docker<span class="jill"></span>环境】</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627046771291-1627046771238.png" style="width: 191.33333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Docker 是一个开源的应用容器引擎，基于 Go 语言 并遵从 Apache2.0 协议开源。
Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流
行的 Linux 机器上，也可以实现虚拟化。
容器是完全使用沙箱机制，相互之间不会有任何接口（类似 iPhone 的 app）,更重要的是容器性能开销
极低。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Docker<span class="jill"></span>容器技术 vs 传统虚拟机技术</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627046966863-1627046966759.png" style="width: 754px"/></figure></div><div class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 246.66666666666666px"><br/></th><th style="width: 246.66666666666666px"><span class="inline-wrap">虚拟机</span></th><th style="width: 246.66666666666666px"><span class="inline-wrap">容器</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">占用磁盘空间</span></td><td><span class="inline-wrap">非常大,GB<span class="jill"></span>级</span></td><td><span class="inline-wrap">小，MB<span class="jill"></span>甚至<span class="jill"></span>KB<span class="jill"></span>级</span></td></tr><tr><td><span class="inline-wrap">启动速度</span></td><td><span class="inline-wrap">慢，分钟级</span></td><td><span class="inline-wrap">快，秒级</span></td></tr><tr><td><span class="inline-wrap">对运行形态</span></td><td><span class="inline-wrap">运行在<span class="jill"></span>Hypervisor<span class="jill"></span>上</span></td><td><span class="inline-wrap">直接运行在宿主机内核上</span></td></tr><tr><td><span class="inline-wrap">并发性</span></td><td><span class="inline-wrap">一台宿主机上十几个，最多几十个</span></td><td><span class="inline-wrap">上百个，甚至数百上千个</span></td></tr><tr><td><span class="inline-wrap">性能</span></td><td><span class="inline-wrap">逊于宿主机</span></td><td><span class="inline-wrap">接近宿主机本地进程</span></td></tr><tr><td><span class="inline-wrap">资源利用率</span></td><td><span class="inline-wrap">低</span></td><td><span class="inline-wrap">高</span></td></tr></tbody></table></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">简单一句话总结：Docker</span><span class="inline-wrap"><b>技术就是让我们更加高效轻松地将任何应用在</b></span><span class="inline-wrap">Linux</span><span class="inline-wrap"><b>服务器部署和使用</b></span></div></div><h3 class="wolai-block"><span class="inline-wrap">【Docker<span class="jill"></span>安装】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）卸载旧版本</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum list installed <span class="token operator">|</span> <span class="token function">grep</span> docker <span class="token comment">#列出当前所有docker的包</span>
yum -y remove docker-*  <span class="token comment">#的包名称 卸载docker包</span>
<span class="token function">rm</span> -rf /var/lib/docker <span class="token comment">#删除docker的所有镜像和容器</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）安装必要的软件包</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils  device-mapper-persistent-data  lvm2</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）设置下载的镜像仓库</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
<span class="token comment">#或使用加速镜像:  yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）列出需要安装的版本列表</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>yum list docker-ce --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -r  </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）安装指定版本（这里使用<span class="jill"></span>18.0.1<span class="jill"></span>版本）</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce-18.06.1.ce</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">6）查看版本&amp;设置开机自启</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker -v
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> docker <span class="token comment">#设置开机启动  </span>
systemctl is-enabled docker  <span class="token comment">#查看是否设置为开机自启</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">7）启动<span class="jill"></span>Docker</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> systemctl start docker <span class="token comment">#启动</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">8）添加阿里云镜像下载地址</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">vi</span> /etc/docker/daemon.json</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Json" class="marker"></div><pre><span class="token punctuation">{</span> 
  <span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"https://zydiol88.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">9）重启<span class="jill"></span>Docker</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> systemctl restart docker  
systemctl status docker  <span class="token comment">#查看docker状态</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">离线安装方式请参考：</span><span class="inline-wrap"><a href="https://www.cnblogs.com/kingsonfu/p/11576797.html"><span>https://www.cnblogs.com/kingsonfu/p/11576797.html</span></a></span></div></div><h3 class="wolai-block"><span class="inline-wrap">【docker<span class="jill"></span>命令】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）镜像命令：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">镜像：相当于应用的安装包，在<span class="jill"></span>Docker<span class="jill"></span>部署的任何应用都需要先构建成为镜像</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker search 镜像名称 <span class="token comment">#搜索镜像</span>
docker pull 镜像名称 <span class="token comment">#拉取镜像 示例：docker pull nginx</span>
docker images <span class="token comment">#查看本地所有镜像</span>
docker rmi -f 镜像名称 <span class="token comment">#删除镜像(即使在运行)</span>
docker rmi -f <span class="token variable"><span class="token variable">$(</span>docker images -qa<span class="token variable">)</span></span> <span class="token comment">#删除所有镜像</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）容器命令</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">容器：容器是由镜像创建而来。容器是<span class="jill"></span>Docker<span class="jill"></span>运行应用的载体，每个应用都分别运行在<span class="jill"></span>Docker<span class="jill"></span>的每个
容器中。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker run -di -p 对应宿主机那个端口:开放应用端口  镜像名称:标签 <span class="token comment">#运行容器（默认是前台运行），di:i是运行，d是后台;  -p是public的意思;</span>
docker <span class="token function">ps</span> <span class="token comment">#查看运行的容器</span>
docker <span class="token function">ps</span> -a <span class="token comment">#查询所有容器</span>

docker <span class="token builtin class-name">exec</span> -it 容器ID/容器名称 /bin/bash <span class="token comment">#进入容器内部</span>
docker start/stop/restart 容器名称/ID <span class="token comment">#启动/停止/重启容器</span>
docker <span class="token function">rm</span> -f 容器名称/ID <span class="token comment">#删除容器</span>
docker <span class="token function">rm</span> <span class="token variable"><span class="token variable">`</span>docker <span class="token function">ps</span> -a -q<span class="token variable">`</span></span> <span class="token comment">#删除所有容器</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">【镜像的制作】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面将 &quot;ttensquare_eureka_server-1.0-SNAPSHOT.jar&quot; enreka<span class="jill"></span>微服务制作成一个<span class="jill"></span>docker<span class="jill"></span>镜像</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）上传<span class="jill"></span>Eureka<span class="jill"></span>的微服务<span class="jill"></span>jar<span class="jill"></span>包到<span class="jill"></span>linux
2）编写<span class="jill"></span>Dockerfile</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>FROM openjdk:8-jdk-alpine
ARG JAR_FILE
COPY <span class="token variable">${JAR_FILE}</span> app.jar
EXPOSE <span class="token number">10086</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>,<span class="token string">"-jar"</span>,<span class="token string">"/app.jar"</span><span class="token punctuation">]</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）构建镜像</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker build --build-arg <span class="token assign-left variable">JAR_FILE</span><span class="token operator">=</span>tensquare_eureka_server-1.0-SNAPSHOT.jar -t eureka:v1 <span class="token builtin class-name">.</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）查看镜像是否创建成功</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker images</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）创建容器</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker run -i --name<span class="token operator">=</span>eureka -p <span class="token number">10086</span>:10086 eureka:v1</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">6）访问容器
</span><span class="inline-wrap"><a href="http://192.168.66.101:10086"><span>http://192.168.66.101:10086</span></a></span></div></div><h3 class="wolai-block"><span class="inline-wrap">【Harbor<span class="jill"></span>安装】</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627212945189-1627212945174.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">简介：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Harbor（港口，港湾）是一个用于存储和分发<span class="jill"></span>Docker<span class="jill"></span>镜像的企业级<span class="jill"></span>Registry<span class="jill"></span>服务器。
除了<span class="jill"></span>Harbor<span class="jill"></span>这个私有镜像仓库之外，还有<span class="jill"></span>Docker<span class="jill"></span>官方提供的<span class="jill"></span>Registry。相对<span class="jill"></span>Registry，Harbor<span class="jill"></span>具有很
多优势：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">提供分层传输机制，优化网络传输 Docker<span class="jill"></span>镜像是是分层的，而如果每次传输都使用全量文件(所以
用<span class="jill"></span>FTP<span class="jill"></span>的方式并不适合)，显然不经济。必须提供识别分层传输的机制，以层的<span class="jill"></span>UUID<span class="jill"></span>为标识，确定
传输的对象。</span></li><li><div class="marker"></div><span class="inline-wrap">提供<span class="jill"></span>WEB<span class="jill"></span>界面，优化用户体验 只用镜像的名字来进行上传下载显然很不方便，需要有一个用户界
面可以支持登陆、搜索功能，包括区分公有、私有镜像。</span></li><li><div class="marker"></div><span class="inline-wrap">支持水平扩展集群 当有用户对镜像的上传下载操作集中在某服务器，需要对相应的访问压力作分
解。</span></li><li><div class="marker"></div><span class="inline-wrap">良好的安全机制 企业中的开发团队有很多不同的职位，对于不同的职位人员，分配不同的权限，
具有更好的安全性。</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）先安装<span class="jill"></span>Docker<span class="jill"></span>并启动<span class="jill"></span>Docker（已完成）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">参考之前的安装过程
2）先安装<span class="jill"></span>docker-compose</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">sudo</span> <span class="token function">curl</span> -L https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -s<span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -m<span class="token variable">`</span></span> -o /usr/local/bin/docker-compose  <span class="token comment">#安装</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose  
docker-compose --version  <span class="token comment">#查看版本</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）下载<span class="jill"></span>Harbor<span class="jill"></span>的压缩包（本课程版本为：v1.9.2）
</span><span class="inline-wrap"><a href="https://github.com/goharbor/harbor/releases"><span>https://github.com/goharbor/harbor/releases</span></a></span><span class="inline-wrap">
4）上传压缩包到<span class="jill"></span>linux，并解压</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">tar</span> -xzf harbor-offline-installer-v1.9.2.tgz
<span class="token function">mkdir</span> /opt/harbor
<span class="token function">mv</span> harbor/* /opt/harbor
<span class="token builtin class-name">cd</span> /opt/harbor</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）修改<span class="jill"></span>Harbor<span class="jill"></span>的配置</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">vi</span> harbor.yml
<span class="token comment">#修改内容1:   hostname: 192.168.66.102</span>
<span class="token comment">#修改内容2:   port: 85</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">6）安装<span class="jill"></span>Harbor</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>./prepare
./install.sh</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">7）启动<span class="jill"></span>Harbor</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker-compose up -d <span class="token comment">#启动</span>
<span class="token comment">#docker-compose down -v #停止</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">8）访问<span class="jill"></span>Harbor
</span><span class="inline-wrap"><a href="http://192.168.66.102:85"><span>http://192.168.66.102:85</span></a></span><span class="inline-wrap">
默认账户密码：admin/Harbor12345</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">你可能会遇到的问题：</span><span class="inline-wrap"><a href="https://www.cnblogs.com/hallejuayahaha/p/13926575.html"><span>https://www.cnblogs.com/hallejuayahaha/p/13926575.html</span></a></span><span class="inline-wrap"> （参考）博主遇到了<span class="jill"></span>docker-compose<span class="jill"></span>过低找不到，导致启动报错：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token punctuation">[</span>root@localhost zhuangjie<span class="token punctuation">]</span># docker<span class="token operator">-</span>compose up <span class="token operator">-</span>d #启动
<span class="token constant">ERROR</span><span class="token operator">:</span> 
        <span class="token maybe-class-name">Can</span>'t find a suitable configuration file <span class="token keyword">in</span> <span class="token keyword">this</span> directory or any
        parent<span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Are</span></span> you <span class="token keyword">in</span> the right directory<span class="token operator">?</span>

        <span class="token maybe-class-name">Supported</span> filenames<span class="token operator">:</span> docker<span class="token operator">-</span>compose<span class="token punctuation">.</span><span class="token property-access">yml</span><span class="token punctuation">,</span> docker<span class="token operator">-</span>compose<span class="token punctuation">.</span><span class="token property-access">yaml</span>
        </pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#解决</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L https://github.com/docker/compose/releases/download/1.27.2/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -s<span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -m<span class="token variable">`</span></span> -o /usr/local/bin/docker-compose
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose
docker-compose --version

./install.sh <span class="token comment">#注意还要cd到Harbor根目录执行</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">【项目与用户】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">登录后：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）创建私有项目（项目分为公开项目与私有项目）</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627218066729-1627218066687.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）创建用户</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217685972-1627217685963.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）为项目添加成员：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627217922413-1627217922383.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 370px"><span class="inline-wrap">角色</span></th><th style="width: 370px"><span class="inline-wrap">权限说明</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">访客</span></td><td><span class="inline-wrap">对于指定项目拥有只读权限</span></td></tr><tr><td><span class="inline-wrap">开发人员</span></td><td><span class="inline-wrap">对于指定项目拥有读写权限</span></td></tr><tr><td><span class="inline-wrap">维护人员</span></td><td><span class="inline-wrap">对于指定项目拥有读写权限，创建 Webhooks</span></td></tr><tr><td><span class="inline-wrap">项目管理员</span></td><td><span class="inline-wrap">除了读写权限，同时拥有用户管理/镜像扫描等管理权限</span></td></tr></tbody></table></div><h3 class="wolai-block"><span class="inline-wrap">【推送镜像到<span class="jill"></span>Harbor】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）给镜像打上标签</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker tag eureka:v1 <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）推送镜像(会遇到二个问题，请解决)</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">问题<span class="jill"></span>1：需要把<span class="jill"></span>Harbor<span class="jill"></span>地址加入到<span class="jill"></span>Docker<span class="jill"></span>信任列表,不解决，推送会提示：</span><span class="inline-wrap">
</span><span class="inline-wrap">vi /etc/docker/daemon.json</span><span class="inline-wrap">
</span><span class="inline-wrap">需要重启<span class="jill"></span>Docker</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token maybe-class-name">The</span> push refers to repository <span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>tensquare<span class="token operator">/</span>eureka<span class="token punctuation">]</span>
<span class="token maybe-class-name">Get</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>v2<span class="token operator">/</span><span class="token operator">:</span> http<span class="token operator">:</span> server gave <span class="token constant">HTTP</span> response to <span class="token constant">HTTPS</span>
client</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">{</span> 
 <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://zydiol88.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
 <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.87.102:85"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">问题<span class="jill"></span>2：权限不足，不解决，推送会提示：“denied: requested access to the resource is denied”</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#docker login -u 用户名 -p 密码 192.168.87.102:85</span>

<span class="token punctuation">[</span>root@localhost 桌面<span class="token punctuation">]</span><span class="token comment"># docker login -u zhuangjie  -p gkmzjaznH21  192.168.87.102:85</span>
Login Succeeded</pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">推送</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker push <span class="token number">192.168</span>.208.157:85/uplog/eureka</pre></div></code-block></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）登录<span class="jill"></span>Harbor<span class="jill"></span>查看</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627219857216-1627219857185.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">【从<span class="jill"></span>Harbor<span class="jill"></span>拉取镜像】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">存在<span class="jill"></span>Docker<span class="jill"></span>后，我们做以下准备，这样才能确保我们能从<span class="jill"></span>Harbor<span class="jill"></span>中拉取镜像：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">需要把<span class="jill"></span>Harbor<span class="jill"></span>地址加入到<span class="jill"></span>Docker<span class="jill"></span>信任列表,不解决，推送会提示：</span><span class="inline-wrap">
</span><span class="inline-wrap">vi /etc/docker/daemon.json</span><span class="inline-wrap">
</span><span class="inline-wrap">需要重启<span class="jill"></span>Docker</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token maybe-class-name">The</span> push refers to repository <span class="token punctuation">[</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>tensquare<span class="token operator">/</span>eureka<span class="token punctuation">]</span>
<span class="token maybe-class-name">Get</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.66</span><span class="token number">.102</span><span class="token operator">:</span><span class="token number">85</span><span class="token operator">/</span>v2<span class="token operator">/</span><span class="token operator">:</span> http<span class="token operator">:</span> server gave <span class="token constant">HTTP</span> response to <span class="token constant">HTTPS</span>
client</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">{</span> 
 <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"https://zydiol88.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>,
 <span class="token string">"insecure-registries"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.208.157:85"</span><span class="token punctuation">]</span>  
<span class="token punctuation">}</span></pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">准备拉取</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker login -u zhuangjie -p zhuangJIE3333 <span class="token number">192.168</span>.208.157:85  <span class="token comment">#登录</span>
docker pull <span class="token number">192.168</span>.208.157:85/uplog/eureka:v1  <span class="token comment">#拉取，该拉取命令直接从Harbor上一键复制</span>
docker images  <span class="token comment">#查看本地镜像</span></pre></div></code-block></li></ol><h2 class="wolai-block"><span class="inline-wrap">【微服务持续集成】</span></h2><h3 class="wolai-block"><span class="inline-wrap">【将代码上传到<span class="jill"></span>GitLab】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">后端代码：注意要代码要添加打包的插件</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Xml" class="marker"></div><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">前端代码：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Powershell" class="marker"></div><pre>npm run dev  <span class="token comment">#测试启动项目</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>GitLab<span class="jill"></span>上分别创建两个项目，分别是前端的 </span><span class="inline-wrap"><b>tensquare_front</b></span><span class="inline-wrap">  与后端的 </span><span class="inline-wrap"><b>tensquare_back</b></span><span class="inline-wrap">  ，然后将代码分别上传到对应的项目仓库上去。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">【Jenkins<span class="jill"></span>拉取与构建】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>jenkins<span class="jill"></span>上创建一个流水线的项目 “tensquare_back”  ，项目使用参数化（字符参数）构建：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627527217960-1627527217853.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用本地脚本进行构建：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627527398196-1627527398130.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">项目根目录“Jenkinsfile” 脚本文件：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"3b3eca2f-e2d7-44e5-8e11-e98ee29953dc"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.128:zhuangjie/tensquare_back.git"</span>
node <span class="token punctuation">{</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后进行构建！</span></div></div><h3 class="wolai-block"><span class="inline-wrap">【加入代码审查】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>jenkins<span class="jill"></span>中加入一个构建参数（选项参数）：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627542931380-1627542931219.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在项目代码中，编辑“Jenkinsfile” 文件加入代码审查的脚本代码：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">//git凭证ID(ssh)</span>
def git_auth <span class="token operator">=</span> <span class="token string">"3b3eca2f-e2d7-44e5-8e11-e98ee29953dc"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.128:zhuangjie/tensquare_back.git"</span>
node <span class="token punctuation">{</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//jenkins>系统管理>全局工具配置>SonarQube Scanner>"Name"</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//jenkins>系统管理>系统配置>SonarQube servers>"Name"</span>
                sh <span class="token string">""</span>"
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">""</span>"
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">同时我们在每个微服务模块的根目录下加入“sonar-project.properties”  文件(注意模块间的该文件内容是不同的)：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">tensquare_eureka_server<span class="jill"></span>模块：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre># must be unique <span class="token keyword">in</span> a given <span class="token maybe-class-name">SonarQube</span> instance
sonar<span class="token punctuation">.</span><span class="token property-access">projectKey</span><span class="token operator">=</span>tensquare_eureka_server
# <span class="token keyword">this</span> is the name and version displayed <span class="token keyword">in</span> the <span class="token maybe-class-name">SonarQube</span> <span class="token constant">UI</span><span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Was</span></span> mandatory prior to <span class="token maybe-class-name">SonarQube</span> <span class="token number">6.1</span><span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">projectName</span><span class="token operator">=</span>tensquare_eureka_server
sonar<span class="token punctuation">.</span><span class="token property-access">projectVersion</span><span class="token operator">=</span><span class="token number">1.0</span>

# <span class="token maybe-class-name">Path</span> is relative to the sonar<span class="token operator">-</span>project<span class="token punctuation">.</span><span class="token property-access">properties</span> file<span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Replace</span></span> <span class="token string">"\" by "</span><span class="token operator">/</span>" on <span class="token maybe-class-name">Windows</span><span class="token punctuation">.</span>
# <span class="token maybe-class-name">This</span> property is optional <span class="token keyword control-flow">if</span> sonar<span class="token punctuation">.</span><span class="token property-access">modules</span> is set<span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">sources</span><span class="token operator">=</span><span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">exclusions</span><span class="token operator">=</span><span class="token operator">**</span><span class="token operator">/</span>test<span class="token doc-comment comment">/**,**/</span>target<span class="token doc-comment comment">/**
sonar.java.binaries=.

sonar.java.source=1.8
sonar.java.target=1.8
#sonar.java.libraries=**/</span>target<span class="token operator">/</span>classes<span class="token doc-comment comment">/**

# Encoding of the source code. Default is default system encoding
sonar.sourceEncoding=UTF-8</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">tensquare_zuul<span class="jill"></span>模块：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre># must be unique <span class="token keyword">in</span> a given <span class="token maybe-class-name">SonarQube</span> instance
sonar<span class="token punctuation">.</span><span class="token property-access">projectKey</span><span class="token operator">=</span>tensquare_zuul
# <span class="token keyword">this</span> is the name and version displayed <span class="token keyword">in</span> the <span class="token maybe-class-name">SonarQube</span> <span class="token constant">UI</span><span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Was</span></span> mandatory prior to <span class="token maybe-class-name">SonarQube</span> <span class="token number">6.1</span><span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">projectName</span><span class="token operator">=</span>tensquare_zuul
sonar<span class="token punctuation">.</span><span class="token property-access">projectVersion</span><span class="token operator">=</span><span class="token number">1.0</span>

# <span class="token maybe-class-name">Path</span> is relative to the sonar<span class="token operator">-</span>project<span class="token punctuation">.</span><span class="token property-access">properties</span> file<span class="token punctuation">.</span> <span class="token property-access"><span class="token maybe-class-name">Replace</span></span> <span class="token string">"\" by "</span><span class="token operator">/</span>" on <span class="token maybe-class-name">Windows</span><span class="token punctuation">.</span>
# <span class="token maybe-class-name">This</span> property is optional <span class="token keyword control-flow">if</span> sonar<span class="token punctuation">.</span><span class="token property-access">modules</span> is set<span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">sources</span><span class="token operator">=</span><span class="token punctuation">.</span>
<span class="token property-access">sonar</span><span class="token punctuation">.</span><span class="token property-access">exclusions</span><span class="token operator">=</span><span class="token operator">**</span><span class="token operator">/</span>test<span class="token doc-comment comment">/**,**/</span>target<span class="token doc-comment comment">/**
sonar.java.binaries=.

sonar.java.source=1.8
sonar.java.target=1.8
#sonar.java.libraries=**/</span>target<span class="token operator">/</span>classes<span class="token doc-comment comment">/**

# Encoding of the source code. Default is default system encoding
sonar.sourceEncoding=UTF-8</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">其它模块也是一样。然后进行代码构建，构建完后，我们可以访问<span class="jill"></span>Sonar<span class="jill"></span>来查看审查结果。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">【编译打包】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">我们需要将公共依赖进行安装，所以需要编辑项目根目录下 “Jenkinsfile”  脚本,加入“编译，安装公共子工程” 这个 阶段：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"3b3eca2f-e2d7-44e5-8e11-e98ee29953dc"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.133:zhuangjie/tensquare_back.git"</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">""</span>"
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后在确保各个模块&quot;pom.xml&quot; 存在打包插件(父工程的该插件可以删除了)：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Xml" class="marker"></div><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">这样就能确保依赖安装能完成了。下面我们就进行对可运行的微服务进行打包：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">编辑项目根目录下 “Jenkinsfile”  脚本,加入“编译，打包微服务工程” 这个 阶段：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"3b3eca2f-e2d7-44e5-8e11-e98ee29953dc"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.133:zhuangjie/tensquare_back.git"</span>


node <span class="token punctuation">{</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">""</span>"
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f ${project_name}  clean package"</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">因为<span class="jill"></span>zull<span class="jill"></span>这个模块时依赖了父模块，所以我们需要确保服务器的本地仓库有父工程：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/root/.m2/repository/com/tensquare
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># mv /home/zhuangjie/桌面/tensquare_parent/ ./</span>
<span class="token punctuation">[</span>root@localhost tensquare<span class="token punctuation">]</span><span class="token comment"># ll</span>
drwxr-xr-x. <span class="token number">3</span> root      root      <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:18 tensquare_common
drwxrwxrwx. <span class="token number">3</span> zhuangjie zhuangjie <span class="token number">58</span> <span class="token number">7</span>月  <span class="token number">29</span> 01:37 tensquare_parent</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">我们移动的文件目录：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549375224-1627549375170.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后再进行构建。这样我们在拉取的代码目录中就打包好了该模块的<span class="jill"></span>jar<span class="jill"></span>文件（测试<span class="jill"></span>jar<span class="jill"></span>可正常运行）。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1627549978651-1627549978565.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">【镜像制作】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在每个模块中加入“Dockerfile” 文件（common<span class="jill"></span>不需要)：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#FROM java:8</span>
FROM openjdk:8-jdk-alpine
ARG JAR_FILE
COPY <span class="token variable">${JAR_FILE}</span> app.jar
EXPOSE <span class="token number">10020</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>,<span class="token string">"-jar"</span>,<span class="token string">"/app.jar"</span><span class="token punctuation">]</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在模块<span class="jill"></span>pom.xml<span class="jill"></span>中加入插件(common<span class="jill"></span>不需要)：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Xml" class="marker"></div><pre>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.spotify<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>dockerfile-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">></span></span>${project.artifactId}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>buildArgs</span><span class="token punctuation">></span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>JAR_FILE</span><span class="token punctuation">></span></span>target/${project.build.finalName}.jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>JAR_FILE</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>buildArgs</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后编辑 “Jenkinsfile” (加入：</span><span class="inline-wrap"><b>dockerfile:build</b></span><span class="inline-wrap"> 来触发制作镜像)：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="JavaScript" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"3b3eca2f-e2d7-44e5-8e11-e98ee29953dc"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.133:zhuangjie/tensquare_back.git"</span>

node <span class="token punctuation">{</span>
    
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'ConarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">""</span>"
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f ${project_name}  clean package dockerfile:build"</span>
   <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后在<span class="jill"></span>jenkins<span class="jill"></span>点击构建。完成后：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>docker images  <span class="token comment">#查看镜像，就会发现多出一个镜像文件，查看时间是刚刚制作的</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">【应用部署】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">以下步骤：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）在<span class="jill"></span>jenkins<span class="jill"></span>安装 Publish Over SSH<span class="jill"></span>插件</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628080915258-1628080915249.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）确保<span class="jill"></span>jenkins（101）服务器有.ssh<span class="jill"></span>如果没有使用命令 &quot;ssh-keygen&quot; 生成。然后使用命令 &quot;ssh-copy-id 192.168.87.103&quot; 将公钥<span class="jill"></span>copy<span class="jill"></span>到<span class="jill"></span>web（103）服务器中</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628082119907-1628082119768.png" style="width: 647px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）在<span class="jill"></span>jenkins 的”全局配置“中配置&quot;Publish over SSH&quot; 的内容。怎么配置？</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">【Passphrse】密码，好像没有设置，如果设置了，需要填写。
【Path to key】key<span class="jill"></span>文件的路径（私钥）/root/.ssh/id_rsa
【Key】为空，也 可以测试成功**。注意如果 “/root/.ssh/id_rsa” 文件找不到需要将.ssh<span class="jill"></span>的私钥粘贴到文本框中，至于是<span class="jill"></span>root<span class="jill"></span>还是其它用户，要看使用<span class="jill"></span>copy<span class="jill"></span>命令时用的是哪个用户执行的了。**</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">【SSH Server Name】标识的名字，随便你取什么名字
【Hostname】需要连接<span class="jill"></span>ssh<span class="jill"></span>的主机名或<span class="jill"></span>ip<span class="jill"></span>地址，此处填写应用服务器<span class="jill"></span>IP（建议<span class="jill"></span>ip）
【Username】用户名
【Remote Directory】远程目录(根据需要填写文件传到此目录下)
【Test Configuration】配置完成，点击<span class="jill"></span>test<span class="jill"></span>会显示<span class="jill"></span>Success![]</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093028483-1628093028472.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628083784632-1628083784445.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）在<span class="jill"></span>jenkins<span class="jill"></span>项目配置中添加一个&quot;字符参数&quot; + 在项目代码中修改 &quot;Jenkinsfile&quot; 文件 + 上传部署脚本到<span class="jill"></span>web<span class="jill"></span>服务器中（需要授于执行权限 chmod +x deploy.sh ）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">steps1:</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093531296-1628093531286.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">steps2:  加入“应用部署”</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"da1d1333-c35f-415a-903c-b8d58c870c56"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.100:zhuangjie/tensquare_back.git"</span>

<span class="token comment">//镜像的版本号</span>
def tag <span class="token operator">=</span> <span class="token string">"latest"</span>
<span class="token comment">//Harbor的url地址</span>
def harbor_url <span class="token operator">=</span> <span class="token string">"192.168.87.102:85"</span>
<span class="token comment">//镜像库项目名称</span>
def harbor_project <span class="token operator">=</span> <span class="token string">"uplog"</span>
<span class="token comment">//Harbor的登录凭证ID</span>
def harbor_auth <span class="token operator">=</span> <span class="token string">"ef2651c8-92a7-4edb-b4ca-4e182fadf0ca"</span>

node <span class="token punctuation">{</span>
<span class="token comment">//    //获取当前选择的项目名称</span>
<span class="token comment">//    def selectedProjectNames = "${project_name}".split(",")</span>
<span class="token comment">//    //获取当前选择的服务器名称</span>
<span class="token comment">//    def selectedServers = "${publish_server}".split(",")</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
        <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'SonarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
    cd $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>
    $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
  <span class="token string">""</span>"
        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程，上传镜像'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   sh <span class="token string">"echo '开始制作镜像'"</span>
     sh <span class="token string">"mvn -f ${project_name}  clean package dockerfile:build"</span>
    sh <span class="token string">"echo '镜像制作好了'"</span>
      <span class="token comment">//定义镜像名称</span>
                    def imageName <span class="token operator">=</span> <span class="token string">"${project_name}:${tag}"</span>
                   <span class="token comment">//对镜像打上标签</span>
                   sh <span class="token string">"docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}"</span>
                   <span class="token comment">//把镜像推送到Harbor</span>
               <span class="token function">withCredentials</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">usernamePassword</span><span class="token punctuation">(</span>credentialsId<span class="token operator">:</span> <span class="token string">"${harbor_auth}"</span><span class="token punctuation">,</span> passwordVariable<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> usernameVariable<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                       <span class="token comment">//登录到Harbor</span>
                       sh <span class="token string">"docker login -u ${username} -p ${password} ${harbor_url}"</span>
                       <span class="token comment">//镜像上传</span>
                       sh <span class="token string">"docker push ${harbor_url}/${harbor_project}/${imageName}"</span>
                       sh <span class="token string">"echo 镜像上传成功"</span>
              <span class="token punctuation">}</span>
              sh <span class="token string">"echo '应用部署开始'"</span>
                <span class="token function">sshPublisher</span><span class="token punctuation">(</span>publishers<span class="token operator">:</span> <span class="token punctuation">[</span>
                            <span class="token function">sshPublisherDesc</span><span class="token punctuation">(</span>configName<span class="token operator">:</span> <span class="token string">'master_server'</span><span class="token punctuation">,</span>
                            transfers<span class="token operator">:</span> <span class="token punctuation">[</span>
                                <span class="token function">sshTransfer</span><span class="token punctuation">(</span>cleanRemote<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                excludes<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                <span class="token comment">// 触发的命令，deploy.sh</span>
                                execCommand<span class="token operator">:</span> <span class="token string">"/opt/jenkins_shell/deploy.sh $harbor_url $harbor_project $project_name $tag $port"</span><span class="token punctuation">,</span>
                                execTimeout<span class="token operator">:</span> <span class="token number">120000</span><span class="token punctuation">,</span>
                                flatten<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                makeEmptyDirs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                noDefaultExcludes<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                patternSeparator<span class="token operator">:</span> <span class="token string">'[ , ]+'</span><span class="token punctuation">,</span>
                                remoteDirectory<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                remoteDirectorySDF<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                removePrefix<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                sourceFiles<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                            usePromotionTimestamp<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            useWorkspaceInPromotion<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            verbose<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span>
                sh <span class="token string">"echo '应用部署结束'"</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">与之前相比添加了：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token spread operator">...</span><span class="token punctuation">.</span>

<span class="token property-access">sh</span> <span class="token string">"echo '应用部署开始'"</span>
                <span class="token function">sshPublisher</span><span class="token punctuation">(</span>publishers<span class="token operator">:</span> <span class="token punctuation">[</span>
                            <span class="token function">sshPublisherDesc</span><span class="token punctuation">(</span>configName<span class="token operator">:</span> <span class="token string">'master_server'</span><span class="token punctuation">,</span>
                            transfers<span class="token operator">:</span> <span class="token punctuation">[</span>
                                <span class="token function">sshTransfer</span><span class="token punctuation">(</span>cleanRemote<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                excludes<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                <span class="token comment">// 触发的命令，deploy.sh</span>
                                execCommand<span class="token operator">:</span> <span class="token string">"/opt/jenkins_shell/deploy.sh $harbor_url $harbor_project $project_name $tag $port"</span><span class="token punctuation">,</span>
                                execTimeout<span class="token operator">:</span> <span class="token number">120000</span><span class="token punctuation">,</span>
                                flatten<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                makeEmptyDirs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                noDefaultExcludes<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                patternSeparator<span class="token operator">:</span> <span class="token string">'[ , ]+'</span><span class="token punctuation">,</span>
                                remoteDirectory<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                remoteDirectorySDF<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                removePrefix<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                sourceFiles<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                            usePromotionTimestamp<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            useWorkspaceInPromotion<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            verbose<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span>
                sh <span class="token string">"echo '应用部署结束'"</span>
                
<span class="token spread operator">...</span><span class="token punctuation">.</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）上传部署脚本到指定目录下（上面的<span class="jill"></span>Jenkinsfile<span class="jill"></span>部署代码中指定的路径）</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628085614649-1628085614604.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">注意：需要确保我们<span class="jill"></span>jenkins（101<span class="jill"></span>服务器）与<span class="jill"></span>web（103）服务器能正常登录<span class="jill"></span>Harbor（102）服务器</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628094317092-1628094317018.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">6）执行部署</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>web(103)服务器中，执行“docker ps -a”命令就会发现我们构建的项目正在运行：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628093983955-1628093983885.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">访问：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628094028736-1628094028724.png" style="width: 760px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">【后端代码部署优化】</span></h2><h3 class="wolai-block"><span class="inline-wrap">【代码的修改】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">主要是注册中心，其它微服务模块的修改是一样的。</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Eureka 的 application.yml：</span></li></ul><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token comment"># 集群版</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> EUREKA<span class="token punctuation">-</span>HA

<span class="token punctuation">---</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token comment"># 指定profile=eureka-server1</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server1
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># 指定当profile=eureka-server1时，主机名是eureka-server1</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 192.168.87.103
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
     <span class="token comment"># 将自己注册到eureka-server1、eureka-server2这个Eureka上面去</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.87.103<span class="token punctuation">:</span>10086/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//192.168.87.104<span class="token punctuation">:</span>10086/eureka/

<span class="token punctuation">---</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server2
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 192.168.87.104
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.87.103<span class="token punctuation">:</span>10086/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//192.168.87.104<span class="token punctuation">:</span>10086/eureka/</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在启动微服务的时候，加入参数: spring.profiles.active 来读取对应的配置，使不同的机器应用不同的配置。</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">除了<span class="jill"></span>Eureka<span class="jill"></span>注册中心以外，其他微服务配置都需要加入所有<span class="jill"></span>Eureka<span class="jill"></span>服务</span></li></ul><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token comment"># Eureka配置</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.87.103<span class="token punctuation">:</span>10086/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//192.168.87.104<span class="token punctuation">:</span>10086/eureka/ <span class="token comment"># Eureka访问地址</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">【jenkins<span class="jill"></span>中创建项目】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个名为 &quot;tensquare_back_cluster&quot; 的流水线项目，并</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">进行参数化构建：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">tensquare_eureka_server@10086,tensquare_zuul@10020,tensquare_admin_service@9001,tensquare_gathering@9002</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">注册中心,服务网关,权限服务,活动服务</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628517339350-1628517339044.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">此时的构建效果：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628517441217-1628517441081.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">【代码审查】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">修改项目“</span><span class="inline-wrap"><b>Jenkinsfile</b></span><span class="inline-wrap">” 文件</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628521417094-1628521416987-%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90todo.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">此时的完整<span class="jill"></span>Jenkinsfile<span class="jill"></span>内容：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"da1d1333-c35f-415a-903c-b8d58c870c56"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.100:zhuangjie/tensquare_back.git"</span>

<span class="token comment">//镜像的版本号</span>
def tag <span class="token operator">=</span> <span class="token string">"latest"</span>
<span class="token comment">//Harbor的url地址</span>
def harbor_url <span class="token operator">=</span> <span class="token string">"192.168.87.102:85"</span>
<span class="token comment">//镜像库项目名称</span>
def harbor_project <span class="token operator">=</span> <span class="token string">"uplog"</span>
<span class="token comment">//Harbor的登录凭证ID</span>
def harbor_auth <span class="token operator">=</span> <span class="token string">"ef2651c8-92a7-4edb-b4ca-4e182fadf0ca"</span>

node <span class="token punctuation">{</span>
    <span class="token comment">//获取当前选择的项目名称</span>
    def selectedProjectNames <span class="token operator">=</span> <span class="token string">"${project_name}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>


   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>int i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>selectedProjectNames<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//tensquare_eureka_server@10086</span>
            def projectInfo <span class="token operator">=</span> selectedProjectNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//当前遍历的项目名称</span>
            def currentProjectName <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment">//当前遍历的项目端口</span>
            def currentProjectPort <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
            <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'SonarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
                cd $<span class="token punctuation">{</span>currentProjectName<span class="token punctuation">}</span>
                $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
              <span class="token string">""</span>"
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程，上传镜像'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   sh <span class="token string">"echo '开始制作镜像'"</span>
     sh <span class="token string">"mvn -f ${project_name}  clean package dockerfile:build"</span>
    sh <span class="token string">"echo '镜像制作好了'"</span>
      <span class="token comment">//定义镜像名称</span>
                    def imageName <span class="token operator">=</span> <span class="token string">"${project_name}:${tag}"</span>
                   <span class="token comment">//对镜像打上标签</span>
                   sh <span class="token string">"docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}"</span>
                   <span class="token comment">//把镜像推送到Harbor</span>
               <span class="token function">withCredentials</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">usernamePassword</span><span class="token punctuation">(</span>credentialsId<span class="token operator">:</span> <span class="token string">"${harbor_auth}"</span><span class="token punctuation">,</span> passwordVariable<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> usernameVariable<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                       <span class="token comment">//登录到Harbor</span>
                       sh <span class="token string">"docker login -u ${username} -p ${password} ${harbor_url}"</span>
                       <span class="token comment">//镜像上传</span>
                       sh <span class="token string">"docker push ${harbor_url}/${harbor_project}/${imageName}"</span>
                       sh <span class="token string">"echo 镜像上传成功"</span>
              <span class="token punctuation">}</span>
              sh <span class="token string">"echo '应用部署开始'"</span>
                <span class="token function">sshPublisher</span><span class="token punctuation">(</span>publishers<span class="token operator">:</span> <span class="token punctuation">[</span>
                            <span class="token function">sshPublisherDesc</span><span class="token punctuation">(</span>configName<span class="token operator">:</span> <span class="token string">'master_server'</span><span class="token punctuation">,</span>
                            transfers<span class="token operator">:</span> <span class="token punctuation">[</span>
                                <span class="token function">sshTransfer</span><span class="token punctuation">(</span>cleanRemote<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                excludes<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                <span class="token comment">// 触发的命令，deploy.sh</span>
                                execCommand<span class="token operator">:</span> <span class="token string">"/opt/jenkins_shell/deploy.sh $harbor_url $harbor_project $project_name $tag $port"</span><span class="token punctuation">,</span>
                                execTimeout<span class="token operator">:</span> <span class="token number">120000</span><span class="token punctuation">,</span>
                                flatten<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                makeEmptyDirs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                noDefaultExcludes<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                patternSeparator<span class="token operator">:</span> <span class="token string">'[ , ]+'</span><span class="token punctuation">,</span>
                                remoteDirectory<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                remoteDirectorySDF<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                removePrefix<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                                sourceFiles<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                            usePromotionTimestamp<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            useWorkspaceInPromotion<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            verbose<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span>
                sh <span class="token string">"echo '应用部署结束'"</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">【上传镜像到<span class="jill"></span>Harbor】</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648447700-1628648447686-image-20210810234710355.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">如果想要构建成功还需要修改<span class="jill"></span>jenkinsfile“应用部署“中的（项目名称与端口）：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre> <span class="token spread operator">...</span><span class="token punctuation">.</span>
<span class="token property-access">execCommand</span><span class="token operator">:</span> <span class="token string">"/opt/jenkins_shell/deployCluster.sh $harbor_url $harbor_project $currentProjectName $tag $currentProjectPort"</span><span class="token punctuation">,</span>
 <span class="token spread operator">...</span><span class="token punctuation">.</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">【应用部署】</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">分布式应用部署，我们需要再加入一台<span class="jill"></span>web<span class="jill"></span>服务器：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）需要在<span class="jill"></span>jenkins<span class="jill"></span>服务器中执行  ssh-copy-id 192.168.66.104 到新的<span class="jill"></span>web<span class="jill"></span>的服务器</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）在新的<span class="jill"></span>web<span class="jill"></span>服务器中： vi /etc/docker/daemon.json</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628605176931-1628605176910.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）系统配置-&gt;添加远程服务器</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>jenkins（Publish over SSH）中配置一台<span class="jill"></span>web<span class="jill"></span>服务器</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628611001560-1628611001547.png" style="width: 760px"/></figure></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">修改流水线项目</span></li></ol><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648405698-1628648405683-image-20210811001519165.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">部署效果：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648388613-1628648388594-image-20210811002247011.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">5）修改项目&quot;Jenkinsfile&quot; 文件配置：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648377303-1628648377290-image-20210811001121364.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">完整”Jenkinsfile“:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token comment">//git凭证ID</span>
def git_auth <span class="token operator">=</span> <span class="token string">"da1d1333-c35f-415a-903c-b8d58c870c56"</span>
<span class="token comment">//git的url地址</span>
def git_url <span class="token operator">=</span> <span class="token string">"git@192.168.87.100:zhuangjie/tensquare_back.git"</span>

<span class="token comment">//镜像的版本号</span>
def tag <span class="token operator">=</span> <span class="token string">"latest"</span>
<span class="token comment">//Harbor的url地址</span>
def harbor_url <span class="token operator">=</span> <span class="token string">"192.168.87.102:85"</span>
<span class="token comment">//镜像库项目名称</span>
def harbor_project <span class="token operator">=</span> <span class="token string">"uplog"</span>
<span class="token comment">//Harbor的登录凭证ID</span>
def harbor_auth <span class="token operator">=</span> <span class="token string">"ef2651c8-92a7-4edb-b4ca-4e182fadf0ca"</span>

node <span class="token punctuation">{</span>
    <span class="token comment">//获取当前选择的项目名称</span>
    def selectedProjectNames <span class="token operator">=</span> <span class="token string">"${project_name}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
    <span class="token comment">//把选择的服务器信息转为数组</span>
    def selectedServers <span class="token operator">=</span> <span class="token string">"${publish_server}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>

   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'拉取代码'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">"*/${branch}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">"${git_auth}"</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">"${git_url}"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'代码审查'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>int i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>selectedProjectNames<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//tensquare_eureka_server@10086</span>
            def projectInfo <span class="token operator">=</span> selectedProjectNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//当前遍历的项目名称</span>
            def currentProjectName <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment">//当前遍历的项目端口</span>
            def currentProjectPort <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            def scannerHome<span class="token operator">=</span>tool <span class="token string">'SonarQube-Scanner'</span><span class="token comment">//根据自己的Jenkinssonarqube-scanner环境修改</span>
            <span class="token function">withSonarQubeEnv</span><span class="token punctuation">(</span><span class="token string">'SonarQube6.7'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//引入Jenkinssonarqube环境</span>
                sh <span class="token string">""</span>"
                cd $<span class="token punctuation">{</span>currentProjectName<span class="token punctuation">}</span>
                $<span class="token punctuation">{</span>scannerHome<span class="token punctuation">}</span><span class="token operator">/</span>bin<span class="token operator">/</span>sonar<span class="token operator">-</span>scanner
              <span class="token string">""</span>"
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>


   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，安装公共子工程'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     sh <span class="token string">"mvn -f tensquare_common clean install"</span>
   <span class="token punctuation">}</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'编译，打包微服务工程，上传镜像'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span>int i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>selectedProjectNames<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//tensquare_eureka_server@10086</span>
            def projectInfo <span class="token operator">=</span> selectedProjectNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//当前遍历的项目名称</span>
            def currentProjectName <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token comment">//当前遍历的项目端口</span>
            def currentProjectPort <span class="token operator">=</span> <span class="token string">"${projectInfo}"</span><span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            sh <span class="token string">"echo '开始制作镜像'"</span>
            sh <span class="token string">"mvn -f ${currentProjectName}  clean package dockerfile:build"</span>
            sh <span class="token string">"echo '镜像制作好了'"</span>
            <span class="token comment">//定义镜像名称</span>
            def imageName <span class="token operator">=</span> <span class="token string">"${currentProjectName}:${tag}"</span>
            <span class="token comment">//对镜像打上标签</span>
            sh <span class="token string">"docker tag ${imageName} ${harbor_url}/${harbor_project}/${imageName}"</span>
            <span class="token comment">//把镜像推送到Harbor</span>
            <span class="token function">withCredentials</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">usernamePassword</span><span class="token punctuation">(</span>credentialsId<span class="token operator">:</span> <span class="token string">"${harbor_auth}"</span><span class="token punctuation">,</span> passwordVariable<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> usernameVariable<span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//登录到Harbor</span>
                    sh <span class="token string">"docker login -u ${username} -p ${password} ${harbor_url}"</span>
                    <span class="token comment">//镜像上传</span>
                    sh <span class="token string">"docker push ${harbor_url}/${harbor_project}/${imageName}"</span>
                    sh <span class="token string">"echo 镜像上传成功"</span>
            <span class="token punctuation">}</span>
           <span class="token comment">//=====以下为远程调用进行项目部署========</span>
           <span class="token keyword control-flow">for</span><span class="token punctuation">(</span>int j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>selectedServers<span class="token punctuation">.</span><span class="token method function property-access">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
               <span class="token comment">//每个服务名称</span>
               def currentServer <span class="token operator">=</span> selectedServers<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
               <span class="token comment">//添加微服务运行时的参数：spring.profiles.active</span>
               def activeProfile <span class="token operator">=</span> <span class="token string">"--spring.profiles.active="</span>
               <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>currentServer<span class="token operator">==</span><span class="token string">"master_server"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    activeProfile <span class="token operator">=</span> activeProfile<span class="token operator">+</span><span class="token string">"eureka-server1"</span>
               <span class="token punctuation">}</span><span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>currentServer<span class="token operator">==</span><span class="token string">"slave_server1"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    activeProfile <span class="token operator">=</span> activeProfile<span class="token operator">+</span><span class="token string">"eureka-server2"</span>
               <span class="token punctuation">}</span>
                sh <span class="token string">"echo '应用部署开始'"</span>
                <span class="token function">sshPublisher</span><span class="token punctuation">(</span>publishers<span class="token operator">:</span> <span class="token punctuation">[</span>
                       <span class="token function">sshPublisherDesc</span><span class="token punctuation">(</span>configName<span class="token operator">:</span> <span class="token string">"${currentServer}"</span><span class="token punctuation">,</span>
                       transfers<span class="token operator">:</span> <span class="token punctuation">[</span>
                           <span class="token function">sshTransfer</span><span class="token punctuation">(</span>cleanRemote<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           excludes<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                           <span class="token comment">// 触发的命令，deploy.sh</span>
                           execCommand<span class="token operator">:</span> <span class="token string">"/opt/jenkins_shell/deployCluster.sh $harbor_url $harbor_project $currentProjectName $tag $currentProjectPort"</span><span class="token punctuation">,</span>
                           execTimeout<span class="token operator">:</span> <span class="token number">120000</span><span class="token punctuation">,</span>
                           flatten<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           makeEmptyDirs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           noDefaultExcludes<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           patternSeparator<span class="token operator">:</span> <span class="token string">'[ , ]+'</span><span class="token punctuation">,</span>
                           remoteDirectory<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                           remoteDirectorySDF<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                           removePrefix<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                           sourceFiles<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
                       <span class="token punctuation">]</span><span class="token punctuation">,</span>
                       usePromotionTimestamp<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                       useWorkspaceInPromotion<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                       verbose<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span>
                sh <span class="token string">"echo '应用部署结束'"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">6）在两个生产服务器中 &quot;/opt/jenkins_shell&quot; 目录下加入 &quot;deployCluster.sh&quot; 脚本，并授予执行权限；</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628648361824-1628648361791-image-20210811001811353.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">deployCluster.sh</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token shebang important">#! /bin/sh</span>
<span class="token comment">#接收外部参数</span>
<span class="token assign-left variable">harbor_url</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">harbor_project_name</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">project_name</span><span class="token operator">=</span><span class="token variable">$3</span>
<span class="token assign-left variable">tag</span><span class="token operator">=</span><span class="token variable">$4</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$5</span>
<span class="token assign-left variable">profile</span><span class="token operator">=</span><span class="token variable">$6</span>

<span class="token assign-left variable">imageName</span><span class="token operator">=</span><span class="token variable">$harbor_url</span>/<span class="token variable">$harbor_project_name</span>/<span class="token variable">$project_name</span><span class="token builtin class-name">:</span><span class="token variable">$tag</span>

<span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$imageName</span>"</span>

<span class="token comment">#查询容器是否存在，存在则删除</span>
<span class="token assign-left variable">containerId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>docker <span class="token function">ps</span> -a <span class="token operator">|</span> <span class="token function">grep</span> -w $<span class="token punctuation">{</span>project_name<span class="token punctuation">}</span>:$<span class="token punctuation">{</span>tag<span class="token punctuation">}</span>  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$containerId</span>"</span> <span class="token operator">!=</span>  <span class="token string">""</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token comment">#停掉容器</span>
    docker stop <span class="token variable">$containerId</span>

    <span class="token comment">#删除容器</span>
    docker <span class="token function">rm</span> <span class="token variable">$containerId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">"成功删除容器"</span>
<span class="token keyword">fi</span>

<span class="token comment">#查询镜像是否存在，存在则删除</span>
<span class="token assign-left variable">imageId</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>docker images <span class="token operator">|</span> <span class="token function">grep</span> -w $project_name  <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $3}'</span><span class="token variable">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$imageId</span>"</span> <span class="token operator">!=</span>  <span class="token string">""</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
      
    <span class="token comment">#删除镜像</span>
    docker rmi -f <span class="token variable">$imageId</span>
  
  <span class="token builtin class-name">echo</span> <span class="token string">"成功删除镜像"</span>
<span class="token keyword">fi</span>


<span class="token comment"># 登录Harbor</span>
docker login -u zhuangjie -p gkmzjaznH21 <span class="token variable">$harbor_url</span>

<span class="token comment"># 下载镜像</span>
docker pull <span class="token variable">$imageName</span>

<span class="token comment"># 启动容器</span>
docker run -di -p <span class="token variable">$port</span><span class="token builtin class-name">:</span><span class="token variable">$port</span> <span class="token variable">$imageName</span> <span class="token variable">$profile</span>

<span class="token builtin class-name">echo</span> <span class="token string">"容器启动成功"</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">注意：需要修改 Harbor 登录信息。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">【高可用的<span class="jill"></span>nginx】</span></h3><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1628686966488-1628686966378.png" style="width: 736px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）安装<span class="jill"></span>Nginx（已完成）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）配置<span class="jill"></span>nginx</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>upstream zuulServer <span class="token punctuation">{</span>
        server <span class="token number">192.168</span><span class="token number">.87</span><span class="token number">.103</span><span class="token operator">:</span><span class="token number">10020</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        server <span class="token number">192.168</span><span class="token number">.87</span><span class="token number">.104</span><span class="token operator">:</span><span class="token number">10020</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
        listen       <span class="token number">9090</span><span class="token punctuation">;</span>
        listen       <span class="token punctuation">[</span><span class="token operator">:</span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">;</span>
        server_name  _<span class="token punctuation">;</span>
        root         <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>

        # <span class="token maybe-class-name">Load</span> configuration files <span class="token keyword control-flow">for</span> the <span class="token keyword module">default</span> server block<span class="token punctuation">.</span>
        <span class="token property-access">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword module">default</span><span class="token punctuation">.</span><span class="token property-access">d</span><span class="token comment">/*.conf;

        location / {
           proxy_pass http://zuulServer/;
    }
...
</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）重启<span class="jill"></span>nginx</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>systemctl restart nginx</pre></div></code-block><div class="wolai-sub-page wolai-block"><div class="page-icon icon-image" style="background-image: url(&quot;media/unnamed%20(1)_2.jpg&quot;)"></div><a href="jenkins%E5%AE%9E%E6%88%98/Jenkins%E5%AE%9E%E6%88%98.html"><span>Jenkins实战</span></a></div><div class="wolai-block wolai-text"><div><br/></div></div></article><footer></footer></body></html>