<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../css/wolai.css"/><title>Kubernetes - wolai 笔记</title><link rel="shortcut icon" href="media/1641538346333_1.webp"></link></head><body><header><div class="image has" style="background-position-y: 50%; background-image: url(&quot;https://cdn.wostatic.cn/cover/wolai/9WUKVes79EhyubBagvbLSJ.jpg&quot;)"></div><div class="title"><div class="banner"><div class="icon icon-image" style="background-image: url(&quot;media/1641538346333.webp&quot;)"></div></div><div data-title="Kubernetes" class="main-title"></div></div></header><article><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16415253882581641525388239.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配套资料：</span><span class="inline-wrap"><a href="https://gitee.com/yooome/golang/blob/main/k8s详细教程/Kubernetes详细教程.md#2610-安装kubernetes组件"><span>https://gitee.com/yooome/golang/blob/main/k8s<span class="jill"></span>详细教程/Kubernetes<span class="jill"></span>详细教程.md#2610-安装<span class="jill"></span>kubernetes<span class="jill"></span>组件</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">配套视频：</span><span class="inline-wrap"><a href="https://www.bilibili.com/video/BV1Qv41167ck?p=9&amp;spm_id_from=pageDriver"><span>https://www.bilibili.com/video/BV1Qv41167ck</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h2 class="wolai-block"><span class="inline-wrap">1.1Kubernetes 概述</span></h2><h3 class="wolai-block"><span class="inline-wrap">1.1<span class="jill"></span>应用部署的演变</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在部署应用程序的方式上，主要经历了三个时代：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>传统部署</b></span><span class="inline-wrap">：</span><span class="red inline-wrap">互联网早期，会直接将应用程序部署在物理机上</span><blockquote class="wolai-block"><span class="inline-wrap">优点：简单，不需要其它技术的参与
缺点：不能为应用程序定义资源使用边界，程序之间容易产生影响</span></blockquote></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>虚拟化部署</b></span><span class="inline-wrap">：</span><span class="red inline-wrap">可以在一台物理机上运行多个虚拟机，每个虚拟机都是独立操作系统</span><blockquote class="wolai-block"><span class="inline-wrap">优点：程序环境不会相互产生影响，提供了一定程度的安全性    
缺点：增加了操作系统，浪费了部分资源</span></blockquote></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>容器化部署</b></span><span class="inline-wrap">：</span><span class="red inline-wrap">与虚拟化类似，但是共享了操作系统</span><blockquote class="wolai-block"><span class="inline-wrap">优点：可以保证每个容器拥有自己的文件系统、CPU、内存、进程空间等，运行应用程序所需要的资源都被容器包装，并和底层基础架构解耦。 容器化的应用程序可以跨云服务商、跨<span class="jill"></span>Linux<span class="jill"></span>操作系统发行版进行部署</span></blockquote><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16421380656271642138065565.png" style="width: 649px"/></figure></div></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">容器化部署方式给带来很多的便利，但是也会出现一些问题，比如说：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">一个容器故障停机了，怎么样让另外一个容器立刻启动去替补停机的容器</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">当并发访问量变大的时候，怎么样做到横向扩展容器数量</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">这些容器管理的问题统称为</span><span class="inline-wrap"><b>容器编排</b></span><span class="inline-wrap">问题，为了解决这些容器编排问题，就产生了一些容器编排的软件：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>Swarm</b></span><span class="inline-wrap">：Docker<span class="jill"></span>自己的容器编排工具</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>Mesos</b></span><span class="inline-wrap">：Apache<span class="jill"></span>的一个资源统一管控的工具，需要和<span class="jill"></span>Marathon<span class="jill"></span>结合使用</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>Kubernetes</b></span><span class="inline-wrap">：Google<span class="jill"></span>开源的的容器编排工具</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16421386472321642138647220.png" style="width: 616.2727272727273px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">1.2kubernetes<span class="jill"></span>简介</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>官方文档</code></span><span class="inline-wrap">  </span><span class="inline-wrap"><a href="https://kubernetes.io/zh/docs/setup/"><span>https://kubernetes.io/zh/docs/setup/</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes，是一个全新的基于容器技术的分布式架构领先方案，是谷歌严格保密十几年的秘密武器----</span><span class="red inline-wrap">Borg<span class="jill"></span>系统的一个开源版本</span><span class="inline-wrap">，</span><span class="red inline-wrap">于<span class="jill"></span>2014<span class="jill"></span>年<span class="jill"></span>9<span class="jill"></span>月发布第一个版本，2015<span class="jill"></span>年<span class="jill"></span>7<span class="jill"></span>月发布第一个正式版本。</span></div></div><div class="wolai-block wolai-text"><div><span class="red inline-wrap">kubernetes<span class="jill"></span>的本质是</span><span class="red inline-wrap"><b>一组服务器集群</b></span><span class="inline-wrap">，它可以在集群的每个节点上运行特定的程序，来对节点中的容器进行管理。目的是实现资源管理的自动化，主要提供了如下的主要功能：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>自我修复</b></span><span class="inline-wrap">：一旦某一个容器崩溃，能够在<span class="jill"></span>1<span class="jill"></span>秒中左右迅速启动新的容器</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>弹性伸缩</b></span><span class="inline-wrap">：可以根据需要，自动对集群中正在运行的容器数量进行调整</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>服务发现</b></span><span class="inline-wrap">：服务可以通过自动发现的形式找到它所依赖的服务</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>负载均衡</b></span><span class="inline-wrap">：如果一个服务起动了多个容器，能够自动实现请求的负载均衡</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>版本回退</b></span><span class="inline-wrap">：如果发现新发布的程序版本有问题，可以立即回退到原来的版本</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>存储编排</b></span><span class="inline-wrap">：可以根据容器自身的需求自动创建存储卷</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16421394576181642139457590.png" style="width: 636px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">1.3 kubernetes<span class="jill"></span>组件</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">一个<span class="jill"></span>kubernetes<span class="jill"></span>集群主要是由</span><span class="inline-wrap"><b>控制节点(master)</b></span><span class="inline-wrap">、</span><span class="inline-wrap"><b>工作节点(node) </b></span><span class="inline-wrap">构成，每个节点上都会安装不同的组件。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16421404957881642140495772.png" style="width: 678px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>master：集群的控制平面，负责集群的决策 ( 管理 )</b></span></div></div><blockquote class="wolai-block"><span class="inline-wrap"><b>ApiServer</b></span><span class="inline-wrap"> : </span><span class="red inline-wrap">资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API<span class="jill"></span>注册和发现等机制</span><span class="inline-wrap">

</span><span class="inline-wrap"><b>Scheduler</b></span><span class="inline-wrap"> : </span><span class="red inline-wrap">负责集群资源调度</span><span class="inline-wrap">，按照预定的调度策略将<span class="jill"></span>Pod<span class="jill"></span>调度到相应的<span class="jill"></span>node<span class="jill"></span>节点上

</span><span class="inline-wrap"><b>ControllerManager</b></span><span class="inline-wrap"> : </span><span class="red inline-wrap">负责维护集群的状态</span><span class="inline-wrap">，比如程序部署安排、故障检测、自动扩展、滚动更新等

</span><span class="inline-wrap"><b>Etcd</b></span><span class="inline-wrap"> ：负责</span><span class="red inline-wrap">存储集群中各种资源</span><span class="inline-wrap">对象的信息</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>node：集群的数据平面，负责为容器提供运行环境 ( 干活 )</b></span></div></div><blockquote class="wolai-block"><span class="inline-wrap"><b>Kubelet</b></span><span class="inline-wrap"> : 负责维护容器的生命周期，即通过控制<span class="jill"></span>docker，来创建、更新、销毁容器

</span><span class="inline-wrap"><b>KubeProxy</b></span><span class="inline-wrap"> : 负责提供集群内部的服务发现和负载均衡

</span><span class="inline-wrap"><b>Docker</b></span><span class="inline-wrap"> : 负责节点上容器的各种操作</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面，以部署一个<span class="jill"></span>nginx<span class="jill"></span>服务来说明<span class="jill"></span>kubernetes<span class="jill"></span>系统各个组件调用关系：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16421411944631642141194434.png" style="width: 679px"/></figure></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">首先要明确，一旦<span class="jill"></span>kubernetes<span class="jill"></span>环境启动之后，master<span class="jill"></span>和<span class="jill"></span>node<span class="jill"></span>都会将自身的信息存储到<span class="jill"></span>etcd<span class="jill"></span>数据库中</span></li><li><div class="marker"></div><span class="inline-wrap">一个<span class="jill"></span>nginx<span class="jill"></span>服务的安装请求会首先被发送到<span class="jill"></span>master<span class="jill"></span>节点的<span class="jill"></span>apiServer<span class="jill"></span>组件</span></li><li><div class="marker"></div><span class="inline-wrap">apiServer<span class="jill"></span>组件会调用<span class="jill"></span>scheduler<span class="jill"></span>组件来决定到底应该把这个服务安装到哪个<span class="jill"></span>node<span class="jill"></span>节点上</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">在此时，它会从<span class="jill"></span>etcd<span class="jill"></span>中读取各个<span class="jill"></span>node<span class="jill"></span>节点的信息，然后按照一定的算法进行选择，并将结果告知<span class="jill"></span>apiServer</span></div></div></li><li><div class="marker"></div><span class="inline-wrap">apiServer<span class="jill"></span>调用<span class="jill"></span>controller-manager<span class="jill"></span>去调度<span class="jill"></span>Node<span class="jill"></span>节点安装<span class="jill"></span>nginx<span class="jill"></span>服务</span></li><li><div class="marker"></div><span class="inline-wrap">kubelet<span class="jill"></span>接收到指令后，会通知<span class="jill"></span>docker，然后由<span class="jill"></span>docker<span class="jill"></span>来启动一个<span class="jill"></span>nginx<span class="jill"></span>的<span class="jill"></span>pod</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">pod<span class="jill"></span>是<span class="jill"></span>kubernetes<span class="jill"></span>的最小操作单元，容器必须跑在<span class="jill"></span>pod<span class="jill"></span>中至此，</span></div></div></li><li><div class="marker"></div><span class="inline-wrap">一个<span class="jill"></span>nginx<span class="jill"></span>服务就运行了，如果需要访问<span class="jill"></span>nginx，就需要通过<span class="jill"></span>kube-proxy<span class="jill"></span>来对<span class="jill"></span>pod<span class="jill"></span>产生访问的代理</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">这样，外界用户就可以访问集群中的<span class="jill"></span>nginx<span class="jill"></span>服务了</span></div></div><h3 class="wolai-block"><span class="inline-wrap">1.4Kubernetes<span class="jill"></span>概念</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Master</b></span><span class="inline-wrap">：集群控制节点，每个集群需要至少一个<span class="jill"></span>master<span class="jill"></span>节点负责集群的管控</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Node</b></span><span class="inline-wrap">：工作负载节点，由<span class="jill"></span>master<span class="jill"></span>分配容器到这些<span class="jill"></span>node<span class="jill"></span>工作节点上，然后<span class="jill"></span>node<span class="jill"></span>节点上的<span class="jill"></span>docker<span class="jill"></span>负责容器的运行</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Pod</b></span><span class="inline-wrap">：kubernetes<span class="jill"></span>的最小控制单元，容器都是运行在<span class="jill"></span>pod<span class="jill"></span>中的，一个<span class="jill"></span>pod<span class="jill"></span>中可以有<span class="jill"></span>1<span class="jill"></span>个或者多个容器</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Controller</b></span><span class="inline-wrap">：控制器，通过它来实现对<span class="jill"></span>pod<span class="jill"></span>的管理，比如启动<span class="jill"></span>pod、停止<span class="jill"></span>pod、伸缩<span class="jill"></span>pod<span class="jill"></span>的数量等等</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Service</b></span><span class="inline-wrap">：pod<span class="jill"></span>对外服务的统一入口，下面可以维护者同一类的多个<span class="jill"></span>pod</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Label</b></span><span class="inline-wrap">：标签，用于对<span class="jill"></span>pod<span class="jill"></span>进行分类，同一类<span class="jill"></span>pod<span class="jill"></span>会拥有相同的标签</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>NameSpace</b></span><span class="inline-wrap">：命名空间，用来隔离<span class="jill"></span>pod<span class="jill"></span>的运行环境</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16421574776161642157477589.png" style="width: 680px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>概述</code></span><span class="inline-wrap">：Kubernetes<span class="jill"></span>是资源管理器工具，同类将被淘汰的有<span class="jill"></span>MESOS、Docker Swarm</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">MESOS 是 Apache 软件基金会，是一个分式式资源管理框架，在<span class="jill"></span>2019<span class="jill"></span>年 Twitter<span class="jill"></span>公司宣布转向<span class="jill"></span>Kubernetes；  Docker Swarm 2019-07 阿里云宣布,Docker Swarm<span class="jill"></span>构建选项被剔除。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Kubernetes 是<span class="jill"></span>Google<span class="jill"></span>公司采用<span class="jill"></span>Go<span class="jill"></span>语言开发的，“Kubernetes 直接继承自 Borg。 在 Google 的很多从事 Kubernetes 的开发人员以前都是 Borg 项目的开发人员。 我们在 Kubernetes 中结合了 Borg 的最佳创意，并试图解决用户多年来在 Borg 中发现的一些痛点。” </span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Kubernetes<span class="jill"></span>的特点：轻量级（消耗资源小），开源、弹性伸缩、负载均衡（IPVS）；</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">适学人群：软件工程师  测试工程师  运维工程师 软件架构师  项目经理</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>需要掌握的东西</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">介绍说明： 前世今生  Kubernetes<span class="jill"></span>框架   Kubernetes<span class="jill"></span>关键字含义</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">基础概念：什么是<span class="jill"></span>Pod  控制器类型  K8S<span class="jill"></span>网络通讯模式</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Kubernetes：构建<span class="jill"></span>K8S<span class="jill"></span>集群</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">资源清单：资源   掌握资源清单的语法  编写<span class="jill"></span>Pod  掌握<span class="jill"></span>Pod<span class="jill"></span>的生命周期（重要）  </span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Pod<span class="jill"></span>控制器：掌握各种控制器的特点以及使用定义方式</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">服务发现：掌握<span class="jill"></span>SVC<span class="jill"></span>原理及其构建方式</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">存储：掌握多种存储类型的特点并且能够在不同环境中选择合适的存储方案（有自己的见解）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">安全：集群的认证  鉴权  访问控制原理及其流程</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">服务分类： </span></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">有状态服务：比如<span class="jill"></span>DBMS</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">无状态服务：LVS  Apache</span></div></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">HELM: 类似于<span class="jill"></span>Linux yum  掌握<span class="jill"></span>HELM<span class="jill"></span>原理   HELM<span class="jill"></span>模板自定义  HELM<span class="jill"></span>部署一些常用 插件。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">运维：修改<span class="jill"></span>Kubernetes<span class="jill"></span>达到证书可用期限为<span class="jill"></span>10<span class="jill"></span>年  能够构建高可用的<span class="jill"></span>Kubernetes<span class="jill"></span>集群</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>教学资源</code></span><span class="inline-wrap">    链接: </span><span class="inline-wrap"><a href="https://pan.baidu.com/s/1PQp_8gkBhG_pmtB93NcQpg"><span>https://pan.baidu.com/s/1PQp_8gkBhG_pmtB93NcQpg</span></a></span><span class="inline-wrap"> 提取码: nktx </span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Borg<span class="jill"></span>架构</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16416186176051641618617593.png" style="width: 381.3333333333333px"/></figure></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">BorgMaster 是整个集群的大脑，负责维护整个集群的状态，并将数据持久化到 Paxos 存储中；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Scheduer 负责任务的调度，根据应用的特点将其调度到具体的机器上去；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Borglet 负责真正运行任务（在容器中）；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">borgcfg 是 Borg 的命令行工具，用于跟 Borg 系统交互，一般通过一个配置文件来提交任务。</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>K8S<span class="jill"></span>架构</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16416191382071641619138129.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"> Kubernetes 主要由以下几个核心组件组成：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">kube-scheduler 负责资源的调度，按照预定的调度策略将 Pod 调度到相应的机器上；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">kube-apiserver 提供了资源操作的唯一入口，并提供认证、授权、访问控制、API 注册和发现等机制；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">etcd 保存了整个集群的状态(推荐在 Kubernetes<span class="jill"></span>集群中使用、 Etcd v3,  v2<span class="jill"></span>版本已在 Kubernetes v1.11<span class="jill"></span>中弃用)；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">replication 将容器维持在期望值上，多回收，少就创建。新版本的<span class="jill"></span>K8S<span class="jill"></span>使用<span class="jill"></span>ReplicaSet<span class="jill"></span>代替<span class="jill"></span>replication ，区别是<span class="jill"></span>ReplicaSet<span class="jill"></span>支持集合式的<span class="jill"></span>selector。 虽然 ReplicaSe<span class="jill"></span>可以独立使用,但一般还是建议使用 Deployment<span class="jill"></span>来自动管理<span class="jill"></span>ReplicaSe,这样就无需担心跟其他机制的不兼容问题(比如 Replicase<span class="jill"></span>不支持 rolling-update<span class="jill"></span>但 Deployment<span class="jill"></span>支持)</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">kube-controller-manager 负责维护集群的状态，比如故障检测、自动扩展、滚动更新等；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">kubelet 负责维持容器的生命周期，同时也负责 Volume（CVI）和网络（CNI）的管理；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Container runtime 负责镜像管理以及 Pod 和容器的真正运行（CRI），默认的容器运行时为 Docker；</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">kube-proxy 负责为 Service 提供 cluster 内部的服务发现和负载均衡；</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">补充说明：</span></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">高可用集群副本数据最好是=3<span class="jill"></span>奇数个
APIService:所有服务访问统一入口
CrontrollerManager:维持副本期望数目
Scheduler:负责众任务,选择合适的点进行分配任务
ETCD:键值对数据库储存<span class="jill"></span>K8S<span class="jill"></span>集群所有重要信息(持久化)
Kubelet:  直接跟容器引擎交互实现容器的生命周期管理
Kube-proxy:  负责写入规则至工 PTABLES、IPvs<span class="jill"></span>实现服务映射访间的
COREDNS:可以为集群中的<span class="jill"></span>SVC<span class="jill"></span>创建一个域名<span class="jill"></span>IP<span class="jill"></span>的对应关系解析
DASHBOARD:给<span class="jill"></span>K8S<span class="jill"></span>集群提供一个<span class="jill"></span>B/S<span class="jill"></span>结构访炣体系
INGRESS CONTROLLER:官方只能实现四层代理, INGRESS<span class="jill"></span>可以实现大层代理
FEDERATION:提供一个可以跨集群中心多<span class="jill"></span>K8S<span class="jill"></span>统一管理功能
PROME THEUS:提供<span class="jill"></span>K8s<span class="jill"></span>集群的监控能力
ELK:提供<span class="jill"></span>K8S<span class="jill"></span>集群旦志统一分析介入平台</span></div></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Etcd<span class="jill"></span>架构</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16416196702531641619670205.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>pod<span class="jill"></span>间的通信</code></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16417074828361641707482793.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">什么是<span class="jill"></span>Pod：Kubernetes 使用 Pod 来管理容器，每个 Pod 可以包含一个或多个紧密关联的容器。一对多的关系。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Node: Node 是 Pod 真正运行的主机，可以是物理机，也可以是虚拟机，也称为宿主机。为了管理 Pod，每个 Node 节点上至少要运行<span class="jill"></span>docker 、kubelet 服务。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">具体的通信方式：</span><span class="inline-wrap"><a href="https://network.51cto.com/art/202007/620287.htm"><span>https://network.51cto.com/art/202007/620287.htm</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1.3 kubernetes<span class="jill"></span>组件</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h2 class="wolai-block"><span class="inline-wrap">2.1<span class="jill"></span>环境安装</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">下载镜像：</span><span class="inline-wrap"><a href="http://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso"><span>http://mirrors.ustc.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso</span></a></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">安装虚拟机并设置虚拟主机<span class="jill"></span>ip<span class="jill"></span>为静态<span class="jill"></span>ip：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">k8s-master01@192.168.109.100、k8s-node01@192.168.109.101、k8s-node02@192.168.109.102</span></div></div><h3 class="wolai-block"><span class="inline-wrap">2.1 基本环境 （全节点）</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">#以下三条命令分别在对应的机器执行
hostnamectl set-hostname k8s-master
hostnamectl set-hostname k8s-node1
hostnamectl set-hostname k8s-node2</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre>#将下面映射规则加入到hosts文件中
cat <span class="token operator">&lt;&lt;</span><span class="token constant">EOF</span> <span class="token operator">>></span> <span class="token operator">/</span>etc<span class="token operator">/</span>hosts   # 主机名成解析 编辑三台服务器的<span class="token operator">/</span>etc<span class="token operator">/</span>hosts文件，添加下面内容
<span class="token number">192.168</span><span class="token number">.109</span><span class="token number">.100</span> k8s<span class="token operator">-</span>master
<span class="token number">192.168</span><span class="token number">.109</span><span class="token number">.101</span> k8s<span class="token operator">-</span>node01
<span class="token number">192.168</span><span class="token number">.109</span><span class="token number">.102</span> k8s<span class="token operator">-</span>node02
<span class="token constant">EOF</span>
yum install vim wget <span class="token operator">-</span>y    #安装必要软件
cat <span class="token operator">/</span>etc<span class="token operator">/</span>redhat<span class="token operator">-</span>release   #查看版本，版本不要小于Centos <span class="token maybe-class-name">Linux</span> <span class="token number">7.5</span><span class="token number">.1804</span> <span class="token punctuation">(</span><span class="token maybe-class-name">Core</span><span class="token punctuation">)</span> 这个版本

#kubernetes要求集群中的节点时间必须精确一直，这里使用chronyd服务从网络同步时间
systemctl start chronyd
systemctl enable chronyd
yum install ntpdate <span class="token operator">-</span>y
ntpdate ntp<span class="token punctuation">.</span><span class="token property-access">aliyun</span><span class="token punctuation">.</span><span class="token property-access">com</span>
cp <span class="token operator">-</span>f <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>zoneinfo<span class="token operator">/</span><span class="token maybe-class-name">Asia</span><span class="token operator">/</span><span class="token maybe-class-name">Shanghai</span> <span class="token operator">/</span>etc<span class="token operator">/</span>localtime
date
# <span class="token number">1</span> 关闭firewalld服务
systemctl stop firewalld
systemctl disable firewalld
# <span class="token number">2</span> 关闭iptables服务
systemctl stop iptables
systemctl disable iptables
#  禁用selinux：编辑 <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config 文件，修改<span class="token constant">SELINUX</span>的值为disable
sed <span class="token operator">-</span>i <span class="token string">'/SELINUX/s/enforcing/disable/g'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config
#禁用swap：编辑分区配置文件<span class="token operator">/</span>etc<span class="token operator">/</span>fstab，注释掉swap分区一行
sed <span class="token operator">-</span>i <span class="token string">'/swap/s/^\//\#\//'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>fstab
swapoff <span class="token operator">-</span>a  #临时关闭，否则master初始化报错
#修改linux的内核参数
# 修改linux的内核采纳数，添加网桥过滤和地址转发功能
# 编辑<span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span><span class="token property-access">d</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span><span class="token property-access">conf文件，添加如下配置：</span>
cat <span class="token operator">&lt;&lt;</span><span class="token constant">EOF</span> <span class="token operator">></span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span><span class="token property-access">d</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span><span class="token property-access">conf</span>
net<span class="token punctuation">.</span><span class="token property-access">bridge</span><span class="token punctuation">.</span><span class="token property-access">bridge</span><span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>ip6tables <span class="token operator">=</span> <span class="token number">1</span>
net<span class="token punctuation">.</span><span class="token property-access">bridge</span><span class="token punctuation">.</span><span class="token property-access">bridge</span><span class="token operator">-</span>nf<span class="token operator">-</span>call<span class="token operator">-</span>iptables <span class="token operator">=</span> <span class="token number">1</span>
net<span class="token punctuation">.</span><span class="token property-access">ipv4</span><span class="token punctuation">.</span><span class="token property-access">ip_forward</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token constant">EOF</span>
sysctl <span class="token operator">-</span>p  #重新加载
modprobe br_netfilter  # 加载网桥过滤模块
lsmod <span class="token operator">|</span> grep br_netfilter  # 查看网桥过滤模块是否加载成功
# <span class="token number">1.</span>安装ipset和ipvsadm
yum install ipset ipvsadmin <span class="token operator">-</span>y
# <span class="token number">2.</span>添加需要加载的模块写入脚本文件
cat <span class="token operator">&lt;&lt;</span><span class="token constant">EOF</span><span class="token operator">></span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>modules<span class="token operator">/</span>ipvs<span class="token punctuation">.</span><span class="token property-access">modules</span>
#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>bash
modprobe <span class="token operator">--</span> ip_vs
modprobe <span class="token operator">--</span> ip_vs_rr
modprobe <span class="token operator">--</span> ip_vs_wrr
modprobe <span class="token operator">--</span> ip_vs_sh
modprobe <span class="token operator">--</span> nf_conntrack_ipv4
<span class="token constant">EOF</span>
# <span class="token number">3.</span>为脚本添加执行权限
chmod <span class="token operator">+</span>x <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>modules<span class="token operator">/</span>ipvs<span class="token punctuation">.</span><span class="token property-access">modules</span>
# <span class="token number">4.</span>执行脚本文件
<span class="token operator">/</span>bin<span class="token operator">/</span>bash <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>modules<span class="token operator">/</span>ipvs<span class="token punctuation">.</span><span class="token property-access">modules</span>
# <span class="token number">5.</span>查看对应的模块是否加载成功
lsmod <span class="token operator">|</span> grep <span class="token operator">-</span>e ip_vs <span class="token operator">-</span>e nf_conntrack_ipv4
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">2.2 安装<span class="jill"></span>Docker （全节点）</span></h3><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre># <span class="token number">1</span>、切换镜像源
wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span><span class="token property-access">aliyun</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token operator">/</span>linux<span class="token operator">/</span>centos<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span><span class="token property-access">repo</span> <span class="token operator">-</span><span class="token constant">O</span> <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span><span class="token property-access">repos</span><span class="token punctuation">.</span><span class="token property-access">d</span><span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span><span class="token property-access">repo</span>
# <span class="token number">2</span>、查看当前镜像源中支持的docker版本
yum list docker<span class="token operator">-</span>ce <span class="token operator">--</span>showduplicates
# <span class="token number">3</span>、安装特定版本的docker<span class="token operator">-</span>ce
# 必须制定<span class="token operator">--</span>setopt<span class="token operator">=</span>obsoletes<span class="token operator">=</span><span class="token number">0</span>，否则yum会自动安装更高版本
yum install <span class="token operator">--</span>setopt<span class="token operator">=</span>obsoletes<span class="token operator">=</span><span class="token number">0</span> docker<span class="token operator">-</span>ce<span class="token operator">-</span><span class="token number">18.06</span><span class="token number">.3</span><span class="token punctuation">.</span><span class="token property-access">ce</span><span class="token operator">-</span><span class="token number">3.</span>el7 <span class="token operator">-</span>y
# <span class="token number">4</span>、添加一个配置文件
#<span class="token maybe-class-name">Docker</span> 在默认情况下使用Vgroup <span class="token maybe-class-name">Driver为cgroupfs，而Kubernetes推荐使用systemd来替代cgroupfs</span>
mkdir <span class="token operator">/</span>etc<span class="token operator">/</span>docker
cat <span class="token operator">&lt;&lt;</span><span class="token constant">EOF</span><span class="token operator">></span> <span class="token operator">/</span>etc<span class="token operator">/</span>docker<span class="token operator">/</span>daemon<span class="token punctuation">.</span><span class="token property-access">json</span>
<span class="token punctuation">{</span>
  <span class="token string">"exec-opts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"https://kn0t2bca.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">EOF</span>
#启动<span class="token operator">&amp;</span>设置自启动docker
systemctl restart docker
systemctl enable docker

</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">2.3<span class="jill"></span>安装<span class="jill"></span>k8s （全节点）</span></h3><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre># <span class="token number">1</span>、由于kubernetes的镜像在国外，速度比较慢，这里切换成国内的镜像源
cat <span class="token operator">&lt;&lt;</span><span class="token constant">EOF</span> <span class="token operator">></span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">etc</span><span class="token regex-delimiter">/</span><span class="token regex-flags">yum</span></span><span class="token punctuation">.</span><span class="token property-access">repos</span><span class="token punctuation">.</span><span class="token property-access">d</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span><span class="token property-access">repo</span>
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
name<span class="token operator">=</span><span class="token maybe-class-name">Kubernetes</span>
baseurl<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span><span class="token property-access">aliyun</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>repos<span class="token operator">/</span>kubernetes<span class="token operator">-</span>el7<span class="token operator">-</span>x86_64
enabled<span class="token operator">=</span><span class="token number">1</span>
gpgcheck<span class="token operator">=</span><span class="token number">0</span>
repo_gpgcheck<span class="token operator">=</span><span class="token number">0</span>
gpgkey<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span><span class="token property-access">aliyun</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>yum<span class="token operator">-</span>key<span class="token punctuation">.</span><span class="token property-access">gpg</span>
       http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span><span class="token property-access">aliyun</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>kubernetes<span class="token operator">/</span>yum<span class="token operator">/</span>doc<span class="token operator">/</span>rpm<span class="token operator">-</span><span class="token keyword">package</span><span class="token operator">-</span>key<span class="token punctuation">.</span><span class="token property-access">gpg</span>
<span class="token constant">EOF</span>
yum install <span class="token operator">--</span>setopt<span class="token operator">=</span>obsoletes<span class="token operator">=</span><span class="token number">0</span> kubeadm<span class="token operator">-</span><span class="token number">1.17</span><span class="token number">.4</span><span class="token operator">-</span><span class="token number">0</span> kubelet<span class="token operator">-</span><span class="token number">1.17</span><span class="token number">.4</span><span class="token operator">-</span><span class="token number">0</span> kubectl<span class="token operator">-</span><span class="token number">1.17</span><span class="token number">.4</span><span class="token operator">-</span><span class="token number">0</span> <span class="token operator">-</span>y
#编辑<span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>kubelet<span class="token punctuation">,</span> 添加下面的配置
cat <span class="token operator">&lt;&lt;</span><span class="token constant">EOF</span> <span class="token operator">>></span> <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>kubelet
<span class="token constant">KUBELET_CGROUP_ARGS</span><span class="token operator">=</span><span class="token string">"--cgroup-driver=systemd"</span>
<span class="token constant">KUBE_PROXY_MODE</span><span class="token operator">=</span><span class="token string">"ipvs"</span>
<span class="token constant">EOF</span>
# <span class="token number">5</span>、设置kubelet开机自启
systemctl enable kubelet

</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">2.4 master<span class="jill"></span>节点的初始化 （master<span class="jill"></span>节点）</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">查看开机是否自动连接网络：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">nmtui  #进入网络配置</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16457066649591645706663670.png" style="width: 1324px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">reboot  #将主机重启</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">master<span class="jill"></span>的初始化：</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 在安装kubernetes集群之前，必须要提前准备好集群需要的镜像，所需镜像可以通过下面命令查看</span>
kubeadm config images list

<span class="token comment"># 下载镜像</span>
<span class="token comment"># 此镜像kubernetes的仓库中，由于网络原因，无法连接，下面提供了一种替换方案</span>
<span class="token assign-left variable">images</span><span class="token operator">=</span><span class="token punctuation">(</span>
  kube-apiserver:v1.17.4
  kube-controller-manager:v1.17.4
  kube-scheduler:v1.17.4
  kube-proxy:v1.17.4
  pause:3.1
  etcd:3.4.3-0
  coredns:1.6.5
<span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">imageName</span> <span class="token keyword">in</span> <span class="token variable">${images<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
  docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="token variable">$imageName</span>
  docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="token variable">$imageName</span> k8s.gcr.io/<span class="token variable">$imageName</span>
  docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/<span class="token variable">$imageName</span> 
<span class="token keyword">done</span>

<span class="token comment">#查看下载好的镜像</span>
docker images
<span class="token comment">#开始初始化</span>
kubeadm init <span class="token punctuation">\</span>
  --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.109.100 <span class="token punctuation">\</span>
  --kubernetes-version<span class="token operator">=</span>v1.17.4 <span class="token punctuation">\</span>
  --service-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12 <span class="token punctuation">\</span>
  --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 
<span class="token comment">#初始化 ，本质就是安装需要的组件的过程（可能要修改两处，版本与192.168.87.101）,特别感谢:https://blog.csdn.net/weixin_41831919/article/details/119790356</span>
<span class="token comment">#初始化失败？ 运行：</span>
<span class="token comment"># kubeadm reset </span>
<span class="token comment"># rm -rf $HOME/.kube/config  &amp; rm -rf $HOME/.kube; </span>
<span class="token comment"># rm -rf /etc/cni/net.d   &amp; ipvsadm --clear  </span>
<span class="token comment">#再执行初始化命令 </span>
</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">初始化完成后的输出需要保存：</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.109.100:6443 --token fdfhpj.3pb3f3b2a0tzl68s <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:cd7c2b09cf97a1f0083c4463fc51de07957561c43bb99068e89dd658114940a8
</pre></div></code-block></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">      注意其它节点加进来，需要拉取上面的组件，再注册进来。</span></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>images<span class="token operator">=</span><span class="token punctuation">(</span>
  kube<span class="token operator">-</span>apiserver<span class="token operator">:</span>v1<span class="token punctuation">.</span><span class="token number">17.4</span>
  kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager<span class="token operator">:</span>v1<span class="token punctuation">.</span><span class="token number">17.4</span>
  kube<span class="token operator">-</span>scheduler<span class="token operator">:</span>v1<span class="token punctuation">.</span><span class="token number">17.4</span>
  kube<span class="token operator">-</span>proxy<span class="token operator">:</span>v1<span class="token punctuation">.</span><span class="token number">17.4</span>
  pause<span class="token operator">:</span><span class="token number">3.1</span>
  etcd<span class="token operator">:</span><span class="token number">3.4</span><span class="token number">.3</span><span class="token operator">-</span><span class="token number">0</span>
  coredns<span class="token operator">:</span><span class="token number">1.6</span><span class="token number">.5</span>
<span class="token punctuation">)</span>

<span class="token keyword">for</span> imageName in $<span class="token punctuation">{</span>images<span class="token punctuation">[</span>@<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">do</span>
  docker pull registry<span class="token punctuation">.</span>cn<span class="token operator">-</span>hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers<span class="token operator">/</span>$imageName
  docker tag registry<span class="token punctuation">.</span>cn<span class="token operator">-</span>hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers<span class="token operator">/</span>$imageName k8s<span class="token punctuation">.</span>gcr<span class="token punctuation">.</span>io<span class="token operator">/</span>$imageName
  docker rmi registry<span class="token punctuation">.</span>cn<span class="token operator">-</span>hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers<span class="token operator">/</span>$imageName 
done

#然后使用上面的链接注册进来，如果想要在node节点上操作集群，需要执行初始化后的那三个命令</pre></div></code-block></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">解决<span class="jill"></span>NoReady 是因为网络插件还没有安装</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16441258998881644125899132.png" style="width: 756.3333333333334px"/></figure></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>kubectl apply <span class="token operator">-</span>f https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>coreos<span class="token operator">/</span>flannel<span class="token operator">/</span>master<span class="token operator">/</span><span class="token maybe-class-name">Documentation</span><span class="token operator">/</span>kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span><span class="token property-access">yml</span>
##删除插件 kubectl <span class="token keyword">delete</span> <span class="token operator">-</span>f https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span><span class="token property-access">githubusercontent</span><span class="token punctuation">.</span><span class="token property-access">com</span><span class="token operator">/</span>coreos<span class="token operator">/</span>flannel<span class="token operator">/</span>master<span class="token operator">/</span><span class="token maybe-class-name">Documentation</span><span class="token operator">/</span>kube<span class="token operator">-</span>flannel<span class="token punctuation">.</span><span class="token property-access">yml</span>
# kubeadm reset  重置集群环境  
# 参考：https<span class="token operator">:</span><span class="token operator">/</span>blog<span class="token punctuation">.</span><span class="token property-access">csdn</span><span class="token punctuation">.</span><span class="token property-access">net</span><span class="token operator">/</span>qq_43158436<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">108583757</span>
# master 重置环境时要删除一些东西  https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span><span class="token property-access">csdn</span><span class="token punctuation">.</span><span class="token property-access">net</span><span class="token operator">/</span>woay2008<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">93250137</span>
# 重新启动 tgsystemctl restart kubelet
# 参考： https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span><span class="token property-access">csdn</span><span class="token punctuation">.</span><span class="token property-access">net</span><span class="token operator">/</span>qq_41813208<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">108625419</span>       </pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">2.5 集群环境测试</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个<span class="jill"></span>nginx<span class="jill"></span>服务</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#deploy全称是deployment</span>
kubectl create deploy nginx  --image<span class="token operator">=</span>nginx:1.17.1</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">暴露端口</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>kubectl expose deploy nginx  --port<span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">80</span>  --type<span class="token operator">=</span>NodePort</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">查看服务</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>kubectl get pod,svc</pre></div></code-block><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16441491773291644149176984.png" style="width: 683px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">访问：</span><span class="inline-wrap"><a href="http://192.168.109.100:31050/"><span>http://192.168.109.100:31050/</span></a></span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="media/image.png" style="width: 682px"/></figure></div><h2 class="wolai-block"><span class="inline-wrap">3.1 知识混杂</span></h2><h3 class="wolai-block"><span class="inline-wrap">3.1<span class="jill"></span>资源管理介绍</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>kubernetes<span class="jill"></span>中，所有的内容都抽象为资源，用户需要通过操作资源来管理<span class="jill"></span>kubernetes。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">—</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>的本质上就是一个集群系统，用户可以在集群中部署各种服务，所谓的部署服务，其实就是在<span class="jill"></span>kubernetes<span class="jill"></span>集群中运行一个个的容器，并将指定的程序跑在容器中。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>的最小管理单元是<span class="jill"></span>pod<span class="jill"></span>而不是容器，所以只能将容器放在</span><span class="inline-wrap"><code>Pod</code></span><span class="inline-wrap">中，而<span class="jill"></span>kubernetes<span class="jill"></span>一般也不会直接管理<span class="jill"></span>Pod，而是通过</span><span class="inline-wrap"><code>Pod<span class="jill"></span>控制器</code></span><span class="inline-wrap">来管理<span class="jill"></span>Pod<span class="jill"></span>的。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Pod<span class="jill"></span>可以提供服务之后，就要考虑如何访问<span class="jill"></span>Pod<span class="jill"></span>中服务，kubernetes<span class="jill"></span>提供了</span><span class="inline-wrap"><code>Service</code></span><span class="inline-wrap">资源实现这个功能。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">当然，如果<span class="jill"></span>Pod<span class="jill"></span>中程序的数据需要持久化，kubernetes<span class="jill"></span>还提供了各种</span><span class="inline-wrap"><code>存储</code></span><span class="inline-wrap">系统。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">—</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644150951509image-20200406225334627.png" style="width: 675px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">学习<span class="jill"></span>kubernetes<span class="jill"></span>的核心，就是学习如何对集群上的</span><span class="inline-wrap"><code>Pod、Pod<span class="jill"></span>控制器、Service、存储</code></span><span class="inline-wrap">等各种资源进行操作</span></div></div><h3 class="wolai-block"><span class="inline-wrap">3.2 YAML<span class="jill"></span>语言介绍</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">为什么要学，因为要用于配置<span class="jill"></span>Kubernetes</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">YAML<span class="jill"></span>是一个类似 XML、JSON 的标记性语言。</span><span class="red inline-wrap">它强调以</span><span class="red inline-wrap"><b>数据</b></span><span class="red inline-wrap">为中心，并不是以标识语言为重点</span><span class="inline-wrap">。因而<span class="jill"></span>YAML<span class="jill"></span>本身的定义比较简单，号称&quot;一种人性化的数据格式语言&quot;。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="XML" class="marker"></div><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heima</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>age</span><span class="token punctuation">></span></span>15<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>age</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>address</span><span class="token punctuation">></span></span>Beijing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>address</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heima</span><span class="token punctuation">></span></span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">heima</span><span class="token punctuation">:</span>
  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">15</span>
  <span class="token key atrule">address</span><span class="token punctuation">:</span> Beijing</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">YAML<span class="jill"></span>的语法比较简单，主要有下面几个：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">大小写敏感</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">使用缩进表示层级关系</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">缩进不允许使用<span class="jill"></span>tab，只允许空格( 低版本限制 )</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">缩进的空格数不重要，只要相同层级的元素左对齐即可</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">&#39;#&#39;表示注释</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">YAML<span class="jill"></span>支持以下几种数据类型：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">纯量：单个的、不可再分的值</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">对象：键值对的集合，又称为映射（mapping）/ 哈希（hash） / 字典（dictionary）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</span></li></ul><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># 纯量, 就是指的一个简单的值，字符串、布尔值、整数、浮点数、Null、时间、日期</span>
<span class="token comment"># 1 布尔类型</span>
<span class="token key atrule">c1</span><span class="token punctuation">:</span> true (或者True)
<span class="token comment"># 2 整型</span>
<span class="token key atrule">c2</span><span class="token punctuation">:</span> <span class="token number">234</span>
<span class="token comment"># 3 浮点型</span>
<span class="token key atrule">c3</span><span class="token punctuation">:</span> <span class="token number">3.14</span>
<span class="token comment"># 4 null类型 </span>
<span class="token key atrule">c4</span><span class="token punctuation">:</span> <span class="token null important">~</span>  <span class="token comment"># 使用~表示null</span>
<span class="token comment"># 5 日期类型</span>
<span class="token key atrule">c5</span><span class="token punctuation">:</span> <span class="token datetime number">2018-02-17</span>    <span class="token comment"># 日期必须使用ISO 8601格式，即yyyy-MM-dd</span>
<span class="token comment"># 6 时间类型</span>
<span class="token key atrule">c6</span><span class="token punctuation">:</span> <span class="token datetime number">2018-02-17T15:02:31+08:00</span>  <span class="token comment"># 时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</span>
<span class="token comment"># 7 字符串类型</span>
<span class="token key atrule">c7</span><span class="token punctuation">:</span> heima     <span class="token comment"># 简单写法，直接写值 , 如果字符串中间有特殊字符，必须使用双引号或者单引号包裹 </span>
<span class="token key atrule">c8</span><span class="token punctuation">:</span> line1
    line2     <span class="token comment"># 字符串过多的情况可以拆成多行，每一行会被转化成一个空格</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># 对象</span>
<span class="token comment"># 形式一(推荐):</span>
<span class="token key atrule">heima</span><span class="token punctuation">:</span>
  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">15</span>
  <span class="token key atrule">address</span><span class="token punctuation">:</span> Beijing
<span class="token comment"># 形式二(了解):</span>
<span class="token key atrule">heima</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span><span class="token key atrule">address</span><span class="token punctuation">:</span> Beijing<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># 数组</span>
<span class="token comment"># 形式一(推荐):</span>
<span class="token key atrule">address</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> 顺义
  <span class="token punctuation">-</span> 昌平  
<span class="token comment"># 形式二(了解):</span>
<span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>顺义<span class="token punctuation">,</span>昌平<span class="token punctuation">]</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">—</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">小提示：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1 书写<span class="jill"></span>yaml<span class="jill"></span>切记</span><span class="inline-wrap"><code>:</code></span><span class="inline-wrap"> 后面要加一个空格</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2 如果需要将多段<span class="jill"></span>yaml<span class="jill"></span>配置放在一个文件中，中间要使用</span><span class="inline-wrap"><code>---</code></span><span class="inline-wrap">分隔</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3 下面是一个<span class="jill"></span>yaml<span class="jill"></span>转<span class="jill"></span>json<span class="jill"></span>的网站，可以通过它验证<span class="jill"></span>yaml<span class="jill"></span>是否书写正确</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://gitee.com/link?target=https://www.json2yaml.com/convert-yaml-to-json"><span>https://www.json2yaml.com/convert-yaml-to-json</span></a></span></div></div><h3 class="wolai-block"><span class="inline-wrap">3.3  资源管理方式</span></h3><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">命令式对象管理：直接使用命令去操作<span class="jill"></span>kubernetes<span class="jill"></span>资源</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>kubectl run nginx-pod --image<span class="token operator">=</span>nginx:1.17.1 --port<span class="token operator">=</span><span class="token number">80</span></pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">命令式对象配置：通过命令配置和配置文件去操作<span class="jill"></span>kubernetes<span class="jill"></span>资源</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>kubectl create/patch -f nginx-pod.yaml</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">声明式对象配置：通过<span class="jill"></span>apply<span class="jill"></span>命令和配置文件去操作<span class="jill"></span>kubernetes<span class="jill"></span>资源</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>kubectl apply -f nginx-pod.yaml</pre></div></code-block></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 100px"><span class="inline-wrap">类型</span></th><th style="width: 100px"><span class="inline-wrap">操作对象</span></th><th style="width: 100px"><span class="inline-wrap">适用环境</span></th><th style="width: 100px"><span class="inline-wrap">优点</span></th><th style="width: 326px"><span class="inline-wrap">缺点</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">命令式对象管理</span></td><td><span class="inline-wrap">对象</span></td><td><span class="inline-wrap">测试</span></td><td><span class="inline-wrap">简单</span></td><td><span class="inline-wrap">只能操作活动对象，无法审计、跟踪</span></td></tr><tr><td><span class="inline-wrap">命令式对象配置</span></td><td><span class="inline-wrap">文件</span></td><td><span class="inline-wrap">开发</span></td><td><span class="inline-wrap">可以审计、跟踪</span></td><td><span class="inline-wrap">项目大时，配置文件多，操作麻烦</span></td></tr><tr><td><span class="inline-wrap">声明式对象配置</span></td><td><span class="inline-wrap">目录</span></td><td><span class="inline-wrap">开发</span></td><td><span class="inline-wrap">支持目录操作</span></td><td><span class="inline-wrap">意外情况下难以调试</span></td></tr></tbody></table></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">1) 命令式对象管理</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>kubectl<span class="jill"></span>命令</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubectl<span class="jill"></span>是<span class="jill"></span>kubernetes<span class="jill"></span>集群的命令行工具，通过它能够对集群本身进行管理，并能够在集群上进行容器化应用的安装部署。kubectl<span class="jill"></span>命令的语法如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>kubectl <span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">[</span>flags<span class="token punctuation">]</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>comand</b></span><span class="inline-wrap">：指定要对资源执行的操作，例如<span class="jill"></span>create、get、delete</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>type</b></span><span class="inline-wrap">：指定资源类型，比如<span class="jill"></span>deployment、pod、service</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>name</b></span><span class="inline-wrap">：指定资源的名称，名称大小写敏感</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>flags</b></span><span class="inline-wrap">：指定额外的可选参数</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 查看所有pod</span>
kubectl get pod 

<span class="token comment"># 查看某个pod</span>
kubectl get pod pod_name

<span class="token comment"># 查看某个pod,以yaml格式展示结果</span>
kubectl get pod pod_name -o yaml</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>资源类型</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>中所有的内容都抽象为资源，可以通过下面的命令进行查看:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="" class="marker"></div><pre>kubectl api<span class="token operator">-</span>resources</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">经常使用的资源有下面这些：</span></div></div><div class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 160px"><span class="inline-wrap">资源分类</span></th><th style="width: 240px"><span class="inline-wrap">资源名称</span></th><th style="width: 100px"><span class="inline-wrap">缩写</span></th><th style="width: 243px"><span class="inline-wrap">资源作用</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">集群级别资源</span></td><td><span class="inline-wrap">nodes</span></td><td><span class="inline-wrap">no</span></td><td><span class="inline-wrap">集群组成部分</span></td></tr><tr><td><span class="inline-wrap">namespaces</span></td><td><span class="inline-wrap">ns</span></td><td><span class="inline-wrap">隔离<span class="jill"></span>Pod</span></td><td><span class="inline-wrap"></span><br/></td></tr><tr><td><span class="inline-wrap">pod<span class="jill"></span>资源</span></td><td><span class="inline-wrap">pods</span></td><td><span class="inline-wrap">po</span></td><td><span class="inline-wrap">装载容器</span></td></tr><tr><td><span class="inline-wrap">pod<span class="jill"></span>资源控制器</span></td><td><span class="inline-wrap">replicationcontrollers</span></td><td><span class="inline-wrap">rc</span></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">replicasets</span></td><td><span class="inline-wrap">rs</span></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">deployments</span></td><td><span class="inline-wrap">deploy</span></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">daemonsets</span></td><td><span class="inline-wrap">ds</span></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">jobs</span></td><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">cronjobs</span></td><td><span class="inline-wrap">cj</span></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">horizontalpodautoscalers</span></td><td><span class="inline-wrap">hpa</span></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">statefulsets</span></td><td><span class="inline-wrap">sts</span></td><td><span class="inline-wrap">控制<span class="jill"></span>pod<span class="jill"></span>资源</span></td></tr><tr><td><span class="inline-wrap">服务发现资源</span></td><td><span class="inline-wrap">services</span></td><td><span class="inline-wrap">svc</span></td><td><span class="inline-wrap">统一<span class="jill"></span>pod<span class="jill"></span>对外接口</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">ingress</span></td><td><span class="inline-wrap">ing</span></td><td><span class="inline-wrap">统一<span class="jill"></span>pod<span class="jill"></span>对外接口</span></td></tr><tr><td><span class="inline-wrap">存储资源</span></td><td><span class="inline-wrap">volumeattachments</span></td><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">存储</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">persistentvolumes</span></td><td><span class="inline-wrap">pv</span></td><td><span class="inline-wrap">存储</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">persistentvolumeclaims</span></td><td><span class="inline-wrap">pvc</span></td><td><span class="inline-wrap">存储</span></td></tr><tr><td><span class="inline-wrap">配置资源</span></td><td><span class="inline-wrap">configmaps</span></td><td><span class="inline-wrap">cm</span></td><td><span class="inline-wrap">配置</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">secrets</span></td><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">配置</span></td></tr></tbody></table></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>操作</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>允许对资源进行多种操作，可以通过--help<span class="jill"></span>查看详细的操作命令</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="" class="marker"></div><pre>kubectl <span class="token operator">--</span>help</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">经常使用的操作有下面这些：</span></div></div><div class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 100px"><span class="inline-wrap">命令分类</span></th><th style="width: 172px"><span class="inline-wrap">命令</span></th><th style="width: 100px"><span class="inline-wrap">翻译</span></th><th style="width: 381px"><span class="inline-wrap">命令作用</span></th></tr></thead><tbody><tr><td><span class="inline-wrap">基本命令</span></td><td><span class="inline-wrap">create</span></td><td><span class="inline-wrap">创建</span></td><td><span class="inline-wrap">创建一个资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">edit</span></td><td><span class="inline-wrap">编辑</span></td><td><span class="inline-wrap">编辑一个资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">get</span></td><td><span class="inline-wrap">获取</span></td><td><span class="inline-wrap">获取一个资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">patch</span></td><td><span class="inline-wrap">更新</span></td><td><span class="inline-wrap">更新一个资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">delete</span></td><td><span class="inline-wrap">删除</span></td><td><span class="inline-wrap">删除一个资源</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">explain</span></td><td><span class="inline-wrap">解释</span></td><td><span class="inline-wrap">展示资源文档</span></td></tr><tr><td><span class="inline-wrap">运行和调试</span></td><td><span class="inline-wrap">run</span></td><td><span class="inline-wrap">运行</span></td><td><span class="inline-wrap">在集群中运行一个指定的镜像</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">expose</span></td><td><span class="inline-wrap">暴露</span></td><td><span class="inline-wrap">暴露资源为<span class="jill"></span>Service</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">describe</span></td><td><span class="inline-wrap">描述</span></td><td><span class="inline-wrap">显示资源内部信息</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">logs</span></td><td><span class="inline-wrap">日志输出容器在 pod 中的日志</span></td><td><span class="inline-wrap">输出容器在 pod 中的日志</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">attach</span></td><td><span class="inline-wrap">缠绕进入运行中的容器</span></td><td><span class="inline-wrap">进入运行中的容器</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">exec</span></td><td><span class="inline-wrap">执行容器中的一个命令</span></td><td><span class="inline-wrap">执行容器中的一个命令</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">cp</span></td><td><span class="inline-wrap">复制</span></td><td><span class="inline-wrap">在<span class="jill"></span>Pod<span class="jill"></span>内外复制文件</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">rollout</span></td><td><span class="inline-wrap">首次展示</span></td><td><span class="inline-wrap">管理资源的发布</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">scale</span></td><td><span class="inline-wrap">规模</span></td><td><span class="inline-wrap">扩(缩)容<span class="jill"></span>Pod<span class="jill"></span>的数量</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">autoscale</span></td><td><span class="inline-wrap">自动调整</span></td><td><span class="inline-wrap">自动调整<span class="jill"></span>Pod<span class="jill"></span>的数量</span></td></tr><tr><td><span class="inline-wrap">高级命令</span></td><td><span class="inline-wrap">apply</span></td><td><span class="inline-wrap">rc</span></td><td><span class="inline-wrap">通过文件对资源进行配置</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">label</span></td><td><span class="inline-wrap">标签</span></td><td><span class="inline-wrap">更新资源上的标签</span></td></tr><tr><td><span class="inline-wrap">其他命令</span></td><td><span class="inline-wrap">cluster-info</span></td><td><span class="inline-wrap">集群信息</span></td><td><span class="inline-wrap">显示集群信息</span></td></tr><tr><td><span class="inline-wrap"></span><br/></td><td><span class="inline-wrap">version</span></td><td><span class="inline-wrap">版本</span></td><td><span class="inline-wrap">显示当前<span class="jill"></span>Server<span class="jill"></span>和<span class="jill"></span>Client<span class="jill"></span>的版本</span></td></tr></tbody></table></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面以一个<span class="jill"></span>namespace / pod<span class="jill"></span>的创建和删除简单演示下命令的使用：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建一个namespace</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create namespace dev</span>
namespace/dev created

<span class="token comment"># 获取namespace</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns</span>
NAME              STATUS   AGE
default           Active   21h
dev               Active   21s
kube-node-lease   Active   21h
kube-public       Active   21h
kube-system       Active   21h

<span class="token comment"># 在此namespace下创建并运行一个nginx的Pod</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run pod --image=nginx:latest -n dev</span>
kubectl run --generator<span class="token operator">=</span>deployment/apps.v1 is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl run --generator<span class="token operator">=</span>run-pod/v1 or kubectl create instead.
deployment.apps/pod created

<span class="token comment"># 查看新创建的pod</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev</span>
NAME  READY   STATUS    RESTARTS   AGE
pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s

<span class="token comment"># 删除指定的pod</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod pod-864f9875b9-pcw7x</span>
pod <span class="token string">"pod"</span> deleted

<span class="token comment"># 删除指定的namespace</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete ns dev</span>
namespace <span class="token string">"dev"</span> deleted</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">2)  命令式对象配置</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">命令式对象配置就是使用命令配合配置文件一起来操作<span class="jill"></span>kubernetes<span class="jill"></span>资源。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1） 创建一个<span class="jill"></span>nginxpod.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxpod
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>containers
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）执行<span class="jill"></span>create<span class="jill"></span>命令，创建资源：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Powershell" class="marker"></div><pre><span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl create -f nginxpod.yaml</span>
namespace<span class="token operator">/</span>dev created
pod<span class="token operator">/</span>nginxpod created</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">此时发现创建了两个资源对象，分别是<span class="jill"></span>namespace<span class="jill"></span>和<span class="jill"></span>pod</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）执行<span class="jill"></span>get<span class="jill"></span>命令，查看资源：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get -f nginxpod.yaml</span>
NAME            STATUS   AGE
namespace/dev   Active   18s

NAME            READY   STATUS    RESTARTS   AGE
pod/nginxpod    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">这样就显示了两个资源对象的信息</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）执行<span class="jill"></span>delete<span class="jill"></span>命令，删除资源：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f nginxpod.yaml</span>
namespace <span class="token string">"dev"</span> deleted
pod <span class="token string">"nginxpod"</span> deleted</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">此时发现两个资源对象被删除了</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="" class="marker"></div><pre>总结<span class="token operator">:</span>
    命令式对象配置的方式操作资源，可以简单的认为：命令  <span class="token operator">+</span>  yaml配置文件（里面是命令需要的各种参数）</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">3) 声明式对象配置</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">声明式对象配置跟命令式对象配置很相似，但是它只有一个命令<span class="jill"></span>apply。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 首先执行一次kubectl apply -f yaml文件，发现创建了资源</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f nginxpod.yaml</span>
namespace/dev created
pod/nginxpod created

<span class="token comment"># 再次执行一次kubectl apply -f yaml文件，发现说资源没有变动</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f nginxpod.yaml</span>
namespace/dev unchanged
pod/nginxpod unchanged</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">总结:
    其实声明式对象配置就是使用<span class="jill"></span>apply<span class="jill"></span>描述一个资源最终的状态（在<span class="jill"></span>yaml<span class="jill"></span>中定义状态）
    使用<span class="jill"></span>apply<span class="jill"></span>操作资源：
       </span><span class="red inline-wrap"> 如果资源不存在，就创建，相当于 kubectl create
        如果资源已存在，就更新，相当于 kubectl patch</span></div></div><h4 class="wolai-block"><span class="inline-wrap"># 3.3.4 知识扩展</span></h4><blockquote class="wolai-block"><span class="inline-wrap">扩展：可以在<span class="jill"></span>node<span class="jill"></span>节点 运行 kubectl 命令吗 ?</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubectl<span class="jill"></span>的运行是需要进行配置的，它的配置文件是<span class="jill"></span>$HOME/.kube，如果想要在<span class="jill"></span>node<span class="jill"></span>节点运行此命令，需要将<span class="jill"></span>master<span class="jill"></span>上的.kube<span class="jill"></span>文件复制到<span class="jill"></span>node<span class="jill"></span>节点上，即在<span class="jill"></span>master<span class="jill"></span>节点上执行下面操作：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">scp</span>  -r  <span class="token environment constant">HOME</span>/.kube   node1: <span class="token environment constant">HOME</span>/</pre></div></code-block><blockquote class="wolai-block"><span class="inline-wrap">使用推荐: 三种方式应该怎么用 ?</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建/更新资源 使用声明式对象配置 kubectl apply -f XXX.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">删除资源 使用命令式对象配置 kubectl delete -f XXX.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">查询资源 使用命令式对象管理 kubectl get(describe) 资源名称</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token function">scp</span>  -r  <span class="token environment constant">HOME</span>/.kube   node1: <span class="token environment constant">HOME</span>/</pre></div></code-block><blockquote class="wolai-block"><span class="inline-wrap">使用推荐: 三种方式应该怎么用 ?</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建/更新资源 使用声明式对象配置 kubectl apply -f XXX.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">删除资源 使用命令式对象配置 kubectl delete -f XXX.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">查询资源 使用命令式对象管理 kubectl get(describe) 资源名称</span></div></div><h2 class="wolai-block"><span class="inline-wrap">4.1 实战入门</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">本章节将介绍如何在<span class="jill"></span>kubernetes<span class="jill"></span>集群中部署一个<span class="jill"></span>nginx<span class="jill"></span>服务，并且能够对其进行访问。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">4.1 Namespace</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Namespace<span class="jill"></span>是<span class="jill"></span>kubernetes<span class="jill"></span>系统中的一种非常重要资源，它的主要作用是用来实现</span><span class="inline-wrap"><b>多套环境的资源隔离</b></span><span class="inline-wrap">或者</span><span class="inline-wrap"><b>多租户的资源隔离</b></span><span class="inline-wrap">。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">默认情况下，kubernetes<span class="jill"></span>集群中的所有的<span class="jill"></span>Pod<span class="jill"></span>都是可以相互访问的。但是在实际中，可能不想让两个<span class="jill"></span>Pod<span class="jill"></span>之间进行互相的访问，那此时就可以将两个<span class="jill"></span>Pod<span class="jill"></span>划分到不同的<span class="jill"></span>namespace<span class="jill"></span>下。kubernetes<span class="jill"></span>通过将集群内部的资源分配到不同的<span class="jill"></span>Namespace<span class="jill"></span>中，可以形成逻辑上的&quot;组&quot;，以方便不同的组的资源进行隔离使用和管理。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">可以通过<span class="jill"></span>kubernetes<span class="jill"></span>的授权机制，将不同的<span class="jill"></span>namespace<span class="jill"></span>交给不同租户进行管理，这样就实现了多租户的资源隔离。此时还能结合<span class="jill"></span>kubernetes<span class="jill"></span>的资源配额机制，限定不同租户能占用的资源，例如<span class="jill"></span>CPU<span class="jill"></span>使用量、内存使用量等等，来实现租户可用资源的管理。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644157934563image-20200407100850484.png" style="width: 731.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>在集群启动之后，会默认创建几个<span class="jill"></span>namespace</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get namespace</span>
NAME              STATUS   AGE
default           Active   45h     <span class="token comment">#  所有未指定Namespace的对象都会被分配在default命名空间</span>
kube-node-lease   Active   45h     <span class="token comment">#  集群节点之间的心跳维护，v1.13开始引入</span>
kube-public       Active   45h     <span class="token comment">#  此命名空间下的资源可以被所有人访问（包括未认证用户）</span>
kube-system       Active   45h     <span class="token comment">#  所有由Kubernetes系统创建的资源都处于这个命名空间</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面来看<span class="jill"></span>namespace<span class="jill"></span>资源的具体操作：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">1）</span><span class="inline-wrap"><b>查看</b></span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 1 查看所有的ns  命令：kubectl get ns</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns</span>
NAME              STATUS   AGE
default           Active   45h
kube-node-lease   Active   45h
kube-public       Active   45h     
kube-system       Active   45h     

<span class="token comment"># 2 查看指定的ns   命令：kubectl get ns ns名称</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns default</span>
NAME      STATUS   AGE
default   Active   45h

<span class="token comment"># 3 指定输出格式  命令：kubectl get ns ns名称  -o 格式参数</span>
<span class="token comment"># kubernetes支持的格式有很多，比较常见的是wide、json、yaml</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ns default -o yaml</span>
apiVersion: v1
kind: Namespace
metadata:
  creationTimestamp: <span class="token string">"2021-05-08T04:44:16Z"</span>
  name: default
  resourceVersion: <span class="token string">"151"</span>
  selfLink: /api/v1/namespaces/default
  uid: 7405f73a-e486-43d4-9db6-145f1409f090
spec:
  finalizers:
  - kubernetes
status:
  phase: Active
  
<span class="token comment"># 4 查看ns详情  命令：kubectl describe ns ns名称</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ns default</span>
Name:         default
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
Status:       Active  <span class="token comment"># Active 命名空间正在使用中  Terminating 正在删除命名空间</span>

<span class="token comment"># ResourceQuota 针对namespace做的资源限制</span>
<span class="token comment"># LimitRange针对namespace中的每个组件做的资源限制</span>
No resource quota.
No LimitRange resource.</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">2）</span><span class="inline-wrap"><b>创建</b></span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建namespace</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create ns dev</span>
namespace/dev created</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">3）</span><span class="inline-wrap"><b>删除</b></span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 删除namespace</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete ns dev</span>
namespace <span class="token string">"dev"</span> deleted</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap"># </span><span class="inline-wrap"><b>配置方式</b></span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">首先准备一个<span class="jill"></span>yaml<span class="jill"></span>文件：ns-dev.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后就可以执行对应的创建和删除命令了：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建：kubectl create -f ns-dev.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">删除：kubectl delete -f ns-dev.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">4.2 Pod</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Pod<span class="jill"></span>是<span class="jill"></span>kubernetes<span class="jill"></span>集群进行管理的最小单元，程序要运行必须部署在容器中，而容器必须存在于<span class="jill"></span>Pod<span class="jill"></span>中。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Pod<span class="jill"></span>可以认为是容器的封装，一个<span class="jill"></span>Pod<span class="jill"></span>中可以存在一个或者多个容器。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644213515636image-20200407121501907.png" style="width: 576px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>在集群启动之后，集群中的各个组件也都是以<span class="jill"></span>Pod<span class="jill"></span>方式运行的。可以通过下面命令查看：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE
kube-system   coredns-6955765f44-68g6v         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   coredns-6955765f44-cs5r8         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   etcd-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   kube-apiserver-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   kube-controller-manager-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   kube-flannel-ds-amd64-47r25      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   kube-flannel-ds-amd64-ls5lh      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   kube-proxy-685tk                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   kube-proxy-87spt                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h
kube-system   kube-scheduler-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2d1h</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">1) 创建并运行</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>没有提供单独运行<span class="jill"></span>Pod<span class="jill"></span>的命令，都是通过<span class="jill"></span>Pod<span class="jill"></span>控制器来实现的</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 命令格式： kubectl run (pod控制器名称) [参数] </span>
<span class="token comment"># --image  指定Pod的镜像</span>
<span class="token comment"># --port   指定端口</span>
<span class="token comment"># --namespace  指定namespace</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:latest --port=80 --namespace dev </span>
deployment.apps/nginx created</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">2) 查看<span class="jill"></span>pod<span class="jill"></span>信息</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 查看Pod基本信息</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME    READY   STATUS    RESTARTS   AGE
nginx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          43s

<span class="token comment"># 查看Pod的详细信息</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod nginx -n dev</span>
Name:         nginx
Namespace:    dev
Priority:     <span class="token number">0</span>
Node:         node1/192.168.5.4
Start Time:   Wed, 08 May <span class="token number">2021</span> 09:29:24 +0800
Labels:       pod-template-hash<span class="token operator">=</span>5ff7956ff6
              <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
Status:       Running
IP:           <span class="token number">10.244</span>.1.23
IPs:
  IP:           <span class="token number">10.244</span>.1.23
Controlled By:  ReplicaSet/nginx
Containers:
  nginx:
    Container ID:   docker://4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c
    Image:          nginx:latest
    Image ID:       docker-pullable://nginx@sha256:485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7
    Port:           <span class="token number">80</span>/TCP
    Host Port:      <span class="token number">0</span>/TCP
    State:          Running
      Started:      Wed, 08 May <span class="token number">2021</span> 09:30:01 +0800
    Ready:          True
    Restart Count:  <span class="token number">0</span>
    Environment:    <span class="token operator">&lt;</span>none<span class="token operator">></span>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hwvvw <span class="token punctuation">(</span>ro<span class="token punctuation">)</span>
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-hwvvw:
    Type:        Secret <span class="token punctuation">(</span>a volume populated by a Secret<span class="token punctuation">)</span>
    SecretName:  default-token-hwvvw
    Optional:    <span class="token boolean">false</span>
QoS Class:       BestEffort
Node-Selectors:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="token keyword">for</span> 300s
                 node.kubernetes.io/unreachable:NoExecute <span class="token keyword">for</span> 300s
Events:
  Type    Reason     Age        From               Message
  ----    ------     ----       ----               -------
  Normal  Scheduled  <span class="token operator">&lt;</span>unknown<span class="token operator">></span>  default-scheduler  Successfully assigned dev/nginx-5ff7956ff6-fg2db to node1
  Normal  Pulling    4m11s      kubelet, node1     Pulling image <span class="token string">"nginx:latest"</span>
  Normal  Pulled     3m36s      kubelet, node1     Successfully pulled image <span class="token string">"nginx:latest"</span>
  Normal  Created    3m36s      kubelet, node1     Created container nginx
  Normal  Started    3m36s      kubelet, node1     Started container nginx</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">3) 访问<span class="jill"></span>Pod</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 获取podIP</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME    READY   STATUS    RESTARTS   AGE    IP             NODE    <span class="token punctuation">..</span>. 
nginx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          190s   <span class="token number">10.244</span>.1.23   node1   <span class="token punctuation">..</span>.

<span class="token comment">#访问POD</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl http://10.244.1.23:80</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
  <span class="token operator">&lt;</span>title<span class="token operator">></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">></span>
<span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
  <span class="token operator">&lt;</span>p<span class="token operator">></span><span class="token operator">&lt;</span>em<span class="token operator">></span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">></span><span class="token operator">&lt;</span>/p<span class="token operator">></span>
<span class="token operator">&lt;</span>/body<span class="token operator">></span>
<span class="token operator">&lt;</span>/html<span class="token operator">></span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">3) 删除指定<span class="jill"></span>Pod</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 删除指定Pod</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod nginx -n dev</span>
pod <span class="token string">"nginx"</span> deleted

<span class="token comment"># 此时，显示删除Pod成功，但是再查询，发现又新产生了一个 </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME    READY   STATUS    RESTARTS   AGE
nginx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21s

<span class="token comment"># 这是因为当前Pod是由Pod控制器创建的，控制器会监控Pod状况，一旦发现Pod死亡，会立即重建</span>
<span class="token comment"># 此时要想删除Pod，必须删除Pod控制器</span>

<span class="token comment"># 先来查询一下当前namespace下的Pod控制器</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n  dev</span>
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           9m7s

<span class="token comment"># 接下来，删除此PodPod控制器</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deploy nginx -n dev</span>
deployment.apps <span class="token string">"nginx"</span> deleted

<span class="token comment"># 稍等片刻，再查询Pod，发现Pod被删除了</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
No resources found <span class="token keyword">in</span> dev namespace.</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap"># 配置操作</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个<span class="jill"></span>pod-nginx.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后就可以执行对应的创建和删除命令了：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建：kubectl create -f pod-nginx.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">删除：kubectl delete -f pod-nginx.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">4.3 Label</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Label<span class="jill"></span>是<span class="jill"></span>kubernetes<span class="jill"></span>系统中的一个重要概念。它的作用就是在资源上添加标识，用来对它们进行区分和选择。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Label<span class="jill"></span>的特点：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">一个<span class="jill"></span>Label<span class="jill"></span>会以<span class="jill"></span>key/value<span class="jill"></span>键值对的形式附加到各种对象上，如<span class="jill"></span>Node、Pod、Service<span class="jill"></span>等等</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">一个资源对象可以定义任意数量的<span class="jill"></span>Label ，同一个<span class="jill"></span>Label<span class="jill"></span>也可以被添加到任意数量的资源对象上去</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Label<span class="jill"></span>通常在资源对象定义时确定，当然也可以在对象创建后动态添加或者删除</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">可以通过<span class="jill"></span>Label<span class="jill"></span>实现资源的多维度分组，以便灵活、方便地进行资源分配、调度、配置、部署等管理工作。</span></div></div><blockquote class="wolai-block"><span class="inline-wrap">一些常用的<span class="jill"></span>Label 示例如下：

- 版本标签：&quot;version&quot;:&quot;release&quot;, &quot;version&quot;:&quot;stable&quot;......
- 环境标签：&quot;environment&quot;:&quot;dev&quot;，&quot;environment&quot;:&quot;test&quot;，&quot;environment&quot;:&quot;pro&quot;
- 架构标签：&quot;tier&quot;:&quot;frontend&quot;，&quot;tier&quot;:&quot;backend&quot;</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">标签定义完毕之后，还要考虑到标签的选择，这就要使用到<span class="jill"></span>Label Selector，即：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Label<span class="jill"></span>用于给某个资源对象定义标识</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Label Selector<span class="jill"></span>用于查询和筛选拥有某些标签的资源对象</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">当前有两种<span class="jill"></span>Label Selector：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">基于等式的<span class="jill"></span>Label Selector</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">name = slave: 选择所有包含<span class="jill"></span>Label<span class="jill"></span>中<span class="jill"></span>key=&quot;name&quot;且<span class="jill"></span>value=&quot;slave&quot;的对象</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">env != production: 选择所有包括<span class="jill"></span>Label<span class="jill"></span>中的<span class="jill"></span>key=&quot;env&quot;且<span class="jill"></span>value<span class="jill"></span>不等于&quot;production&quot;的对象</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">基于集合的<span class="jill"></span>Label Selector</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">name in (master, slave): 选择所有包含<span class="jill"></span>Label<span class="jill"></span>中的<span class="jill"></span>key=&quot;name&quot;且<span class="jill"></span>value=&quot;master&quot;或&quot;slave&quot;的对象</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">name not in (frontend): 选择所有包含<span class="jill"></span>Label<span class="jill"></span>中的<span class="jill"></span>key=&quot;name&quot;且<span class="jill"></span>value<span class="jill"></span>不等于&quot;frontend&quot;的对象</span></div></div></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">标签的选择条件可以使用多个，此时将多个<span class="jill"></span>Label Selector<span class="jill"></span>进行组合，使用逗号&quot;,&quot;进行分隔即可。例如：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">name=slave，env!=production</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">name not in (frontend)，env!=production</span></div></div><h4 class="wolai-block"><span class="inline-wrap">1）命令方式</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 为pod资源打标签</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label pod nginx-pod version=1.0 -n dev</span>
pod/nginx-pod labeled

<span class="token comment"># 为pod资源更新标签</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label pod nginx-pod version=2.0 -n dev --overwrite</span>
pod/nginx-pod labeled

<span class="token comment"># 查看标签</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod nginx-pod  -n dev --show-labels</span>
NAME        READY   STATUS    RESTARTS   AGE   LABELS
nginx-pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m   <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token number">2.0</span>

<span class="token comment"># 筛选标签</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev -l version=2.0  --show-labels</span>
NAME        READY   STATUS    RESTARTS   AGE   LABELS
nginx-pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17m   <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token number">2.0</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev -l version!=2.0 --show-labels</span>
No resources found <span class="token keyword">in</span> dev namespace.

<span class="token comment">#删除标签</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl label pod nginx-pod version- -n dev</span>
pod/nginx-pod labeled</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">２）配置方式</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.0"</span> 
    <span class="token key atrule">env</span><span class="token punctuation">:</span> <span class="token string">"test"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后就可以执行对应的更新命令了：kubectl apply -f pod-nginx.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">4.4 Deployment</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>kubernetes<span class="jill"></span>中，Pod<span class="jill"></span>是最小的控制单元，但是<span class="jill"></span>kubernetes<span class="jill"></span>很少直接控制<span class="jill"></span>Pod，一般都是通过<span class="jill"></span>Pod<span class="jill"></span>控制器来完成的。Pod<span class="jill"></span>控制器用于<span class="jill"></span>pod<span class="jill"></span>的管理，确保<span class="jill"></span>pod<span class="jill"></span>资源符合预期的状态，当<span class="jill"></span>pod<span class="jill"></span>的资源出现故障时，会尝试进行重启或重建<span class="jill"></span>pod。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>kubernetes<span class="jill"></span>中<span class="jill"></span>Pod<span class="jill"></span>控制器的种类有很多，本章节只介绍一种：Deployment。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644379862731image-20200408193950807.png" style="width: 510px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">1）命令操作</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 命令格式: kubectl create deployment 名称  [参数] </span>
<span class="token comment"># --image  指定pod的镜像</span>
<span class="token comment"># --port   指定端口</span>
  <span class="token comment"># --replicas  指定创建pod数量</span>
<span class="token comment"># --namespace  指定namespace</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:latest --port=80 --replicas=3 -n dev</span>
deployment.apps/nginx created

<span class="token comment"># 查看创建的Pod</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                     READY   STATUS    RESTARTS   AGE
nginx-5ff7956ff6-6k8cb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19s
nginx-5ff7956ff6-jxfjt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19s
nginx-5ff7956ff6-v6jqw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19s

<span class="token comment"># 查看deployment的信息</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n dev</span>
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           2m42s

<span class="token comment"># UP-TO-DATE：成功升级的副本数量</span>
<span class="token comment"># AVAILABLE：可用副本的数量</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n dev -o wide</span>
NAME    READY UP-TO-DATE  AVAILABLE   AGE     CONTAINERS   IMAGES              SELECTOR
nginx   <span class="token number">3</span>/3     <span class="token number">3</span>         <span class="token number">3</span>           2m51s   nginx        nginx:latest        <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx

<span class="token comment"># 查看deployment的详细信息</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe deploy nginx -n dev</span>
Name:                   nginx
Namespace:              dev
CreationTimestamp:      Wed, 08 May <span class="token number">2021</span> <span class="token number">11</span>:14:14 +0800
Labels:                 <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
Annotations:            deployment.kubernetes.io/revision: <span class="token number">1</span>
Selector:               <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
Replicas:               <span class="token number">3</span> desired <span class="token operator">|</span> <span class="token number">3</span> updated <span class="token operator">|</span> <span class="token number">3</span> total <span class="token operator">|</span> <span class="token number">3</span> available <span class="token operator">|</span> <span class="token number">0</span> unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        <span class="token number">0</span>
RollingUpdateStrategy:  <span class="token number">25</span>% max unavailable, <span class="token number">25</span>% max surge
Pod Template:
  Labels:  <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx
  Containers:
   nginx:
    Image:        nginx:latest
    Port:         <span class="token number">80</span>/TCP
    Host Port:    <span class="token number">0</span>/TCP
    Environment:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
    Mounts:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
  Volumes:        <span class="token operator">&lt;</span>none<span class="token operator">></span>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
NewReplicaSet:   nginx-5ff7956ff6 <span class="token punctuation">(</span><span class="token number">3</span>/3 replicas created<span class="token punctuation">)</span>
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  5m43s  deployment-controller  Scaled up replicaset nginx-5ff7956ff6 to <span class="token number">3</span>
  
<span class="token comment"># 删除 </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete deploy nginx -n dev</span>
deployment.apps <span class="token string">"nginx"</span> deleted</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">2）配置操作</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个<span class="jill"></span>deploy-nginx.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后就可以执行对应的创建和删除命令了：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建：kubectl create -f deploy-nginx.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">删除：kubectl delete -f deploy-nginx.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">4.5 Service</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">通过上节课的学习，已经能够利用<span class="jill"></span>Deployment<span class="jill"></span>来创建一组<span class="jill"></span>Pod<span class="jill"></span>来提供具有高可用性的服务。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">虽然每个<span class="jill"></span>Pod<span class="jill"></span>都会分配一个单独的<span class="jill"></span>Pod IP，然而却存在如下两问题：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Pod IP 会随着<span class="jill"></span>Pod<span class="jill"></span>的重建产生变化</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Pod IP 仅仅是集群内可见的虚拟<span class="jill"></span>IP，外部无法访问</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">这样对于访问这个服务带来了难度。因此，kubernetes<span class="jill"></span>设计了<span class="jill"></span>Service<span class="jill"></span>来解决这个问题。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Service<span class="jill"></span>可以看作是一组同类<span class="jill"></span>Pod</span><span class="inline-wrap"><b>对外的访问接口</b></span><span class="inline-wrap">。借助<span class="jill"></span>Service，应用可以方便地实现服务发现和负载均衡。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644379780729image-20200408194716912.png" style="width: 715.3333333333334px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">1）创建集群内部可访问的<span class="jill"></span>Service</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 暴露Service</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev</span>
service/svc-nginx1 exposed

<span class="token comment"># 查看service</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc svc-nginx1 -n dev -o wide</span>
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE     SELECTOR
svc-nginx1   ClusterIP   <span class="token number">10.109</span>.179.231   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP    3m51s   <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx

<span class="token comment"># 这里产生了一个CLUSTER-IP，这就是service的IP，在Service的生命周期中，这个地址是不会变动的</span>
<span class="token comment"># 可以通过这个IP访问当前service对应的POD</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl 10.109.179.231:80</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span>
<span class="token operator">&lt;</span>html<span class="token operator">></span>
<span class="token operator">&lt;</span>head<span class="token operator">></span>
<span class="token operator">&lt;</span>title<span class="token operator">></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">></span>
<span class="token operator">&lt;</span>/head<span class="token operator">></span>
<span class="token operator">&lt;</span>body<span class="token operator">></span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token operator">&lt;</span>/body<span class="token operator">></span>
<span class="token operator">&lt;</span>/html<span class="token operator">></span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">2）创建集群外部也可访问的<span class="jill"></span>Service</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 上面创建的Service的type类型为ClusterIP，这个ip地址只用集群内部可访问</span>
<span class="token comment"># 如果需要创建外部也可以访问的Service，需要修改type为NodePort</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev</span>
service/svc-nginx2 exposed

<span class="token comment"># 此时查看，会发现出现了NodePort类型的Service，而且有一对Port（80:31928/TC）</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc  svc-nginx2  -n dev -o wide</span>
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE    SELECTOR
svc-nginx2    NodePort    <span class="token number">10.100</span>.94.0      <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:31928/TCP   9s     <span class="token assign-left variable">run</span><span class="token operator">=</span>nginx

<span class="token comment"># 接下来就可以通过集群外的主机访问 节点IP:31928访问服务了</span>
<span class="token comment"># 例如在的电脑主机上通过浏览器访问下面的地址</span>
http://192.168.90.100:31928/</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">3）删除<span class="jill"></span>Service</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete svc svc-nginx-1 -n dev </span>
<span class="token function">service</span> <span class="token string">"svc-nginx-1"</span> deleted</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">3）配置方式</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个<span class="jill"></span>svc-nginx.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.109.179.231 <span class="token comment">#固定svc的内网ip</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">然后就可以执行对应的创建和删除命令了：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建：kubectl create -f svc-nginx.yaml</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">删除：kubectl delete -f svc-nginx.yaml</span></div></div><blockquote class="wolai-block"><span class="inline-wrap"><b>小结</b></span><span class="inline-wrap">

至此，已经掌握了<span class="jill"></span>Namespace、Pod、Deployment、Service<span class="jill"></span>资源的基本操作，有了这些操作，就可以在<span class="jill"></span>kubernetes<span class="jill"></span>集群中实现一个服务的简单部署和访问了，但是如果想要更好的使用<span class="jill"></span>kubernetes，就需要深入学习这几种资源的细节和原理。</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h2 class="wolai-block"><span class="inline-wrap">5.1 具体结构说明</span></h2><h3 class="wolai-block"><span class="inline-wrap">5.1 Pod<span class="jill"></span>详解</span></h3><h4 class="wolai-block"><span class="inline-wrap">1）Pod<span class="jill"></span>介绍</span></h4><h4 class="wolai-block"><span class="inline-wrap">2）Pod<span class="jill"></span>结构</span></h4><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644390389832image-20200407121501907-1626781151898.png" style="width: 422px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">每个<span class="jill"></span>Pod<span class="jill"></span>中都可以包含一个或者多个容器，这些容器可以分为两类：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">用户程序所在的容器，数量可多可少</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Pause<span class="jill"></span>容器，这是每个<span class="jill"></span>Pod<span class="jill"></span>都会有的一个</span><span class="inline-wrap"><b>根容器</b></span><span class="inline-wrap">，它的作用有两个：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">可以以它为依据，评估整个<span class="jill"></span>Pod<span class="jill"></span>的健康状态</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">可以在根容器上设置<span class="jill"></span>Ip<span class="jill"></span>地址，其它容器都此<span class="jill"></span>Ip（Pod IP），以实现<span class="jill"></span>Pod<span class="jill"></span>内部的网路通信</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="" class="marker"></div><pre>这里是Pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术来实现，我们当前环境用的是Flannel</pre></div></code-block></li></ul></li></ul><h4 class="wolai-block"><span class="inline-wrap">3）Pod<span class="jill"></span>定义</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面是<span class="jill"></span>Pod<span class="jill"></span>的资源清单：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>apiVersion: v1     <span class="token comment">#必选，版本号，例如v1</span>
kind: Pod       　 <span class="token comment">#必选，资源类型，例如 Pod</span>
metadata:       　 <span class="token comment">#必选，元数据</span>
  name: string     <span class="token comment">#必选，Pod名称</span>
  namespace: string  <span class="token comment">#Pod所属的命名空间,默认为"default"</span>
  labels:       　　  <span class="token comment">#自定义标签列表</span>
    - name: string      　          
spec:  <span class="token comment">#必选，Pod中容器的详细定义</span>
  containers:  <span class="token comment">#必选，Pod中容器列表</span>
  - name: string   <span class="token comment">#必选，容器名称</span>
    image: string  <span class="token comment">#必选，容器的镜像名称</span>
    imagePullPolicy: <span class="token punctuation">[</span> Always<span class="token operator">|</span>Never<span class="token operator">|</span>IfNotPresent <span class="token punctuation">]</span>  <span class="token comment">#获取镜像的策略 </span>
    command: <span class="token punctuation">[</span>string<span class="token punctuation">]</span>   <span class="token comment">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
    args: <span class="token punctuation">[</span>string<span class="token punctuation">]</span>      <span class="token comment">#容器的启动命令参数列表</span>
    workingDir: string  <span class="token comment">#容器的工作目录</span>
    volumeMounts:       <span class="token comment">#挂载到容器内部的存储卷配置</span>
    - name: string      <span class="token comment">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
      mountPath: string <span class="token comment">#存储卷在容器内mount的绝对路径，应少于512字符</span>
      readOnly: boolean <span class="token comment">#是否为只读模式</span>
    ports: <span class="token comment">#需要暴露的端口库号列表</span>
    - name: string        <span class="token comment">#端口的名称</span>
      containerPort: int  <span class="token comment">#容器需要监听的端口号</span>
      hostPort: int       <span class="token comment">#容器所在主机需要监听的端口号，默认与Container相同</span>
      protocol: string    <span class="token comment">#端口协议，支持TCP和UDP，默认TCP</span>
    env:   <span class="token comment">#容器运行前需设置的环境变量列表</span>
    - name: string  <span class="token comment">#环境变量名称</span>
      value: string <span class="token comment">#环境变量的值</span>
    resources: <span class="token comment">#资源限制和请求的设置</span>
      limits:  <span class="token comment">#资源限制的设置</span>
        cpu: string     <span class="token comment">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span>
        memory: string  <span class="token comment">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
      requests: <span class="token comment">#资源请求的设置</span>
        cpu: string    <span class="token comment">#Cpu请求，容器启动的初始可用数量</span>
        memory: string <span class="token comment">#内存请求,容器启动的初始可用数量</span>
    lifecycle: <span class="token comment">#生命周期钩子</span>
        postStart: <span class="token comment">#容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
        preStop: <span class="token comment">#容器终止前执行此钩子,无论结果如何,容器都会终止</span>
    livenessProbe:  <span class="token comment">#对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span>
      exec:       　 <span class="token comment">#对Pod容器内检查方式设置为exec方式</span>
        command: <span class="token punctuation">[</span>string<span class="token punctuation">]</span>  <span class="token comment">#exec方式需要制定的命令或脚本</span>
      httpGet:       <span class="token comment">#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
        path: string
        port: number
        host: string
        scheme: string
        HttpHeaders:
        - name: string
          value: string
      tcpSocket:     <span class="token comment">#对Pod内个容器健康检查方式设置为tcpSocket方式</span>
         port: number
       initialDelaySeconds: <span class="token number">0</span>       <span class="token comment">#容器启动完成后首次探测的时间，单位为秒</span>
       timeoutSeconds: <span class="token number">0</span>    　　    <span class="token comment">#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
       periodSeconds: <span class="token number">0</span>     　　    <span class="token comment">#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
       successThreshold: <span class="token number">0</span>
       failureThreshold: <span class="token number">0</span>
       securityContext:
         privileged: <span class="token boolean">false</span>
  restartPolicy: <span class="token punctuation">[</span>Always <span class="token operator">|</span> Never <span class="token operator">|</span> OnFailure<span class="token punctuation">]</span>  <span class="token comment">#Pod的重启策略</span>
  nodeName: <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token comment">#设置NodeName表示将该Pod调度到指定到名称的node节点上</span>
  nodeSelector: obeject <span class="token comment">#设置NodeSelector表示将该Pod调度到包含这个label的node上</span>
  imagePullSecrets: <span class="token comment">#Pull镜像时使用的secret名称，以key：secretkey格式指定</span>
  - name: string
  hostNetwork: <span class="token boolean">false</span>   <span class="token comment">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
  volumes:   <span class="token comment">#在该pod上定义共享存储卷列表</span>
  - name: string    <span class="token comment">#共享存储卷名称 （volumes类型有很多种）</span>
    emptyDir: <span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token comment">#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
    hostPath: string   <span class="token comment">#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
      path: string      　　        <span class="token comment">#Pod所在宿主机的目录，将被用于同期中mount的目录</span>
    secret:       　　　<span class="token comment">#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
      scretname: string  
      items:     
      - key: string
        path: string
    configMap:         <span class="token comment">#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
      name: string
      items:
      - key: string
        path: string</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#小提示：</span>
<span class="token comment">#   在这里，可通过一个命令来查看每种资源的可配置项</span>
<span class="token comment">#   kubectl explain 资源类型         查看某种资源可以配置的一级属性</span>
<span class="token comment">#   kubectl explain 资源类型.属性     查看属性的子属性</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod</span>
KIND:     Pod
VERSION:  v1
FIELDS:
   apiVersion   <span class="token operator">&lt;</span>string<span class="token operator">></span>
   kind <span class="token operator">&lt;</span>string<span class="token operator">></span>
   metadata     <span class="token operator">&lt;</span>Object<span class="token operator">></span>
   spec <span class="token operator">&lt;</span>Object<span class="token operator">></span>
   status       <span class="token operator">&lt;</span>Object<span class="token operator">></span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.metadata</span>
KIND:     Pod
VERSION:  v1
RESOURCE: metadata <span class="token operator">&lt;</span>Object<span class="token operator">></span>
FIELDS:
   annotations  <span class="token operator">&lt;</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>string<span class="token operator">></span>
   clusterName  <span class="token operator">&lt;</span>string<span class="token operator">></span>
   creationTimestamp    <span class="token operator">&lt;</span>string<span class="token operator">></span>
   deletionGracePeriodSeconds   <span class="token operator">&lt;</span>integer<span class="token operator">></span>
   deletionTimestamp    <span class="token operator">&lt;</span>string<span class="token operator">></span>
   finalizers   <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token operator">></span>
   generateName <span class="token operator">&lt;</span>string<span class="token operator">></span>
   generation   <span class="token operator">&lt;</span>integer<span class="token operator">></span>
   labels       <span class="token operator">&lt;</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>string<span class="token operator">></span>
   managedFields        <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">></span>
   name <span class="token operator">&lt;</span>string<span class="token operator">></span>
   namespace    <span class="token operator">&lt;</span>string<span class="token operator">></span>
   ownerReferences      <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">></span>
   resourceVersion      <span class="token operator">&lt;</span>string<span class="token operator">></span>
   selfLink     <span class="token operator">&lt;</span>string<span class="token operator">></span>
   uid  <span class="token operator">&lt;</span>string<span class="token operator">></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>kubernetes<span class="jill"></span>中基本所有资源的一级属性都是一样的，主要包含<span class="jill"></span>5<span class="jill"></span>部分：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">apiVersion &lt;string&gt; 版本，由<span class="jill"></span>kubernetes<span class="jill"></span>内部定义，版本号必须可以用 kubectl api-versions 查询到</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">kind &lt;string&gt; 类型，由<span class="jill"></span>kubernetes<span class="jill"></span>内部定义，版本号必须可以用 kubectl api-resources 查询到</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">metadata &lt;Object&gt; 元数据，主要是资源标识和说明，常用的有<span class="jill"></span>name、namespace、labels<span class="jill"></span>等</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">spec &lt;Object&gt; 描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">status &lt;Object&gt; 状态信息，里面的内容不需要定义，由<span class="jill"></span>kubernetes<span class="jill"></span>自动生成</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">在上面的属性中，spec<span class="jill"></span>是接下来研究的重点，继续看下它的常见子属性:</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">containers &lt;[]Object&gt; 容器列表，用于定义容器的详细信息</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">nodeName &lt;String&gt; 根据<span class="jill"></span>nodeName<span class="jill"></span>的值将<span class="jill"></span>pod<span class="jill"></span>调度到指定的<span class="jill"></span>Node<span class="jill"></span>节点上</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">nodeSelector &lt;map[]&gt; 根据<span class="jill"></span>NodeSelector<span class="jill"></span>中定义的信息选择将该<span class="jill"></span>Pod<span class="jill"></span>调度到包含这些<span class="jill"></span>label<span class="jill"></span>的<span class="jill"></span>Node 上</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">hostNetwork &lt;boolean&gt; 是否使用主机网络模式，默认为<span class="jill"></span>false，如果设置为<span class="jill"></span>true，表示使用宿主机网络</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">volumes &lt;[]Object&gt; 存储卷，用于定义<span class="jill"></span>Pod<span class="jill"></span>上面挂在的存储信息</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">restartPolicy &lt;string&gt; 重启策略，表示<span class="jill"></span>Pod<span class="jill"></span>在遇到故障的时候的处理策略</span></li></ul><h4 class="wolai-block"><span class="inline-wrap">4）Pod<span class="jill"></span>配置</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">本小节主要来研究</span><span class="inline-wrap"><code>pod.spec.containers</code></span><span class="inline-wrap">属性，这也是<span class="jill"></span>pod<span class="jill"></span>配置中最为关键的一项配置。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers</span>
KIND:     Pod
VERSION:  v1
RESOURCE: containers <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">></span>   <span class="token comment"># 数组，代表可以有多个容器</span>
FIELDS:
   name  <span class="token operator">&lt;</span>string<span class="token operator">></span>     <span class="token comment"># 容器名称</span>
   image <span class="token operator">&lt;</span>string<span class="token operator">></span>     <span class="token comment"># 容器需要的镜像地址</span>
   imagePullPolicy  <span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token comment"># 镜像拉取策略 </span>
   <span class="token builtin class-name">command</span>  <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token operator">></span> <span class="token comment"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
   args     <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token operator">></span> <span class="token comment"># 容器的启动命令需要的参数列表</span>
   <span class="token function">env</span>      <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">></span> <span class="token comment"># 容器环境变量的配置</span>
   ports    <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">></span>     <span class="token comment"># 容器需要暴露的端口号列表</span>
   resources <span class="token operator">&lt;</span>Object<span class="token operator">></span>      <span class="token comment"># 资源限制和资源请求的设置</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">5） 基本配置</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-base.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>base
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> heima
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
</pre></div></code-block><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644390409831image-20210617223823675-1626781695411.png" style="width: 536px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面定义了一个比较简单<span class="jill"></span>Pod<span class="jill"></span>的配置，里面有两个容器：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">nginx：用<span class="jill"></span>1.17.1<span class="jill"></span>版本的<span class="jill"></span>nginx<span class="jill"></span>镜像创建，（nginx<span class="jill"></span>是一个轻量级<span class="jill"></span>web<span class="jill"></span>容器）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">busybox：用<span class="jill"></span>1.30<span class="jill"></span>版本的<span class="jill"></span>busybox<span class="jill"></span>镜像创建，（busybox<span class="jill"></span>是一个小巧的<span class="jill"></span>linux<span class="jill"></span>命令集合）</span></li></ul><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-base.yaml</span>
pod/pod-base created

<span class="token comment"># 查看Pod状况</span>
<span class="token comment"># READY 1/2 : 表示当前Pod中有2个容器，其中1个准备就绪，1个未就绪</span>
<span class="token comment"># RESTARTS  : 重启次数，因为有1个容器故障了，Pod一直在重启试图恢复它</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev</span>
NAME       READY   STATUS    RESTARTS   AGE
pod-base   <span class="token number">1</span>/2     Running   <span class="token number">4</span>          95s

<span class="token comment"># 可以通过describe查看内部的详情</span>
<span class="token comment"># 此时已经运行起来了一个基本的Pod，虽然它暂时有问题</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-base -n dev</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">6）镜像拉取</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-imagepullpolicy.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>imagepullpolicy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 用于设置镜像拉取策略</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
</pre></div></code-block><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644390456831image-20210617223923659.png" style="width: 516px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">imagePullPolicy，用于设置镜像拉取策略，kubernetes<span class="jill"></span>支持配置三种拉取策略：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Always：总是从远程仓库拉取镜像（一直远程下载）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像（本地有就本地 本地没远程下载）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错 （一直使用本地）</span></li></ul><blockquote class="wolai-block"><span class="inline-wrap">默认值说明：

如果镜像<span class="jill"></span>tag<span class="jill"></span>为具体版本号， 默认策略是：IfNotPresent

如果镜像<span class="jill"></span>tag<span class="jill"></span>为：latest（最终版本） ，默认策略是<span class="jill"></span>always</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-imagepullpolicy.yaml</span>
pod/pod-imagepullpolicy created

<span class="token comment"># 查看Pod详情</span>
<span class="token comment"># 此时明显可以看到nginx镜像有一步Pulling image "nginx:1.17.1"的过程</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-imagepullpolicy -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Events:
  Type     Reason     Age               From               Message
  ----     ------     ----              ----               -------
  Normal   Scheduled  <span class="token operator">&lt;</span>unknown<span class="token operator">></span>         default-scheduler  Successfully assigned dev/pod-imagePullPolicy to node1
  Normal   Pulling    32s               kubelet, node1     Pulling image <span class="token string">"nginx:1.17.1"</span>
  Normal   Pulled     26s               kubelet, node1     Successfully pulled image <span class="token string">"nginx:1.17.1"</span>
  Normal   Created    26s               kubelet, node1     Created container nginx
  Normal   Started    25s               kubelet, node1     Started container nginx
  Normal   Pulled     7s <span class="token punctuation">(</span>x3 over 25s<span class="token punctuation">)</span>  kubelet, node1     Container image <span class="token string">"busybox:1.30"</span> already present on machine
  Normal   Created    7s <span class="token punctuation">(</span>x3 over 25s<span class="token punctuation">)</span>  kubelet, node1     Created container busybox
  Normal   Started    7s <span class="token punctuation">(</span>x3 over 25s<span class="token punctuation">)</span>  kubelet, node1     Started container busybox</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">7）启动命令</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在前面的案例中，一直有一个问题没有解决，就是的<span class="jill"></span>busybox<span class="jill"></span>容器一直没有成功运行，那么到底是什么原因导致这个容器的故障呢？</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">原来<span class="jill"></span>busybox<span class="jill"></span>并不是一个程序，而是类似于一个工具类的集合，kubernetes<span class="jill"></span>集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了<span class="jill"></span>command<span class="jill"></span>配置。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-command.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>command
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) >> /tmp/hello.txt; sleep 3; done;"</span><span class="token punctuation">]</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644573078282image-20210617224457945.png" style="width: 616.3333333333333px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">command，用于在<span class="jill"></span>pod<span class="jill"></span>中的容器初始化完毕之后运行一个命令。</span></div></div><blockquote class="wolai-block"><span class="inline-wrap">&gt; /tmp/hello.txt; sleep 3; done; 每隔<span class="jill"></span>3<span class="jill"></span>秒向文件中写入当前时间</span></blockquote><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl create  -f pod-command.yaml</span>
pod/pod-command created

<span class="token comment"># 查看Pod状态</span>
<span class="token comment"># 此时发现两个pod都正常运行了</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-command -n dev</span>
NAME          READY   STATUS   RESTARTS   AGE
pod-command   <span class="token number">2</span>/2     Runing   <span class="token number">0</span>          2s

<span class="token comment"># 进入pod中的busybox容器，查看文件内容</span>
<span class="token comment"># 补充一个命令: kubectl exec pod名称 -c 容器名称 -n 名称空间 -it /bin/sh 在容器内部执行命令</span>
<span class="token comment"># -it 是以交互式执行</span>
<span class="token comment"># 使用这个命令就可以进入某个容器的内部，然后进行相关操作了</span>
<span class="token comment"># 比如，可以查看txt文件的内容</span>
<span class="token punctuation">[</span>root@k8s-master01 pod<span class="token punctuation">]</span><span class="token comment">#  kubectl exec pod-command -c busybox -n dev -it  /bin/sh</span>
/ <span class="token comment"># tail -f /tmp/hello.txt</span>
<span class="token number">14</span>:44:19
<span class="token number">14</span>:44:22
<span class="token number">14</span>:44:25</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="" class="marker"></div><pre>特别说明：
    通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢<span class="token operator">?</span>这其实跟docker有点关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中<span class="token constant">ENTRYPOINT</span>的功能。
 <span class="token number">1</span> 如果command和args均没有写，那么用Dockerfile的配置。
 <span class="token number">2</span> 如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command
 <span class="token number">3</span> 如果command没写，但args写了，那么Dockerfile中配置的<span class="token constant">ENTRYPOINT</span>的命令会被执行，使用当前args的参数
 <span class="token number">4</span> 如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">8）环境变量</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-env.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>env
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do /bin/echo $(date +%T);sleep 60; done;"</span><span class="token punctuation">]</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> <span class="token comment"># 设置环境变量列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"username"</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"admin"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"password"</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"123456"</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">env，环境变量，用于在<span class="jill"></span>pod<span class="jill"></span>中的容器设置环境变量。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-env.yaml</span>
pod/pod-env created

<span class="token comment"># 进入容器，输出环境变量</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec  pod-env -c busybox -n dev -it  /bin/sh</span>
/ <span class="token comment"># echo $username</span>
admin
/ <span class="token comment"># echo $password</span>
<span class="token number">123456</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">这种方式不是很推荐，推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">9）端口设置</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">本小节来介绍容器的端口设置，也就是<span class="jill"></span>containers<span class="jill"></span>的<span class="jill"></span>ports<span class="jill"></span>选项。设置后，master<span class="jill"></span>与<span class="jill"></span>node<span class="jill"></span>都能根据<span class="jill"></span>pod<span class="jill"></span>的<span class="jill"></span>ip 访问到开放端口的容器。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">首先看下<span class="jill"></span>ports<span class="jill"></span>支持的子选项：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers.ports</span>
KIND:     Pod
VERSION:  v1
RESOURCE: ports <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">></span>
FIELDS:
   name         <span class="token operator">&lt;</span>string<span class="token operator">></span>  <span class="token comment"># 端口名称，如果指定，必须保证name在pod中是唯一的    </span>
   containerPort<span class="token operator">&lt;</span>integer<span class="token operator">></span> <span class="token comment"># 容器要监听的端口(0&lt;x&lt;65536)</span>
   hostPort     <span class="token operator">&lt;</span>integer<span class="token operator">></span> <span class="token comment"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本(一般省略) </span>
   hostIP       <span class="token operator">&lt;</span>string<span class="token operator">></span>  <span class="token comment"># 要将外部端口绑定到的主机IP(一般省略)</span>
   protocol     <span class="token operator">&lt;</span>string<span class="token operator">></span>  <span class="token comment"># 端口协议。必须是UDP、TCP或SCTP。默认为“TCP”。</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，编写一个测试案例，创建<span class="jill"></span>pod-ports.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>ports
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 设置容器暴露的端口列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-ports.yaml</span>
pod/pod-ports created

<span class="token comment"># 查看pod</span>
<span class="token comment"># 在下面可以明显看到配置信息</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-ports -n dev -o yaml</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
spec:
  containers:
  - image: nginx:1.17.1
    imagePullPolicy: IfNotPresent
    name: nginx
    ports:
    - containerPort: <span class="token number">80</span>
      name: nginx-port
      protocol: TCP
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">访问容器中的程序需要使用的是</span><span class="inline-wrap"><code>Podip:containerPort</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">10）资源配额</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">容器中的程序要运行，肯定是要占用一定资源的，比如<span class="jill"></span>cpu<span class="jill"></span>和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其它容器无法运行。针对这种情况，kubernetes<span class="jill"></span>提供了对内存和<span class="jill"></span>cpu<span class="jill"></span>的资源进行配额的机制，这种机制主要通过<span class="jill"></span>resources<span class="jill"></span>选项实现，他有两个子选项：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">limits：用于限制运行时容器的</span><span class="inline-wrap"><code>最大占用资源</code></span><span class="inline-wrap">，当容器占用资源超过<span class="jill"></span>limits<span class="jill"></span>时会被终止，并进行重启</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">requests ：用于设置容器需要的</span><span class="inline-wrap"><code>最小资源</code></span><span class="inline-wrap">，如果环境资源不够，容器将无法启动</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">可以通过上面两个选项设置资源的上下限。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，编写一个测试案例，创建<span class="jill"></span>pod-resources.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>resources
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 资源配额</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment"># 限制资源（上限）</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span> <span class="token comment"># CPU限制，单位是core数</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"10Gi"</span> <span class="token comment"># 内存限制</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># 请求资源（下限）</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>  <span class="token comment"># CPU限制，单位是core数</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"10Mi"</span>  <span class="token comment"># 内存限制</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在这对<span class="jill"></span>cpu<span class="jill"></span>和<span class="jill"></span>memory<span class="jill"></span>的单位做一个说明：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">cpu：core<span class="jill"></span>数，可以为整数或小数</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">memory： 内存大小，可以使用<span class="jill"></span>Gi、Mi、G、M<span class="jill"></span>等形式</span></li></ul><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 运行Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create  -f pod-resources.yaml</span>
pod/pod-resources created

<span class="token comment"># 查看发现pod运行正常</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-resources -n dev</span>
NAME            READY   STATUS    RESTARTS   AGE  
pod-resources   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          39s   

<span class="token comment"># 接下来，停止Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete  -f pod-resources.yaml</span>
pod <span class="token string">"pod-resources"</span> deleted

<span class="token comment"># 编辑pod，修改resources.requests.memory的值为10Gi</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-resources.yaml</span>

<span class="token comment"># 再次启动pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create  -f pod-resources.yaml</span>
pod/pod-resources created

<span class="token comment"># 查看Pod状态，发现Pod启动失败</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-resources -n dev -o wide</span>
NAME            READY   STATUS    RESTARTS   AGE          
pod-resources   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          20s    

<span class="token comment"># 查看pod详情会发现，如下提示</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-resources -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Warning  FailedScheduling  35s   default-scheduler  <span class="token number">0</span>/3 nodes are available: <span class="token number">1</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> had taint <span class="token punctuation">{</span>node-role.kubernetes.io/master: <span class="token punctuation">}</span>, that the pod didn't tolerate, <span class="token number">2</span> Insufficient memory.<span class="token punctuation">(</span>内存不足<span class="token punctuation">)</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">11）Pod<span class="jill"></span>生命周期</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">我们一般将<span class="jill"></span>pod<span class="jill"></span>对象从创建至终的这段时间范围称为<span class="jill"></span>pod<span class="jill"></span>的生命周期，它主要包含下面的过程：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">pod<span class="jill"></span>创建过程</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">运行初始化容器（init container）过程</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">运行主容器（main container）</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">容器启动后钩子（post start）、容器终止前钩子（pre stop）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">pod<span class="jill"></span>终止过程</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644646042548image-20200412111402706-1626782188724.png" style="width: 702px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在整个生命周期中，Pod<span class="jill"></span>会出现<span class="jill"></span>5<span class="jill"></span>种</span><span class="inline-wrap"><b>状态</b></span><span class="inline-wrap">（</span><span class="inline-wrap"><b>相位</b></span><span class="inline-wrap">），分别如下：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">挂起（Pending）：apiserver<span class="jill"></span>已经创建了<span class="jill"></span>pod<span class="jill"></span>资源对象，但它尚未被调度完成或者仍处于下载镜像的过程中</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">运行中（Running）：pod<span class="jill"></span>已经被调度至某节点，并且所有容器都已经被<span class="jill"></span>kubelet<span class="jill"></span>创建完成</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">成功（Succeeded）：pod<span class="jill"></span>中的所有容器都已经成功终止并且不会被重启</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非<span class="jill"></span>0<span class="jill"></span>值的退出状态</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">未知（Unknown）：apiserver<span class="jill"></span>无法正常获取到<span class="jill"></span>pod<span class="jill"></span>对象的状态信息，通常由网络通信失败所导致</span></li></ul><h4 class="wolai-block"><span class="inline-wrap">12）创建和终止</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>pod<span class="jill"></span>的创建过程</b></span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">用户通过<span class="jill"></span>kubectl<span class="jill"></span>或其他<span class="jill"></span>api<span class="jill"></span>客户端提交需要创建的<span class="jill"></span>pod<span class="jill"></span>信息给<span class="jill"></span>apiServer</span></li><li><div class="marker"></div><span class="inline-wrap">apiServer<span class="jill"></span>开始生成<span class="jill"></span>pod<span class="jill"></span>对象的信息，并将信息存入<span class="jill"></span>etcd，然后返回确认信息至客户端</span></li><li><div class="marker"></div><span class="inline-wrap">apiServer<span class="jill"></span>开始反映<span class="jill"></span>etcd<span class="jill"></span>中的<span class="jill"></span>pod<span class="jill"></span>对象的变化，其它组件使用<span class="jill"></span>watch<span class="jill"></span>机制来跟踪检查<span class="jill"></span>apiServer<span class="jill"></span>上的变动</span></li><li><div class="marker"></div><span class="inline-wrap">scheduler<span class="jill"></span>发现有新的<span class="jill"></span>pod<span class="jill"></span>对象要创建，开始为<span class="jill"></span>Pod<span class="jill"></span>分配主机并将结果信息更新至<span class="jill"></span>apiServer （scheduler<span class="jill"></span>为<span class="jill"></span>pod<span class="jill"></span>分配 node）</span></li><li><div class="marker"></div><span class="inline-wrap">node<span class="jill"></span>节点上的<span class="jill"></span>kubelet<span class="jill"></span>发现有<span class="jill"></span>pod<span class="jill"></span>调度过来，尝试调用<span class="jill"></span>docker<span class="jill"></span>启动容器，并将结果回送至<span class="jill"></span>apiServer </span></li><li><div class="marker"></div><span class="inline-wrap">apiServer<span class="jill"></span>将接收到的<span class="jill"></span>pod<span class="jill"></span>状态信息存入<span class="jill"></span>etcd<span class="jill"></span>中</span><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644645990476image-20200406184656917-1626782168787.png" style="width: 760px"/></figure></div></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>pod<span class="jill"></span>的终止过程</b></span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">用户向<span class="jill"></span>apiServer<span class="jill"></span>发送删除<span class="jill"></span>pod<span class="jill"></span>对象的命令</span></li><li><div class="marker"></div><span class="inline-wrap">apiServcer<span class="jill"></span>中的<span class="jill"></span>pod<span class="jill"></span>对象信息会随着时间的推移而更新，在宽限期内（默认<span class="jill"></span>30s），pod<span class="jill"></span>被视为<span class="jill"></span>dead</span></li><li><div class="marker"></div><span class="inline-wrap">将<span class="jill"></span>pod<span class="jill"></span>标记为<span class="jill"></span>terminating<span class="jill"></span>状态</span></li><li><div class="marker"></div><span class="inline-wrap">kubelet<span class="jill"></span>在监控到<span class="jill"></span>pod<span class="jill"></span>对象转为<span class="jill"></span>terminating<span class="jill"></span>状态的同时启动<span class="jill"></span>pod<span class="jill"></span>关闭过程</span></li><li><div class="marker"></div><span class="inline-wrap">端点控制器监控到<span class="jill"></span>pod<span class="jill"></span>对象的关闭行为时将其从所有匹配到此端点的</span><span class="inline-wrap"><code>service<span class="jill"></span>资源的端点列表中移除</code></span></li><li><div class="marker"></div><span class="inline-wrap">如果当前<span class="jill"></span>pod<span class="jill"></span>对象定义了<span class="jill"></span>preStop<span class="jill"></span>钩子处理器，则在其标记为<span class="jill"></span>terminating<span class="jill"></span>后即会以同步的方式启动执行</span></li><li><div class="marker"></div><span class="inline-wrap">pod<span class="jill"></span>对象中的容器进程收到停止信号</span></li><li><div class="marker"></div><span class="inline-wrap">宽限期结束后，若<span class="jill"></span>pod<span class="jill"></span>中还存在仍在运行的进程，那么<span class="jill"></span>pod<span class="jill"></span>对象会收到立即终止的信号</span></li><li><div class="marker"></div><span class="inline-wrap">kubelet<span class="jill"></span>请求<span class="jill"></span>apiServer<span class="jill"></span>将此<span class="jill"></span>pod<span class="jill"></span>资源的宽限期设置为<span class="jill"></span>0<span class="jill"></span>从而完成删除操作，此时<span class="jill"></span>pod<span class="jill"></span>对于用户已不可见</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">13）初始化容器</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">初始化容器是在<span class="jill"></span>pod<span class="jill"></span>的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么<span class="jill"></span>kubernetes<span class="jill"></span>需要重启它直到成功完成</span></li><li><div class="marker"></div><span class="inline-wrap">初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">初始化容器有很多的应用场景，下面列出的是最常见的几个：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">提供主容器镜像中不具备的工具程序或自定义代码</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来做一个案例，模拟下面这个需求：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">假设要以主容器来运行<span class="jill"></span>nginx，但是要求在运行<span class="jill"></span>nginx<span class="jill"></span>之前先要能够连接上<span class="jill"></span>mysql<span class="jill"></span>和<span class="jill"></span>redis<span class="jill"></span>所在服务器</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">为了简化测试，事先规定好<span class="jill"></span>mysql</span><span class="inline-wrap"><code>(192.168.90.14)</code></span><span class="inline-wrap">和<span class="jill"></span>redis</span><span class="inline-wrap"><code>(192.168.90.15)</code></span><span class="inline-wrap">服务器的地址</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-initcontainer.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>initcontainer
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>container
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>mysql
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'until ping 192.168.90.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;'</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>redis
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'until ping 192.168.90.15 -c 1 ; do echo waiting for reids...; sleep 2; done;'</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-initcontainer.yaml</span>
pod/pod-initcontainer created

<span class="token comment"># 查看pod状态</span>
<span class="token comment"># 发现pod卡在启动第一个初始化容器过程中，后面的容器不会运行</span>
root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod  pod-initcontainer -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  49s   default-scheduler  Successfully assigned dev/pod-initcontainer to node1
  Normal  Pulled     48s   kubelet, node1     Container image <span class="token string">"busybox:1.30"</span> already present on machine
  Normal  Created    48s   kubelet, node1     Created container test-mysql
  Normal  Started    48s   kubelet, node1     Started container test-mysql

<span class="token comment"># 动态查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-initcontainer -n dev -w</span>
NAME                             READY   STATUS     RESTARTS   AGE
pod-initcontainer                <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          15s
pod-initcontainer                <span class="token number">0</span>/1     Init:1/2   <span class="token number">0</span>          52s
pod-initcontainer                <span class="token number">0</span>/1     Init:1/2   <span class="token number">0</span>          53s
pod-initcontainer                <span class="token number">0</span>/1     PodInitializing   <span class="token number">0</span>          89s
pod-initcontainer                <span class="token number">1</span>/1     Running           <span class="token number">0</span>          90s

<span class="token comment"># 接下来新开一个shell，为当前服务器新增两个ip，观察pod的变化</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ifconfig ens33:1 192.168.90.14 netmask 255.255.255.0 up</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ifconfig ens33:2 192.168.90.15 netmask 255.255.255.0 up</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">14）钩子函数</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>在主容器的启动之后和停止之前提供了两个钩子函数：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">post start：</span><span class="inline-wrap"><code>容器创建之后</code></span><span class="inline-wrap">执行，如果失败了会重启容器</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">pre stop ：</span><span class="inline-wrap"><code>容器终止之前</code></span><span class="inline-wrap">执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">钩子处理器支持使用下面三种方式定义动作：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Exec<span class="jill"></span>命令：在容器内执行一次命令</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre>……
  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
    <span class="token key atrule">postStart</span><span class="token punctuation">:</span> 
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cat
        <span class="token punctuation">-</span> /tmp/healthy
……</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">TCPSocket：在当前容器尝试访问指定的<span class="jill"></span>socket</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre>……      
  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
    <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
……</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">HTTPGet：在当前容器中向某<span class="jill"></span>url<span class="jill"></span>发起<span class="jill"></span>http<span class="jill"></span>请求</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre>……
  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
    <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI地址</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.5.3 <span class="token comment">#主机地址</span>
        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http或者https</span>
……</pre></div></code-block></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，以<span class="jill"></span>exec<span class="jill"></span>方式为例，演示下钩子函数的使用，创建<span class="jill"></span>pod-hook-exec.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>exec
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>container
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span> 
        <span class="token key atrule">exec</span><span class="token punctuation">:</span> <span class="token comment"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo postStart... > /usr/share/nginx/html/index.html"</span><span class="token punctuation">]</span>
      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span> <span class="token comment"># 在容器停止之前停止nginx服务</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/usr/sbin/nginx"</span><span class="token punctuation">,</span><span class="token string">"-s"</span><span class="token punctuation">,</span><span class="token string">"quit"</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-hook-exec.yaml</span>
pod/pod-hook-exec created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods  pod-hook-exec -n dev -o wide</span>
NAME           READY   STATUS     RESTARTS   AGE    IP            NODE    
pod-hook-exec  <span class="token number">1</span>/1     Running    <span class="token number">0</span>          29s    <span class="token number">10.244</span>.2.48   node2   

<span class="token comment"># 访问pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.48</span>
postStart<span class="token punctuation">..</span>.</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">15）容器探测</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么<span class="jill"></span>kubernetes<span class="jill"></span>就会把该问题实例&quot; 摘除 &quot;，不承担业务流量。kubernetes<span class="jill"></span>提供了两种探针来实现容器探测，分别是：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">liveness probes：存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s<span class="jill"></span>会重启容器</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">readiness probes：就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s<span class="jill"></span>不会转发流量</span></li></ul><blockquote class="wolai-block"><span class="red inline-wrap">livenessProbe 决定是否重启容器，readinessProbe 决定是否将请求转发给容器。</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面两种探针目前均支持三种探测方式 (</span><span class="red inline-wrap">注意<span class="jill"></span>http，如果有<span class="jill"></span>host<span class="jill"></span>是<span class="jill"></span>127.0.0.1<span class="jill"></span>最好忽略<span class="jill"></span>host<span class="jill"></span>不写，否则不行</span><span class="inline-wrap">)：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Exec<span class="jill"></span>命令：在容器内执行一次命令，如果命令执行的退出码为<span class="jill"></span>0，则认为程序正常，否则不正常</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre>……
  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> cat
      <span class="token punctuation">-</span> /tmp/healthy
……</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">TCPSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre>……      
  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
    <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
……</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">HTTPGet：调用容器内<span class="jill"></span>Web<span class="jill"></span>应用的<span class="jill"></span>URL，如果返回的状态码在<span class="jill"></span>200<span class="jill"></span>和<span class="jill"></span>399<span class="jill"></span>之间，则认为程序正常，否则不正常</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre>……
  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
    <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI地址</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1 <span class="token comment">#主机地址</span>
      <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http或者https</span>
……</pre></div></code-block></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面以<span class="jill"></span>liveness probes<span class="jill"></span>为例，做几个演示：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>方式一：Exec</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-liveness-exec.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>exec
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/cat"</span><span class="token punctuation">,</span><span class="token string">"/tmp/hello.txt"</span><span class="token punctuation">]</span> <span class="token comment"># 执行一个查看文件的命令</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod，观察效果</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-liveness-exec.yaml</span>
pod/pod-liveness-exec created

<span class="token comment"># 查看Pod详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-liveness-exec -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
  Normal   Created    20s <span class="token punctuation">(</span>x2 over 50s<span class="token punctuation">)</span>  kubelet, node1     Created container nginx
  Normal   Started    20s <span class="token punctuation">(</span>x2 over 50s<span class="token punctuation">)</span>  kubelet, node1     Started container nginx
  Normal   Killing    20s                kubelet, node1     Container nginx failed liveness probe, will be restarted
  Warning  Unhealthy  0s <span class="token punctuation">(</span>x5 over 40s<span class="token punctuation">)</span>   kubelet, node1     Liveness probe failed: cat: can<span class="token string">'t open '</span>/tmp/hello11.txt': No such <span class="token function">file</span> or directory
  
<span class="token comment"># 观察上面的信息就会发现nginx容器启动之后就进行了健康检查</span>
<span class="token comment"># 检查失败之后，容器被kill掉，然后尝试进行重启（这是重启策略的作用，后面讲解）</span>
<span class="token comment"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-liveness-exec -n dev</span>
NAME                READY   STATUS             RESTARTS   AGE
pod-liveness-exec   <span class="token number">0</span>/1     CrashLoopBackOff   <span class="token number">2</span>          3m19s

<span class="token comment"># 当然接下来，可以修改成一个存在的文件，比如/tmp/hello.txt，再试，结果就正常了......</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>方式二：TCPSocket</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-liveness-tcpsocket.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>tcpsocket
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment"># 尝试访问8080端口</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod，观察效果</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-liveness-tcpsocket.yaml</span>
pod/pod-liveness-tcpsocket created

<span class="token comment"># 查看Pod详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-liveness-tcpsocket -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
  Normal   Scheduled  31s                            default-scheduler  Successfully assigned dev/pod-liveness-tcpsocket to node2
  Normal   Pulled     <span class="token operator">&lt;</span>invalid<span class="token operator">></span>                      kubelet, node2     Container image <span class="token string">"nginx:1.17.1"</span> already present on machine
  Normal   Created    <span class="token operator">&lt;</span>invalid<span class="token operator">></span>                      kubelet, node2     Created container nginx
  Normal   Started    <span class="token operator">&lt;</span>invalid<span class="token operator">></span>                      kubelet, node2     Started container nginx
  Warning  Unhealthy  <span class="token operator">&lt;</span>invalid<span class="token operator">></span> <span class="token punctuation">(</span>x2 over <span class="token operator">&lt;</span>invalid<span class="token operator">></span><span class="token punctuation">)</span>  kubelet, node2     Liveness probe failed: dial tcp <span class="token number">10.244</span>.2.44:8080: connect: connection refused
  
<span class="token comment"># 观察上面的信息，发现尝试访问8080端口,但是失败了</span>
<span class="token comment"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-liveness-tcpsocket  -n dev</span>
NAME                     READY   STATUS             RESTARTS   AGE
pod-liveness-tcpsocket   <span class="token number">0</span>/1     CrashLoopBackOff   <span class="token number">2</span>          3m19s

<span class="token comment"># 当然接下来，可以修改成一个可以访问的端口，比如80，再试，结果就正常了......</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>方式三：HTTPGet</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-liveness-httpget.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>httpget
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>  <span class="token comment"># 其实就是访问http://127.0.0.1:80/hello  </span>
        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http或者https</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /hello <span class="token comment">#URI地址</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod，观察效果</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-liveness-httpget.yaml</span>
pod/pod-liveness-httpget created

<span class="token comment"># 查看Pod详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-liveness-httpget -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
  Normal   Pulled     6s <span class="token punctuation">(</span>x3 over 64s<span class="token punctuation">)</span>  kubelet, node1     Container image <span class="token string">"nginx:1.17.1"</span> already present on machine
  Normal   Created    6s <span class="token punctuation">(</span>x3 over 64s<span class="token punctuation">)</span>  kubelet, node1     Created container nginx
  Normal   Started    6s <span class="token punctuation">(</span>x3 over 63s<span class="token punctuation">)</span>  kubelet, node1     Started container nginx
  Warning  Unhealthy  6s <span class="token punctuation">(</span>x6 over 56s<span class="token punctuation">)</span>  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: <span class="token number">404</span>
  Normal   Killing    6s <span class="token punctuation">(</span>x2 over 36s<span class="token punctuation">)</span>  kubelet, node1     Container nginx failed liveness probe, will be restarted
  
<span class="token comment"># 观察上面信息，尝试访问路径，但是未找到,出现404错误</span>
<span class="token comment"># 稍等一会之后，再观察pod信息，就可以看到RESTARTS不再是0，而是一直增长</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-liveness-httpget -n dev</span>
NAME                   READY   STATUS    RESTARTS   AGE
pod-liveness-httpget   <span class="token number">1</span>/1     Running   <span class="token number">5</span>          3m17s

<span class="token comment"># 当然接下来，可以修改成一个可以访问的路径path，比如/，再试，结果就正常了......</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">至此，已经使用<span class="jill"></span>liveness Probe<span class="jill"></span>演示了三种探测方式，但是查看<span class="jill"></span>livenessProbe<span class="jill"></span>的</span><span class="inline-wrap"><code>子属性</code></span><span class="inline-wrap">，会发现除了这三种方式，还有一些其他的配置，在这里一并解释下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers.livenessProbe</span>
FIELDS:
   <span class="token builtin class-name">exec</span> <span class="token operator">&lt;</span>Object<span class="token operator">></span>  
   tcpSocket    <span class="token operator">&lt;</span>Object<span class="token operator">></span>
   httpGet      <span class="token operator">&lt;</span>Object<span class="token operator">></span>
   initialDelaySeconds  <span class="token operator">&lt;</span>integer<span class="token operator">></span>  <span class="token comment"># 容器启动后等待多少秒执行第一次探测</span>
   timeoutSeconds       <span class="token operator">&lt;</span>integer<span class="token operator">></span>  <span class="token comment"># 探测超时时间。默认1秒，最小1秒</span>
   periodSeconds        <span class="token operator">&lt;</span>integer<span class="token operator">></span>  <span class="token comment"># 执行探测的频率。默认是10秒，最小1秒</span>
   failureThreshold     <span class="token operator">&lt;</span>integer<span class="token operator">></span>  <span class="token comment"># 连续探测失败多少次才被认定为失败。默认是3。最小值是1</span>
   successThreshold     <span class="token operator">&lt;</span>integer<span class="token operator">></span>  <span class="token comment"># 连续探测成功多少次才被认定为成功。默认是1</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面稍微配置两个，演示下效果即可：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master01 ~<span class="token punctuation">]</span><span class="token comment"># more pod-liveness-httpget.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>httpget
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> 
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment"># 容器启动后30s开始探测</span>
      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 探测超时时间为5s</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">16）重启策略</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在上一节中，一旦容器探测出现了问题，kubernetes<span class="jill"></span>就会对容器所在的<span class="jill"></span>Pod<span class="jill"></span>进行重启，其实这是由<span class="jill"></span>pod<span class="jill"></span>的重启策略决定的，pod<span class="jill"></span>的重启策略有 3 种，分别如下：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Always ：容器失效时，自动重启该容器，这也是默认值。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">OnFailure ： 容器终止运行且退出码不为<span class="jill"></span>0<span class="jill"></span>时重启</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Never ： 不论状态为何，都不重启该容器</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">重启策略适用于<span class="jill"></span>pod<span class="jill"></span>对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由<span class="jill"></span>kubelet<span class="jill"></span>延迟一段时间后进行，且反复的重启操作的延迟时长以此为<span class="jill"></span>10s、20s、40s、80s、160s<span class="jill"></span>和<span class="jill"></span>300s，300s<span class="jill"></span>是最大延迟时长。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-restartpolicy.yaml：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restartpolicy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /hello
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 设置重启策略为Never</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">运行<span class="jill"></span>Pod<span class="jill"></span>测试</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-restartpolicy.yaml</span>
pod/pod-restartpolicy created

<span class="token comment"># 查看Pod详情，发现nginx容器失败</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  describe pods pod-restartpolicy  -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
  Warning  Unhealthy  15s <span class="token punctuation">(</span>x3 over 35s<span class="token punctuation">)</span>  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: <span class="token number">404</span>
  Normal   Killing    15s                kubelet, node1     Container nginx failed liveness probe
  
<span class="token comment"># 多等一会，再观察pod的重启次数，发现一直是0，并未重启   </span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get pods pod-restartpolicy -n dev</span>
NAME                   READY   STATUS    RESTARTS   AGE
pod-restartpolicy      <span class="token number">0</span>/1     Running   <span class="token number">0</span>          5min42s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">17）Pod<span class="jill"></span>调度</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在默认情况下，一个<span class="jill"></span>Pod<span class="jill"></span>在哪个<span class="jill"></span>Node<span class="jill"></span>节点上运行，是由<span class="jill"></span>Scheduler<span class="jill"></span>组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足的需求，因为很多情况下，我们想控制某些<span class="jill"></span>Pod<span class="jill"></span>到达某些节点上，那么应该怎么做呢？这就要求了解<span class="jill"></span>kubernetes<span class="jill"></span>对<span class="jill"></span>Pod<span class="jill"></span>的调度规则，kubernetes<span class="jill"></span>提供了四大类调度方式：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">自动调度：运行在哪个节点上完全由<span class="jill"></span>Scheduler<span class="jill"></span>经过一系列的算法计算得出</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">定向调度：NodeName、NodeSelector</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">污点（容忍）调度：Taints、Toleration</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——定向调度</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">定向调度，指的是利用在<span class="jill"></span>pod<span class="jill"></span>上声明<span class="jill"></span>nodeName<span class="jill"></span>或者<span class="jill"></span>nodeSelector，以此将<span class="jill"></span>Pod<span class="jill"></span>调度到期望的<span class="jill"></span>node<span class="jill"></span>节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标<span class="jill"></span>Node<span class="jill"></span>不存在，也会向上面进行调度，只不过<span class="jill"></span>pod<span class="jill"></span>运行失败而已。（</span><span class="inline-wrap"><code>强制调度在某个节点上</code></span><span class="inline-wrap">）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>NodeName</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">NodeName<span class="jill"></span>用于强制约束将<span class="jill"></span>Pod<span class="jill"></span>调度到指定的<span class="jill"></span>Name<span class="jill"></span>的<span class="jill"></span>Node<span class="jill"></span>节点上。这种方式，其实是直接跳过<span class="jill"></span>Scheduler<span class="jill"></span>的调度逻辑，直接将<span class="jill"></span>Pod<span class="jill"></span>调度到指定名称的节点。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，实验一下：创建一个<span class="jill"></span>pod-nodename.yaml<span class="jill"></span>文件</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodename
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node1 <span class="token comment"># 指定调度到node1节点上</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodename.yaml</span>
pod/pod-nodename created

<span class="token comment">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodename -n dev -o wide</span>
NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
pod-nodename   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          56s   <span class="token number">10.244</span>.1.87   node1     <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>   

<span class="token comment"># 接下来，删除pod，修改nodeName的值为node3（并没有node3节点）</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pod-nodename.yaml</span>
pod <span class="token string">"pod-nodename"</span> deleted
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-nodename.yaml</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodename.yaml</span>
pod/pod-nodename created

<span class="token comment">#再次查看，发现已经向Node3节点调度，但是由于不存在node3节点，所以pod无法正常运行</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodename -n dev -o wide</span>
NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
pod-nodename   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          6s    <span class="token operator">&lt;</span>none<span class="token operator">></span>   node3   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>           </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>NodeSelector</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">NodeSelector<span class="jill"></span>用于将<span class="jill"></span>pod<span class="jill"></span>调度到添加了指定标签的<span class="jill"></span>node<span class="jill"></span>节点上。它是通过<span class="jill"></span>kubernetes<span class="jill"></span>的<span class="jill"></span>label-selector<span class="jill"></span>机制实现的，也就是说，在<span class="jill"></span>pod<span class="jill"></span>创建之前，会由<span class="jill"></span>scheduler<span class="jill"></span>使用<span class="jill"></span>MatchNodeSelector<span class="jill"></span>调度策略进行<span class="jill"></span>label<span class="jill"></span>匹配，找出目标<span class="jill"></span>node，然后将<span class="jill"></span>pod<span class="jill"></span>调度到目标节点，该匹配规则是强制约束。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，实验一下：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1 首先分别为<span class="jill"></span>node<span class="jill"></span>节点添加标签</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label nodes node1 nodeenv=pro</span>
node/node2 labeled
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl label nodes node2 nodeenv=test</span>
node/node2 labeled</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2 创建一个<span class="jill"></span>pod-nodeselector.yaml<span class="jill"></span>文件，并使用它创建<span class="jill"></span>Pod</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeselector
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> 
    <span class="token key atrule">nodeenv</span><span class="token punctuation">:</span> pro <span class="token comment"># 指定调度到具有nodeenv=pro标签的节点上</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment">#创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeselector.yaml</span>
pod/pod-nodeselector created

<span class="token comment">#查看Pod调度到NODE属性，确实是调度到了node1节点上</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodeselector -n dev -o wide</span>
NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
pod-nodeselector   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s   <span class="token number">10.244</span>.1.87   node1   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># 接下来，删除pod，修改nodeSelector的值为nodeenv: xxxx（不存在打有此标签的节点）</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pod-nodeselector.yaml</span>
pod <span class="token string">"pod-nodeselector"</span> deleted
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-nodeselector.yaml</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeselector.yaml</span>
pod/pod-nodeselector created

<span class="token comment">#再次查看，发现pod无法正常运行,Node的值为none</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME               READY   STATUS    RESTARTS   AGE     IP       NODE    
pod-nodeselector   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          2m20s   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>

<span class="token comment"># 查看详情,发现node selector匹配失败的提示</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-nodeselector -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
Events:
  Type     Reason            Age        From               Message
  ----     ------            ----       ----               -------
  Warning  FailedScheduling  <span class="token operator">&lt;</span>unknown<span class="token operator">></span>  default-scheduler  <span class="token number">0</span>/3 nodes are available: <span class="token number">3</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn't match node selector.</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——node<span class="jill"></span>亲和性调度</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的<span class="jill"></span>Node，那么<span class="jill"></span>Pod<span class="jill"></span>将不会被运行，即使在集群中还有可用<span class="jill"></span>Node<span class="jill"></span>列表也不行，这就限制了它的使用场景。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">基于上面的问题，kubernetes<span class="jill"></span>还提供了一种亲和性调度（Affinity）。它在<span class="jill"></span>NodeSelector<span class="jill"></span>的基础之上的进行了扩展，可以通过配置的形式，实现优先选择满足条件的<span class="jill"></span>Node<span class="jill"></span>进行调度，如果没有，也可以调度到不满足条件的节点上，使调度更加灵活。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Affinity<span class="jill"></span>主要分为三类：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">nodeAffinity(node<span class="jill"></span>亲和性）: 以<span class="jill"></span>node<span class="jill"></span>为目标，解决<span class="jill"></span>pod<span class="jill"></span>可以调度到哪些<span class="jill"></span>node<span class="jill"></span>的问题，同时又有硬软限制区别，硬限制是一定要匹配，放在该<span class="jill"></span>node<span class="jill"></span>上。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">podAffinity(pod<span class="jill"></span>亲和性) : 以<span class="jill"></span>pod<span class="jill"></span>为目标，解决<span class="jill"></span>pod<span class="jill"></span>可以和哪些已存在的<span class="jill"></span>pod<span class="jill"></span>部署在同一个拓扑域中的问题</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">podAntiAffinity(pod<span class="jill"></span>反亲和性) : 以<span class="jill"></span>pod<span class="jill"></span>为目标，解决<span class="jill"></span>pod<span class="jill"></span>不能和哪些已存在<span class="jill"></span>pod<span class="jill"></span>部署在同一个拓扑域中的问题</span></li></ul><blockquote class="wolai-block"><span class="inline-wrap">关于亲和性(反亲和性)使用场景的说明：

</span><span class="inline-wrap"><b>亲和性</b></span><span class="inline-wrap">：如果两个应用频繁交互，那就有必要利用亲和性让两个应用的尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。

</span><span class="inline-wrap"><b>反亲和性</b></span><span class="inline-wrap">：当应用的采用多副本部署时，有必要采用反亲和性让各个应用实例打散分布在各个<span class="jill"></span>node<span class="jill"></span>上，这样可以提高服务的高可用性。</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>NodeAffinity</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">首先来看一下</span><span class="inline-wrap"><code>NodeAffinity</code></span><span class="inline-wrap">的可配置项：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Markdown" class="marker"></div><pre>pod.spec.affinity.nodeAffinity
  requiredDuringSchedulingIgnoredDuringExecution  Node节点必须满足指定的所有规则才可以，相当于硬限制
    nodeSelectorTerms  节点选择列表
      matchFields   按节点字段列出的节点选择器要求列表
      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)
        key    键
        values 值
        operat or 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt
  preferredDuringSchedulingIgnoredDuringExecution 优先调度到满足指定的规则的Node，相当于软限制 (倾向)
    preference   一个节点选择器项，与相应的权重相关联
      matchFields   按节点字段列出的节点选择器要求列表
      matchExpressions   按节点标签列出的节点选择器要求列表(推荐)
        key    键
        values 值
        operator 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt
  weight 倾向权重，在范围1-100。</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>关系符的使用说明:

- matchExpressions:
  - key: nodeenv              <span class="token comment"># 匹配存在标签的key为nodeenv的节点</span>
    operator: Exists
  - key: nodeenv              <span class="token comment"># 匹配标签的key为nodeenv,且value是"xxx"或"yyy"的节点</span>
    operator: In
    values: <span class="token punctuation">[</span><span class="token string">"xxx"</span>,<span class="token string">"yyy"</span><span class="token punctuation">]</span>
  - key: nodeenv              <span class="token comment"># 匹配标签的key为nodeenv,且value大于"xxx"的节点</span>
    operator: Gt
    values: <span class="token string">"xxx"</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来首先演示一下</span><span class="inline-wrap"><code>requiredDuringSchedulingIgnoredDuringExecution</code></span><span class="inline-wrap"> ,</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-nodeaffinity-required.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置node亲和性</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配env的值在["xxx","yyy"]中的标签</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"xxx"</span><span class="token punctuation">,</span><span class="token string">"yyy"</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeaffinity-required.yaml</span>
pod/pod-nodeaffinity-required created

<span class="token comment"># 查看pod状态 （运行失败）</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span>
NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> 
pod-nodeaffinity-required   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          16s   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># 查看Pod的详情</span>
<span class="token comment"># 发现调度失败，提示node选择失败</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-nodeaffinity-required -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
  Warning  FailedScheduling  <span class="token operator">&lt;</span>unknown<span class="token operator">></span>  default-scheduler  <span class="token number">0</span>/3 nodes are available: <span class="token number">3</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match node selector.
  Warning  FailedScheduling  &lt;unknown>  default-scheduler  0/3 nodes are available: 3 node(s) didn'</span>t match node selector.

<span class="token comment">#接下来，停止pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pod-nodeaffinity-required.yaml</span>
pod <span class="token string">"pod-nodeaffinity-required"</span> deleted

<span class="token comment"># 修改文件，将values: ["xxx","yyy"]------> ["pro","yyy"]</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-nodeaffinity-required.yaml</span>

<span class="token comment"># 再次启动</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeaffinity-required.yaml</span>
pod/pod-nodeaffinity-required created

<span class="token comment"># 此时查看，发现调度成功，已经将pod调度到了node1上</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span>
NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> 
pod-nodeaffinity-required   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11s   <span class="token number">10.244</span>.1.89   node1 <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来再演示一下</span><span class="inline-wrap"><code>requiredDuringSchedulingIgnoredDuringExecution</code></span><span class="inline-wrap"> ,</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-nodeaffinity-preferred.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>preferred
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置node亲和性</span>
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 软限制</span>
      <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">preference</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配env的值在["xxx","yyy"]中的标签(当前环境没有)</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"xxx"</span><span class="token punctuation">,</span><span class="token string">"yyy"</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-nodeaffinity-preferred.yaml</span>
pod/pod-nodeaffinity-preferred created

<span class="token comment"># 查看pod状态 （运行成功）</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodeaffinity-preferred -n dev</span>
NAME                         READY   STATUS    RESTARTS   AGE
pod-nodeaffinity-preferred   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          40s</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="" class="marker"></div><pre><span class="token maybe-class-name">NodeAffinity规则设置的注意事项：</span>
    <span class="token number">1</span> 如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都得到满足，Pod才能运行在指定的Node上
    <span class="token number">2</span> 如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可
    <span class="token number">3</span> 如果一个nodeSelectorTerms中有多个matchExpressions ，则一个节点必须满足所有的才能匹配成功
    <span class="token number">4</span> 如果一个pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的节点亲和性需求，则系统将忽略此变化</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——pode<span class="jill"></span>亲和性调度</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PodAffinity</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">PodAffinity<span class="jill"></span>主要实现以运行的<span class="jill"></span>Pod<span class="jill"></span>为参照，实现让新创建的<span class="jill"></span>Pod<span class="jill"></span>跟参照<span class="jill"></span>pod<span class="jill"></span>在一个区域的功能。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">首先来看一下</span><span class="inline-wrap"><code>PodAffinity</code></span><span class="inline-wrap">的可配置项：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Markdown" class="marker"></div><pre>pod.spec.affinity.podAffinity
  requiredDuringSchedulingIgnoredDuringExecution  硬限制
    namespaces       指定参照pod的namespace
    topologyKey      指定调度作用域
    labelSelector    标签选择器
      matchExpressions  按节点标签列出的节点选择器要求列表(推荐)
        key    键
        values 值
        operator 关系符 支持In, NotIn, Exists, DoesNotExist.
      matchLabels    指多个matchExpressions映射的内容
  preferredDuringSchedulingIgnoredDuringExecution 软限制
    podAffinityTerm  选项
      namespaces      
      topologyKey
      labelSelector
        matchExpressions  
          key    键
          values 值
          operator
        matchLabels 
    weight 倾向权重，在范围1-100</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Markdown" class="marker"></div><pre>topologyKey用于指定调度时作用域,例如:
    如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围
  如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，演示下</span><span class="inline-wrap"><code>requiredDuringSchedulingIgnoredDuringExecution</code></span><span class="inline-wrap">,</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）首先创建一个参照<span class="jill"></span>Pod，pod-podaffinity-target.yaml：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>target
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">podenv</span><span class="token punctuation">:</span> pro <span class="token comment">#设置标签</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node1 <span class="token comment"># 将目标pod名确指定到node1上</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 启动目标pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podaffinity-target.yaml</span>
pod/pod-podaffinity-target created

<span class="token comment"># 查看pod状况</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods  pod-podaffinity-target -n dev</span>
NAME                     READY   STATUS    RESTARTS   AGE
pod-podaffinity-target   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）创建<span class="jill"></span>pod-podaffinity-required.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span>
    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置pod亲和性</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span>
      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配env的值在["xxx","yyy"]中的标签</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"xxx"</span><span class="token punctuation">,</span><span class="token string">"yyy"</span><span class="token punctuation">]</span>
        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面配置表达的意思是：新<span class="jill"></span>Pod<span class="jill"></span>必须要与拥有标签<span class="jill"></span>nodeenv=xxx<span class="jill"></span>或者<span class="jill"></span>nodeenv=yyy<span class="jill"></span>的<span class="jill"></span>pod<span class="jill"></span>在同一<span class="jill"></span>Node<span class="jill"></span>上，显然现在没有这样<span class="jill"></span>pod，接下来，运行测试一下。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 启动pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podaffinity-required.yaml</span>
pod/pod-podaffinity-required created

<span class="token comment"># 查看pod状态，发现未运行</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-podaffinity-required -n dev</span>
NAME                       READY   STATUS    RESTARTS   AGE
pod-podaffinity-required   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          9s

<span class="token comment"># 查看详细信息</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe pods pod-podaffinity-required  -n dev</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Events:
  Type     Reason            Age        From               Message
  ----     ------            ----       ----               -------
  Warning  FailedScheduling  <span class="token operator">&lt;</span>unknown<span class="token operator">></span>  default-scheduler  <span class="token number">0</span>/3 nodes are available: <span class="token number">2</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match pod affinity rules, 1 node(s) had taints that the pod didn'</span>t tolerate.

<span class="token comment"># 接下来修改  values: ["xxx","yyy"]----->values:["pro","yyy"]</span>
<span class="token comment"># 意思是：新Pod必须要与拥有标签nodeenv=xxx或者nodeenv=yyy的pod在同一Node上</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># vim pod-podaffinity-required.yaml</span>

<span class="token comment"># 然后重新创建pod，查看效果</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f  pod-podaffinity-required.yaml</span>
pod <span class="token string">"pod-podaffinity-required"</span> de leted
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podaffinity-required.yaml</span>
pod/pod-podaffinity-required created

<span class="token comment"># 发现此时Pod运行正常</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-podaffinity-required -n dev</span>
NAME                       READY   STATUS    RESTARTS   AGE   LABELS
pod-podaffinity-required   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s    <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">关于</span><span class="inline-wrap"><code>PodAffinity</code></span><span class="inline-wrap">的 </span><span class="inline-wrap"><code>preferredDuringSchedulingIgnoredDuringExecution</code></span><span class="inline-wrap">，这里不再演示。</span></div></div><h4 class="wolai-block"><span class="inline-wrap">——反<span class="jill"></span>pod<span class="jill"></span>亲和性</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PodAntiAffinity</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">PodAntiAffinity<span class="jill"></span>主要实现以运行的<span class="jill"></span>Pod<span class="jill"></span>为参照，让新创建的<span class="jill"></span>Pod<span class="jill"></span>跟参照<span class="jill"></span>pod<span class="jill"></span>不在一个区域中的功能。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">它的配置方式和选项跟<span class="jill"></span>PodAffinty<span class="jill"></span>是一样的，这里不再做详细解释，直接做一个测试案例。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）继续使用上个案例中目标<span class="jill"></span>pod</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide --show-labels</span>
NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS
pod-podaffinity-required <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m29s   <span class="token number">10.244</span>.1.38   node1   <span class="token operator">&lt;</span>none<span class="token operator">></span>     
pod-podaffinity-target   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9m25s   <span class="token number">10.244</span>.1.37   node1   <span class="token assign-left variable">podenv</span><span class="token operator">=</span>pro</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）创建<span class="jill"></span>pod-podantiaffinity-required.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podantiaffinity<span class="token punctuation">-</span>required
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span>  <span class="token comment">#亲和性设置</span>
    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span> <span class="token comment">#设置pod亲和性</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span>
      <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 匹配podenv的值在["pro"]中的标签</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv
            <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
            <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pro"</span><span class="token punctuation">]</span>
        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面配置表达的意思是：新<span class="jill"></span>Pod<span class="jill"></span>必须要与拥有标签<span class="jill"></span>nodeenv=pro<span class="jill"></span>的<span class="jill"></span>pod<span class="jill"></span>不在同一<span class="jill"></span>Node<span class="jill"></span>上，运行测试一下。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podantiaffinity-required.yaml</span>
pod/pod-podantiaffinity-required created

<span class="token comment"># 查看pod</span>
<span class="token comment"># 发现调度到了node2上</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods pod-podantiaffinity-required -n dev -o wide</span>
NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   <span class="token punctuation">..</span> 
pod-podantiaffinity-required   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          30s   <span class="token number">10.244</span>.1.96   node2  <span class="token punctuation">..</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">污点和容忍</span></h4><h4 class="wolai-block"><span class="inline-wrap">——</span><span class="inline-wrap"><b>污点（Taints）</b></span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">前面的调度方式都是站在<span class="jill"></span>Pod<span class="jill"></span>的角度上，通过在<span class="jill"></span>Pod<span class="jill"></span>上添加属性，来确定<span class="jill"></span>Pod<span class="jill"></span>是否要调度到指定的<span class="jill"></span>Node<span class="jill"></span>上，其实我们也可以站在<span class="jill"></span>Node<span class="jill"></span>的角度上，通过在<span class="jill"></span>Node<span class="jill"></span>上添加</span><span class="inline-wrap"><b>污点</b></span><span class="inline-wrap">属性，来决定是否允许<span class="jill"></span>Pod<span class="jill"></span>调度过来。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">#</span><span class="red inline-wrap">master<span class="jill"></span>节点默认是有<span class="jill"></span>NoExecute<span class="jill"></span>污点的，不允许普通 pod 调度到<span class="jill"></span>master<span class="jill"></span>节点上。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Node<span class="jill"></span>被设置上污点之后就和<span class="jill"></span>Pod<span class="jill"></span>之间存在了一种相斥的关系，进而拒绝<span class="jill"></span>Pod<span class="jill"></span>调度进来，甚至可以将已经存在的<span class="jill"></span>Pod<span class="jill"></span>驱逐出去。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">污点的格式为：</span><span class="inline-wrap"><code>key=value:effect</code></span><span class="inline-wrap">, key<span class="jill"></span>和<span class="jill"></span>value<span class="jill"></span>是污点的标签，effect<span class="jill"></span>描述污点的作用，支持如下三个选项：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">PreferNoSchedule：kubernetes<span class="jill"></span>将尽量避免把<span class="jill"></span>Pod<span class="jill"></span>调度到具有该污点的<span class="jill"></span>Node<span class="jill"></span>上，除非没有其他节点可调度</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">NoSchedule：kubernetes<span class="jill"></span>将不会把<span class="jill"></span>Pod<span class="jill"></span>调度到具有该污点的<span class="jill"></span>Node<span class="jill"></span>上，但不会影响当前<span class="jill"></span>Node<span class="jill"></span>上已存在的<span class="jill"></span>Pod</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">NoExecute：kubernetes<span class="jill"></span>将不会把<span class="jill"></span>Pod<span class="jill"></span>调度到具有该污点的<span class="jill"></span>Node<span class="jill"></span>上，同时也会将<span class="jill"></span>Node<span class="jill"></span>上已存在的<span class="jill"></span>Pod<span class="jill"></span>驱离</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644909481411image-20200605021831545.png" style="width: 636.3333333333333px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用<span class="jill"></span>kubectl<span class="jill"></span>设置和去除污点的命令示例如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 设置污点</span>
kubectl taint nodes node1 <span class="token assign-left variable">key</span><span class="token operator">=</span>value:effect

<span class="token comment"># 去除污点</span>
kubectl taint nodes node1 key:effect-

<span class="token comment"># 去除所有污点</span>
kubectl taint nodes node1 key-</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，演示下污点的效果：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">准备节点<span class="jill"></span>node1（为了演示效果更加明显，暂时停止<span class="jill"></span>node2<span class="jill"></span>节点）</span></li><li><div class="marker"></div><span class="inline-wrap">为<span class="jill"></span>node1<span class="jill"></span>节点设置一个污点: </span><span class="inline-wrap"><code>tag=heima:PreferNoSchedule</code></span><span class="inline-wrap">；然后创建<span class="jill"></span>pod1( pod1 可以 )</span></li><li><div class="marker"></div><span class="inline-wrap">修改为<span class="jill"></span>node1<span class="jill"></span>节点设置一个污点: </span><span class="inline-wrap"><code>tag=heima:NoSchedule</code></span><span class="inline-wrap">；然后创建<span class="jill"></span>pod2( pod1 正常 pod2 失败 )</span></li><li><div class="marker"></div><span class="inline-wrap">修改为<span class="jill"></span>node1<span class="jill"></span>节点设置一个污点: </span><span class="inline-wrap"><code>tag=heima:NoExecute</code></span><span class="inline-wrap">；然后创建<span class="jill"></span>pod3 ( 3<span class="jill"></span>个<span class="jill"></span>pod<span class="jill"></span>都失败 )</span></li></ol><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 为node1设置污点(PreferNoSchedule)</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag=heima:PreferNoSchedule</span>

<span class="token comment"># 创建pod1</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run taint1 --image=nginx:1.17.1 -n dev</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE   
taint1-7665f7fd85-574h4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m24s   <span class="token number">10.244</span>.1.59   node1    

<span class="token comment"># 为node1设置污点(取消PreferNoSchedule，设置NoSchedule)</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag:PreferNoSchedule-</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag=heima:NoSchedule</span>

<span class="token comment"># 创建pod2</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run taint2 --image=nginx:1.17.1 -n dev</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods taint2 -n dev -o wide</span>
NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE
taint1-7665f7fd85-574h4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m24s   <span class="token number">10.244</span>.1.59   node1 
taint2-544694789-6zmlf    <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          21s     <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token operator">&lt;</span>none<span class="token operator">></span>   

<span class="token comment"># 为node1设置污点(取消NoSchedule，设置NoExecute)</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag:NoSchedule-</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl taint nodes node1 tag=heima:NoExecute</span>

<span class="token comment"># 创建pod3</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl run taint3 --image=nginx:1.17.1 -n dev</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME                      READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED 
taint1-7665f7fd85-htkmp   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          35s   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>    
taint2-544694789-bn7wb    <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          35s   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>     
taint3-6d78dbd749-tktkq   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          6s    <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>     </pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="" class="marker"></div><pre>小提示：
    使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记<span class="token punctuation">,</span>所以pod就不会调度到master节点上<span class="token punctuation">.</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——</span><span class="inline-wrap"><b>容忍（Toleration）</b></span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面介绍了污点的作用，我们可以在<span class="jill"></span>node<span class="jill"></span>上添加污点用于拒绝<span class="jill"></span>pod<span class="jill"></span>调度上来，但是如果就是想将一个<span class="jill"></span>pod<span class="jill"></span>调度到一个有污点的<span class="jill"></span>node<span class="jill"></span>上去，这时候应该怎么做呢？这就要使用到</span><span class="inline-wrap"><b>容忍</b></span><span class="inline-wrap">。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/1644909518529image-20200514095913741.png" style="width: 679.3333333333334px"/></figure></div><blockquote class="wolai-block"><span class="inline-wrap">污点就是拒绝，容忍就是忽略，Node<span class="jill"></span>通过污点拒绝<span class="jill"></span>pod<span class="jill"></span>调度上去，Pod<span class="jill"></span>通过容忍忽略拒绝</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面先通过一个案例看下效果：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">上一小节，已经在<span class="jill"></span>node1<span class="jill"></span>节点上打上了</span><span class="inline-wrap"><code>NoExecute</code></span><span class="inline-wrap">的污点，此时<span class="jill"></span>pod<span class="jill"></span>是调度不上去的</span></li><li><div class="marker"></div><span class="inline-wrap">本小节，可以通过给<span class="jill"></span>pod<span class="jill"></span>添加容忍，然后将其调度上去</span></li></ol><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pod-toleration.yaml,内容如下</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Yaml" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>toleration
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token comment"># 添加容忍</span>
  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"tag"</span>        <span class="token comment"># 要容忍的污点的key</span>
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Equal"</span> <span class="token comment"># 操作符</span>
    <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"heima"</span>    <span class="token comment"># 容忍的污点的value</span>
    <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoExecute"</span>   <span class="token comment"># 添加容忍的规则，这里必须和标记的污点规则相同</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 添加容忍之前的pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED 
pod-toleration   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          3s    <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>   <span class="token operator">&lt;</span>none<span class="token operator">></span>           

<span class="token comment"># 添加容忍之后的pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED
pod-toleration   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3s    <span class="token number">10.244</span>.1.62   node1   <span class="token operator">&lt;</span>none<span class="token operator">></span>        </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面看一下容忍的详细配置:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.tolerations</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
FIELDS:
   key       <span class="token comment"># 对应着要容忍的污点的键，空意味着匹配所有的键</span>
   value     <span class="token comment"># 对应着要容忍的污点的值</span>
   operator  <span class="token comment"># key-value的运算符，支持Equal和Exists（默认）</span>
   effect    <span class="token comment"># 对应污点的effect，空意味着匹配所有影响</span>
   tolerationSeconds   <span class="token comment"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">5.2  Pod<span class="jill"></span>控制器详解</span></h3><h4 class="wolai-block"><span class="inline-wrap">1) Pod<span class="jill"></span>控制器介绍</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Pod<span class="jill"></span>是<span class="jill"></span>kubernetes<span class="jill"></span>的最小管理单元，在<span class="jill"></span>kubernetes<span class="jill"></span>中，按照<span class="jill"></span>pod<span class="jill"></span>的创建方式可以将其分为两类：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">自主式<span class="jill"></span>pod：kubernetes<span class="jill"></span>直接创建出来的<span class="jill"></span>Pod，这种<span class="jill"></span>pod<span class="jill"></span>删除后就没有了，也不会重建</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">控制器创建的<span class="jill"></span>pod：kubernetes<span class="jill"></span>通过控制器创建的<span class="jill"></span>pod，这种<span class="jill"></span>pod<span class="jill"></span>删除了之后还会自动重建</span></li></ul><blockquote class="wolai-block"><span class="inline-wrap"><b><code>什么是<span class="jill"></span>Pod<span class="jill"></span>控制器</code></b></span><span class="inline-wrap">

Pod<span class="jill"></span>控制器是管理<span class="jill"></span>pod<span class="jill"></span>的中间层，使用<span class="jill"></span>Pod<span class="jill"></span>控制器之后，只需要告诉<span class="jill"></span>Pod<span class="jill"></span>控制器，想要多少个什么样的<span class="jill"></span>Pod<span class="jill"></span>就可以了，它会创建出满足条件的<span class="jill"></span>Pod<span class="jill"></span>并确保每一个<span class="jill"></span>Pod<span class="jill"></span>资源处于用户期望的目标状态。如果<span class="jill"></span>Pod<span class="jill"></span>资源在运行中出现故障，它会基于指定策略重新编排<span class="jill"></span>Pod。</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>kubernetes<span class="jill"></span>中，有很多类型的<span class="jill"></span>pod<span class="jill"></span>控制器，每种都有自己的适合的场景，常见的有下面这些：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ReplicationController：比较原始的<span class="jill"></span>pod<span class="jill"></span>控制器，已经被废弃，由<span class="jill"></span>ReplicaSet<span class="jill"></span>替代</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ReplicaSet：保证副本数量一直维持在期望值，并支持<span class="jill"></span>pod<span class="jill"></span>数量扩缩容，镜像版本升级</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Deployment：通过控制<span class="jill"></span>ReplicaSet<span class="jill"></span>来控制<span class="jill"></span>Pod，并支持滚动升级、回退版本</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Horizontal Pod Autoscaler：可以根据集群负载自动水平调整<span class="jill"></span>Pod<span class="jill"></span>的数量，实现削峰填谷</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">DaemonSet：在集群中的指定<span class="jill"></span>Node<span class="jill"></span>上运行且仅运行一个副本，一般用于守护进程类的任务</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Job：它创建出来的<span class="jill"></span>pod<span class="jill"></span>只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Cronjob：它创建的<span class="jill"></span>Pod<span class="jill"></span>负责周期性任务控制，不需要持续后台运行</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">StatefulSet：管理有状态应用</span></li></ul><h4 class="wolai-block"><span class="inline-wrap">2) ReplicaSet(RS)</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">ReplicaSet<span class="jill"></span>的主要作用是</span><span class="inline-wrap"><b>保证一定数量的<span class="jill"></span>pod<span class="jill"></span>正常运行</b></span><span class="inline-wrap">，它会持续监听这些<span class="jill"></span>Pod<span class="jill"></span>的运行状态，一旦<span class="jill"></span>Pod<span class="jill"></span>发生故障，就会重启或重建。同时它还支持对<span class="jill"></span>pod<span class="jill"></span>数量的扩缩容和镜像版本的升降级。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16452533810991645253380212.png" style="width: 622px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">ReplicaSet<span class="jill"></span>的资源清单文件：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet <span class="token comment"># 类型       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs名称 </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> rs
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在这里面，需要新了解的配置项就是</span><span class="inline-wrap"><code>spec</code></span><span class="inline-wrap">下面几个选项：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">replicas：指定副本数量，其实就是当前<span class="jill"></span>rs<span class="jill"></span>创建出来的<span class="jill"></span>pod<span class="jill"></span>的数量，默认为<span class="jill"></span>1</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">selector：选择器，它的作用是建立<span class="jill"></span>pod<span class="jill"></span>控制器和<span class="jill"></span>pod<span class="jill"></span>之间的关联关系，采用的<span class="jill"></span>Label Selector<span class="jill"></span>机制</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>pod<span class="jill"></span>模板上定义<span class="jill"></span>label，在控制器上定义选择器，就可以表明当前控制器能管理哪些<span class="jill"></span>pod<span class="jill"></span>了</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">template：模板，就是当前控制器创建<span class="jill"></span>pod<span class="jill"></span>所使用的模板板，里面其实就是前一章学过的<span class="jill"></span>pod<span class="jill"></span>的定义</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>创建<span class="jill"></span>ReplicaSet</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pc-replicaset.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet   
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>replicaset
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> 
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建rs</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-replicaset.yaml</span>
replicaset.apps/pc-replicaset created

<span class="token comment"># 查看rs</span>
<span class="token comment"># DESIRED:期望副本数量  </span>
<span class="token comment"># CURRENT:当前副本数量  </span>
<span class="token comment"># READY:已经准备好提供服务的副本数量</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs pc-replicaset -n dev -o wide</span>
NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR
pc-replicaset <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>     22s   nginx        nginx:1.17.1       <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># 查看当前控制器创建出来的pod</span>
<span class="token comment"># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev</span>
NAME                          READY   STATUS    RESTARTS   AGE
pc-replicaset-6vmvt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          54s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>扩缩容</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 编辑rs的副本数量，修改spec:replicas: 6即可</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit rs pc-replicaset -n dev</span>
replicaset.apps/pc-replicaset edited

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                          READY   STATUS    RESTARTS   AGE
pc-replicaset-6vmvt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m
pc-replicaset-cftnp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s
pc-replicaset-fjlm6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m
pc-replicaset-s2whj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          114m

<span class="token comment"># 当然也可以直接使用命令实现</span>
<span class="token comment"># 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span>
replicaset.apps/pc-replicaset scaled

<span class="token comment"># 命令运行完毕，立即查看，发现已经有4个开始准备退出了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                       READY   STATUS        RESTARTS   AGE
pc-replicaset-6vmvt   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          118m
pc-replicaset-cftnp   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s
pc-replicaset-fjlm6   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running       <span class="token number">0</span>          118m
pc-replicaset-s2whj   <span class="token number">0</span>/1     Terminating   <span class="token number">0</span>          4m17s
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running       <span class="token number">0</span>          118m

<span class="token comment">#稍等片刻，就只剩下2个了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                       READY   STATUS    RESTARTS   AGE
pc-replicaset-fmb8f   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          119m
pc-replicaset-snrk2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          119m</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>镜像升级</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 编辑rs的容器镜像 - image: nginx:1.17.2</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit rs pc-replicaset -n dev</span>
replicaset.apps/pc-replicaset edited

<span class="token comment"># 再次查看，发现镜像版本已经变更了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span>
NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        <span class="token punctuation">..</span>.
pc-replicaset       <span class="token number">2</span>        <span class="token number">2</span>         <span class="token number">2</span>       140m   nginx         nginx:1.17.2  <span class="token punctuation">..</span>.

<span class="token comment"># 同样的道理，也可以使用命令完成这个工作</span>
<span class="token comment"># kubectl set image rs rs名称 容器=镜像版本 -n namespace</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span>
replicaset.apps/pc-replicaset image updated

<span class="token comment"># 再次查看，发现镜像版本已经变更了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span>
NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            <span class="token punctuation">..</span>.
pc-replicaset        <span class="token number">2</span>        <span class="token number">2</span>         <span class="token number">2</span>       145m   nginx        nginx:1.17.1 <span class="token punctuation">..</span>. </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>删除<span class="jill"></span>ReplicaSet</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 使用kubectl delete命令会删除此RS以及它管理的Pod</span>
<span class="token comment"># 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete rs pc-replicaset -n dev</span>
replicaset.apps <span class="token string">"pc-replicaset"</span> deleted
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n dev -o wide</span>
No resources found <span class="token keyword">in</span> dev namespace.

<span class="token comment"># 如果希望仅仅删除RS对象（保留Pod），可以使用kubectl delete命令时添加--cascade=false选项（不推荐）。</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete rs pc-replicaset -n dev --cascade=false</span>
replicaset.apps <span class="token string">"pc-replicaset"</span> deleted
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                  READY   STATUS    RESTARTS   AGE
pc-replicaset-cl82j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          75s
pc-replicaset-dslhb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          75s

<span class="token comment"># 也可以使用yaml直接删除(推荐)</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-replicaset.yaml</span>
replicaset.apps <span class="token string">"pc-replicaset"</span> deleted</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">3) Deployment(Deploy)</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">为了更好的解决服务编排的问题，kubernetes<span class="jill"></span>在<span class="jill"></span>V1.2<span class="jill"></span>版本开始，引入了<span class="jill"></span>Deployment<span class="jill"></span>控制器。值得一提的是，这种控制器并不直接管理<span class="jill"></span>pod，而是通过管理<span class="jill"></span>ReplicaSet<span class="jill"></span>来简介管理<span class="jill"></span>Pod，即：Deployment<span class="jill"></span>管理<span class="jill"></span>ReplicaSet，ReplicaSet<span class="jill"></span>管理<span class="jill"></span>Pod。所以<span class="jill"></span>Deployment<span class="jill"></span>比<span class="jill"></span>ReplicaSet<span class="jill"></span>功能更加强大。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16452534495631645253449474.png" style="width: 611px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Deployment<span class="jill"></span>主要功能有下面几个：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">支持<span class="jill"></span>ReplicaSet<span class="jill"></span>的所有功能</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">支持发布的停止、继续</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">支持滚动升级和回滚版本</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">Deployment<span class="jill"></span>的资源清单文件：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># 类型       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs名称 </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> deploy
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 保留历史版本</span>
  <span class="token key atrule">paused</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 暂停部署，默认是false</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span> <span class="token comment"># 部署超时时间（s），默认是600</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># 滚动更新</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 30% <span class="token comment"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 30% <span class="token comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——创建<span class="jill"></span>deployment</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pc-deployment.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span> 
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建deployment</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-deployment.yaml --record=true</span>
deployment.apps/pc-deployment created

<span class="token comment"># 查看deployment</span>
<span class="token comment"># UP-TO-DATE 最新版本的pod的数量</span>
<span class="token comment"># AVAILABLE  当前可用的pod的数量</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy pc-deployment -n dev</span>
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
pc-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           15s

<span class="token comment"># 查看rs</span>
<span class="token comment"># 发现rs的名称是在原来deployment的名字后面添加了一个10位数的随机串</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev</span>
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       23s

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          107s
pc-deployment-6696798b78-smpvp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          107s
pc-deployment-6696798b78-wvjd8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          107s</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——扩缩容</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 变更副本数量为5个</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span>
deployment.apps/pc-deployment scaled

<span class="token comment"># 查看deployment</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy pc-deployment -n dev</span>
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
pc-deployment   <span class="token number">5</span>/5     <span class="token number">5</span>            <span class="token number">5</span>           2m

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s
pc-deployment-6696798b78-jxmdq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          94s
pc-deployment-6696798b78-mktqv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          93s
pc-deployment-6696798b78-smpvp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s
pc-deployment-6696798b78-wvjd8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m19s

<span class="token comment"># 编辑deployment的副本数量，修改spec:replicas: 4即可</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit deploy pc-deployment -n dev</span>
deployment.apps/pc-deployment edited

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6696798b78-d2c8n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s
pc-deployment-6696798b78-jxmdq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m38s
pc-deployment-6696798b78-smpvp   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s
pc-deployment-6696798b78-wvjd8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m23s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——</span><span class="inline-wrap"><b>镜像更新</b></span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">deployment<span class="jill"></span>支持两种更新策略:</span><span class="inline-wrap"><code>重建更新</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>滚动更新</code></span><span class="inline-wrap">,可以通过</span><span class="inline-wrap"><code>strategy</code></span><span class="inline-wrap">指定策略类型,支持两个属性:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Markdown" class="marker"></div><pre>strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：
  type：指定策略类型，支持两种策略
    Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod
    RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod
  rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：
    maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。
    maxSurge： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">重建更新</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1) 编辑<span class="jill"></span>pc-deployment.yaml,在<span class="jill"></span>spec<span class="jill"></span>节点下添加更新策略</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate <span class="token comment"># 重建更新</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2) 创建<span class="jill"></span>deploy<span class="jill"></span>进行验证</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 变更镜像</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span>
deployment.apps/pc-deployment image updated

<span class="token comment"># 观察升级过程</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev -w</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-5d89bdfbf9-65qcw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31s
pc-deployment-5d89bdfbf9-w5nzv   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31s
pc-deployment-5d89bdfbf9-xpt7w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31s

pc-deployment-5d89bdfbf9-xpt7w   <span class="token number">1</span>/1     Terminating   <span class="token number">0</span>          41s
pc-deployment-5d89bdfbf9-65qcw   <span class="token number">1</span>/1     Terminating   <span class="token number">0</span>          41s
pc-deployment-5d89bdfbf9-w5nzv   <span class="token number">1</span>/1     Terminating   <span class="token number">0</span>          41s

pc-deployment-675d469f8b-grn8z   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s
pc-deployment-675d469f8b-hbl4v   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s
pc-deployment-675d469f8b-67nz2   <span class="token number">0</span>/1     Pending       <span class="token number">0</span>          0s

pc-deployment-675d469f8b-grn8z   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-deployment-675d469f8b-hbl4v   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-deployment-675d469f8b-67nz2   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s

pc-deployment-675d469f8b-grn8z   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s
pc-deployment-675d469f8b-67nz2   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s
pc-deployment-675d469f8b-hbl4v   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">滚动更新</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1) 编辑<span class="jill"></span>pc-deployment.yaml,在<span class="jill"></span>spec<span class="jill"></span>节点下添加更新策略</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25% 
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2) 创建<span class="jill"></span>deploy<span class="jill"></span>进行验证</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 变更镜像</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span>
deployment.apps/pc-deployment image updated

<span class="token comment"># 观察升级过程</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span>
NAME                           READY   STATUS    RESTARTS   AGE
pc-deployment-c848d767-8rbzt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
pc-deployment-c848d767-h4p68   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
pc-deployment-c848d767-hlmz4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m
pc-deployment-c848d767-rrqcn   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31m

pc-deployment-966bf7f44-226rx   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-deployment-966bf7f44-226rx   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-deployment-966bf7f44-226rx   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          1s
pc-deployment-c848d767-h4p68    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m

pc-deployment-966bf7f44-cnd44   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-deployment-966bf7f44-cnd44   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-deployment-966bf7f44-cnd44   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s
pc-deployment-c848d767-hlmz4    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m

pc-deployment-966bf7f44-px48p   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-deployment-966bf7f44-px48p   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-deployment-966bf7f44-px48p   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          0s
pc-deployment-c848d767-8rbzt    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m

pc-deployment-966bf7f44-dkmqp   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-deployment-966bf7f44-dkmqp   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-deployment-966bf7f44-dkmqp   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s
pc-deployment-c848d767-rrqcn    <span class="token number">0</span>/1     Terminating         <span class="token number">0</span>          34m

<span class="token comment"># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span>
<span class="token comment"># 中间过程是滚动进行的，也就是边销毁边创建</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">滚动更新的过程：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16452535788851645253578782.png" style="width: 745px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">镜像更新中<span class="jill"></span>rs<span class="jill"></span>的变化</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 查看rs,发现原来的rs的依旧存在，只是pod数量变为了0，而后又新产生了一个rs，pod数量为4</span>
<span class="token comment"># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev</span>
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       7m37s
pc-deployment-6696798b11   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       5m37s
pc-deployment-c848d76789   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       72s</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——版本回退</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">deployment<span class="jill"></span>支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubectl rollout： 版本升级相关功能，支持下面的选项：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">status  显示当前升级状态</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">history   显示 升级历史记录</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">pause    暂停版本升级过程</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">resume   继续已经暂停的版本升级过程</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">restart    重启版本升级过程</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">undo 回滚到上一级版本（可以使用--to-revision<span class="jill"></span>回滚到指定版本）</span></li></ul><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 查看当前升级版本的状态</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout status deploy pc-deployment -n dev</span>
deployment <span class="token string">"pc-deployment"</span> successfully rolled out

<span class="token comment"># 查看升级历史记录</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout history deploy pc-deployment -n dev</span>
deployment.apps/pc-deployment
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         kubectl create --filename<span class="token operator">=</span>pc-deployment.yaml --record<span class="token operator">=</span>true
<span class="token number">2</span>         kubectl create --filename<span class="token operator">=</span>pc-deployment.yaml --record<span class="token operator">=</span>true
<span class="token number">3</span>         kubectl create --filename<span class="token operator">=</span>pc-deployment.yaml --record<span class="token operator">=</span>true
<span class="token comment"># 可以发现有三次版本记录，说明完成过两次升级. 想要查看上面详细信息（版本右边信息），在create deploy 时加“--record”</span>

<span class="token comment"># 版本回滚</span>
<span class="token comment"># 这里直接使用--to-revision=1回滚到了1版本， 如果省略这个选项，就是回退到上个版本，就是2版本</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span>
deployment.apps/pc-deployment rolled back

<span class="token comment"># 查看发现，通过nginx镜像版本可以发现到了第一版</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deploy -n dev -o wide</span>
NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         
pc-deployment   <span class="token number">4</span>/4     <span class="token number">4</span>            <span class="token number">4</span>           74m   nginx        nginx:1.17.1   

<span class="token comment"># 查看rs，发现第一个rs中有4个pod运行，后面两个版本的rs中pod为运行</span>
<span class="token comment"># 其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，</span>
<span class="token comment"># 一旦想回滚到哪个版本，只需要将当前版本pod数量降为0，然后将回滚版本的pod提升为目标数量就可以了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev</span>
NAME                       DESIRED   CURRENT   READY   AGE
pc-deployment-6696798b78   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       78m
pc-deployment-966bf7f44    <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       37m
pc-deployment-c848d767     <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       71m</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——金丝雀发布</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Deployment<span class="jill"></span>控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">比如有一批新的<span class="jill"></span>Pod<span class="jill"></span>资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的<span class="jill"></span>Pod<span class="jill"></span>应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的<span class="jill"></span>Pod<span class="jill"></span>资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 更新deployment的版本，并配置暂停deployment</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span>
deployment.apps/pc-deployment image updated
deployment.apps/pc-deployment paused

<span class="token comment">#观察更新状态</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout status deploy pc-deployment -n dev　</span>
Waiting <span class="token keyword">for</span> deployment <span class="token string">"pc-deployment"</span> rollout to finish: <span class="token number">2</span> out of <span class="token number">4</span> new replicas have been updated<span class="token punctuation">..</span>.

<span class="token comment"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span>
NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
pc-deployment-5d89bdfbf9   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       19m     nginx        nginx:1.17.1   
pc-deployment-675d469f8b   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       14m     nginx        nginx:1.17.2   
pc-deployment-6c9f56fcfb   <span class="token number">2</span>         <span class="token number">2</span>         <span class="token number">2</span>       3m16s   nginx        nginx:1.17.4   
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-5d89bdfbf9-rj8sq   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m33s
pc-deployment-5d89bdfbf9-ttwgg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m35s
pc-deployment-5d89bdfbf9-v4wvc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m34s
pc-deployment-6c9f56fcfb-996rt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s
pc-deployment-6c9f56fcfb-j2gtj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s

<span class="token comment"># 确保更新的pod没问题了，继续更新</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl rollout resume deploy pc-deployment -n dev</span>
deployment.apps/pc-deployment resumed

<span class="token comment"># 查看最后的更新情况</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get rs -n dev -o wide</span>
NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
pc-deployment-5d89bdfbf9   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       21m     nginx        nginx:1.17.1   
pc-deployment-675d469f8b   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       16m     nginx        nginx:1.17.2   
pc-deployment-6c9f56fcfb   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       5m11s   nginx        nginx:1.17.4   

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                             READY   STATUS    RESTARTS   AGE
pc-deployment-6c9f56fcfb-7bfwh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s
pc-deployment-6c9f56fcfb-996rt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m27s
pc-deployment-6c9f56fcfb-j2gtj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m27s
pc-deployment-6c9f56fcfb-rf84v   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>删除<span class="jill"></span>Deployment</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 删除deployment，其下的rs和pod也将被删除</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-deployment.yaml</span>
deployment.apps <span class="token string">"pc-deployment"</span> deleted</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">4）[重要] Horizontal Pod Autoscaler(HPA)</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在前面的课程中，我们已经可以实现通过手工执行</span><span class="inline-wrap"><code>kubectl scale</code></span><span class="inline-wrap">命令实现<span class="jill"></span>Pod<span class="jill"></span>扩容或缩容，但是这显然不符合<span class="jill"></span>Kubernetes<span class="jill"></span>的定位目标--自动化、智能化。 Kubernetes<span class="jill"></span>期望可以实现通过监测<span class="jill"></span>Pod<span class="jill"></span>的使用情况，实现<span class="jill"></span>pod<span class="jill"></span>数量的自动调整，于是就产生了<span class="jill"></span>Horizontal Pod Autoscaler（HPA）这种控制器。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">HPA<span class="jill"></span>可以获取每个<span class="jill"></span>Pod<span class="jill"></span>利用率，然后和<span class="jill"></span>HPA<span class="jill"></span>中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现<span class="jill"></span>Pod<span class="jill"></span>的数量的调整。其实<span class="jill"></span>HPA<span class="jill"></span>与之前的<span class="jill"></span>Deployment<span class="jill"></span>一样，也属于一种<span class="jill"></span>Kubernetes<span class="jill"></span>资源对象，它通过追踪分析<span class="jill"></span>RC<span class="jill"></span>控制的所有目标<span class="jill"></span>Pod<span class="jill"></span>的负载变化情况，来确定是否需要针对性地调整目标<span class="jill"></span>Pod<span class="jill"></span>的副本数，这是<span class="jill"></span>HPA<span class="jill"></span>的实现原理。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16453509289621645350928841.png" style="width: 557.9375px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们来做一个实验</span></div></div><h4 class="wolai-block"><span class="inline-wrap">——安装<span class="jill"></span>metrics-server</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">metrics-server<span class="jill"></span>可以用来收集集群中的资源使用情况</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 安装git</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install git -y</span>
<span class="token comment"># 获取metrics-server, 注意使用的版本</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span>
<span class="token comment"># 修改deployment, 注意修改的是镜像和初始化参数</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /root/metrics-server/deploy/1.8+/</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># vim metrics-server-deployment.yaml</span>
按图中添加下面选项
hostNetwork: <span class="token boolean">true</span>
image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6
args:
- --kubelet-insecure-tls
- --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
</pre></div></code-block><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16453508666451645350865815.png" style="width: 755px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 安装metrics-server</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ./</span>

<span class="token comment"># 查看pod运行情况</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n kube-system</span>
metrics-server-6b976979db-2xwbj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          90s

<span class="token comment"># 使用kubectl top node 查看资源使用情况(需要等一下)</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl top node</span>
NAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
k8s-master01   289m         <span class="token number">14</span>%    1582Mi          <span class="token number">54</span>%       
k8s-node01     81m          <span class="token number">4</span>%     1195Mi          <span class="token number">40</span>%       
k8s-node02     72m          <span class="token number">3</span>%     1211Mi          <span class="token number">41</span>%  
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl top pod -n kube-system</span>
NAME                              CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
coredns-6955765f44-7ptsb          3m           9Mi
coredns-6955765f44-vcwr5          3m           8Mi
etcd-master                       14m          145Mi
<span class="token punctuation">..</span>.
<span class="token comment"># 至此,metrics-server安装完成</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——准备<span class="jill"></span>deployment<span class="jill"></span>和<span class="jill"></span>servie</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pc-hpa-pod.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 资源配额</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment"># 限制资源（上限）</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span> <span class="token comment"># CPU限制，单位是core数</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># 请求资源（下限）</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"100m"</span>  <span class="token comment"># CPU限制，单位是core数</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建deployment</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span>
<span class="token comment"># 创建service</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment,pod,svc -n dev</span>
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           47s

NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-7df9756ccc-bh8dr   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          47s

NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/nginx   NodePort   <span class="token number">10.101</span>.18.29   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:31830/TCP   35s</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——部署<span class="jill"></span>HPA</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pc-hpa.yaml<span class="jill"></span>文件，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>hpa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token comment">#最小pod数量</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment">#最大pod数量</span>
  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># CPU使用率指标</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>   <span class="token comment"># 指定要控制的nginx信息</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建hpa</span>
<span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-hpa.yaml</span>
horizontalpodautoscaler.autoscaling/pc-hpa created

<span class="token comment"># 查看hpa</span>
    <span class="token punctuation">[</span>root@k8s-master01 <span class="token number">1.8</span>+<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n dev</span>
NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
pc-hpa   Deployment/nginx   <span class="token number">0</span>%/3%     <span class="token number">1</span>         <span class="token number">10</span>        <span class="token number">1</span>          62s</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——</span><span class="inline-wrap">测试</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用压测工具对<span class="jill"></span>service<span class="jill"></span>地址</span><span class="inline-wrap"><code>192.168.5.4:31830</code></span><span class="inline-wrap">进行压测，然后通过控制台查看<span class="jill"></span>hpa<span class="jill"></span>和<span class="jill"></span>pod<span class="jill"></span>的变化</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">hpa<span class="jill"></span>变化</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n dev -w</span>
NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      4m11s
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      5m19s
pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      6m50s
pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">4</span>      7m5s
pc-hpa  Deployment/nginx  <span class="token number">22</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      7m21s
pc-hpa  Deployment/nginx  <span class="token number">6</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      7m51s
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      9m6s
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">8</span>      13m
pc-hpa  Deployment/nginx  <span class="token number">0</span>%/3%   <span class="token number">1</span>     <span class="token number">10</span>     <span class="token number">1</span>      14m</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">deployment<span class="jill"></span>变化</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment -n dev -w</span>
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           11m
nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/4     <span class="token number">1</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/4     <span class="token number">4</span>            <span class="token number">1</span>           13m
nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">1</span>/8     <span class="token number">4</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">1</span>/8     <span class="token number">8</span>            <span class="token number">1</span>           14m
nginx   <span class="token number">2</span>/8     <span class="token number">8</span>            <span class="token number">2</span>           14m
nginx   <span class="token number">3</span>/8     <span class="token number">8</span>            <span class="token number">3</span>           14m
nginx   <span class="token number">4</span>/8     <span class="token number">8</span>            <span class="token number">4</span>           14m
nginx   <span class="token number">5</span>/8     <span class="token number">8</span>            <span class="token number">5</span>           14m
nginx   <span class="token number">6</span>/8     <span class="token number">8</span>            <span class="token number">6</span>           14m
nginx   <span class="token number">7</span>/8     <span class="token number">8</span>            <span class="token number">7</span>           14m
nginx   <span class="token number">8</span>/8     <span class="token number">8</span>            <span class="token number">8</span>           15m
nginx   <span class="token number">8</span>/1     <span class="token number">8</span>            <span class="token number">8</span>           20m
nginx   <span class="token number">8</span>/1     <span class="token number">8</span>            <span class="token number">8</span>           20m
nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           20m</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">pod<span class="jill"></span>变化</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>[root@k8s-master01 ~]# kubectl get pods -n dev -w
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7df9756ccc-bh8dr   1/1     Running   0          11m
nginx-7df9756ccc-cpgrv   0/1     Pending   0          0s
nginx-7df9756ccc-8zhwk   0/1     Pending   0          0s
nginx-7df9756ccc-rr9bn   0/1     Pending   0          0s
nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     Pending             0          0s
nginx-7df9756ccc-sl9c6   0/1     Pending             0          0s
nginx-7df9756ccc-fgst7   0/1     Pending             0          0s
nginx-7df9756ccc-g56qb   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-fgst7   0/1     ContainerCreating   0          0s
nginx-7df9756ccc-8zhwk   1/1     Running             0          19s
nginx-7df9756ccc-rr9bn   1/1     Running             0          30s
nginx-7df9756ccc-m9gsj   1/1     Running             0          21s
nginx-7df9756ccc-cpgrv   1/1     Running             0          47s
nginx-7df9756ccc-sl9c6   1/1     Running             0          33s
nginx-7df9756ccc-g56qb   1/1     Running             0          48s
nginx-7df9756ccc-fgst7   1/1     Running             0          66s
nginx-7df9756ccc-fgst7   1/1     Terminating         0          6m50s
nginx-7df9756ccc-8zhwk   1/1     Terminating         0          7m5s
nginx-7df9756ccc-cpgrv   1/1     Terminating         0          7m5s
nginx-7df9756ccc-g56qb   1/1     Terminating         0          6m50s
nginx-7df9756ccc-rr9bn   1/1     Terminating         0          7m5s
nginx-7df9756ccc-m9gsj   1/1     Terminating         0          6m50s
nginx-7df9756ccc-sl9c6   1/1     Terminating         0          6m50s</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">5）每台机一个副本<span class="jill"></span>DaemonSet(DS)</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">DaemonSet<span class="jill"></span>类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个<span class="jill"></span>Pod<span class="jill"></span>提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类<span class="jill"></span>Pod<span class="jill"></span>就适合使用<span class="jill"></span>DaemonSet<span class="jill"></span>类型的控制器创建。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16454257276581645425726818.png" style="width: 596.6666870117188px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">DaemonSet<span class="jill"></span>控制器的特点：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">当节点从集群中移除时，Pod 也就被垃圾回收了</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面先来看下<span class="jill"></span>DaemonSet<span class="jill"></span>的资源清单文件</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet <span class="token comment"># 类型       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs名称 </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> daemonset
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 保留历史版本</span>
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span> <span class="token comment"># 更新策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># 滚动更新</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pc-daemonset.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>daemonset
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span> 
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建daemonset</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f  pc-daemonset.yaml</span>
daemonset.apps/pc-daemonset created

<span class="token comment"># 查看daemonset</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get ds -n dev -o wide</span>
NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         
pc-daemonset   <span class="token number">2</span>        <span class="token number">2</span>        <span class="token number">2</span>      <span class="token number">2</span>           <span class="token number">2</span>        24s   nginx        nginx:1.17.1   

<span class="token comment"># 查看pod,发现在每个Node上都运行一个pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get pods -n dev -o wide</span>
NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    
pc-daemonset-9bck8   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s   <span class="token number">10.244</span>.1.43   node1     
pc-daemonset-k224w   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          37s   <span class="token number">10.244</span>.2.74   node2      

<span class="token comment"># 删除daemonset</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-daemonset.yaml</span>
daemonset.apps <span class="token string">"pc-daemonset"</span> deleted</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">6）批量一次性任务<span class="jill"></span>Job</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Job，主要用于负责**批量处理(一次要处理指定数量任务)</span><span class="inline-wrap"><b>短暂的</b></span><span class="inline-wrap">一次性(每个任务仅运行一次就结束)**任务。Job<span class="jill"></span>特点如下：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">当<span class="jill"></span>Job<span class="jill"></span>创建的<span class="jill"></span>pod<span class="jill"></span>执行成功结束时，Job<span class="jill"></span>将记录成功结束的<span class="jill"></span>pod<span class="jill"></span>数量</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">当成功结束的<span class="jill"></span>pod<span class="jill"></span>达到指定的数量时，Job<span class="jill"></span>将完成执行</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16454257457791645425745680.png" style="width: 654px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Job<span class="jill"></span>的资源清单文件：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job <span class="token comment"># 类型       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs名称 </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> job
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定job需要成功运行Pods的次数。默认值: 1</span>
  <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定job在任一时刻应该并发运行Pods的数量。默认值: 1</span>
  <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment"># 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span>
  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span> <span class="token comment"># 指定job失败后进行重试的次数。默认是6</span>
  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否可以使用selector选择器选择pod，默认是false</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>counter<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略只能设置为Never或者OnFailure</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done"</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Markdown" class="marker"></div><pre>关于重启策略设置的说明：
    如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变
    如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1
    如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pc-job.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>job
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
        <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done"</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-job.yaml</span>
job.batch/pc-job created

<span class="token comment"># 查看job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get job -n dev -o wide  -w</span>
NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR
pc-job   <span class="token number">0</span>/1           21s        21s   counter      busybox:1.30   <span class="token assign-left variable">app</span><span class="token operator">=</span>counter-pod
pc-job   <span class="token number">1</span>/1           31s        79s   counter      busybox:1.30   <span class="token assign-left variable">app</span><span class="token operator">=</span>counter-pod

<span class="token comment"># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span>
NAME           READY   STATUS     RESTARTS      AGE
pc-job-rxg96   <span class="token number">1</span>/1     Running     <span class="token number">0</span>            29s
pc-job-rxg96   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>            33s

<span class="token comment"># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span>
<span class="token comment">#  completions: 6 # 指定job需要成功运行Pods的次数为6</span>
<span class="token comment">#  parallelism: 3 # 指定job并发运行Pods的数量为3</span>
<span class="token comment">#  然后重新运行job，观察效果，此时会发现，job会每次运行3个pod，总共执行了6个pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -w</span>
NAME           READY   STATUS    RESTARTS   AGE
pc-job-684ft   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s
pc-job-jhj49   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s
pc-job-pfcvh   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s
pc-job-684ft   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          11s
pc-job-v7rhr   <span class="token number">0</span>/1     Pending     <span class="token number">0</span>          0s
pc-job-v7rhr   <span class="token number">0</span>/1     Pending     <span class="token number">0</span>          0s
pc-job-v7rhr   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-job-jhj49   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          11s
pc-job-fhwf7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-fhwf7   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-pfcvh   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          11s
pc-job-5vg2j   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-fhwf7   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-job-5vg2j   <span class="token number">0</span>/1     Pending             <span class="token number">0</span>          0s
pc-job-5vg2j   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
pc-job-fhwf7   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s
pc-job-v7rhr   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          2s
pc-job-5vg2j   <span class="token number">1</span>/1     Running             <span class="token number">0</span>          3s
pc-job-fhwf7   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s
pc-job-v7rhr   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s
pc-job-5vg2j   <span class="token number">0</span>/1     Completed           <span class="token number">0</span>          12s

<span class="token comment"># 删除job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f pc-job.yaml</span>
job.batch <span class="token string">"pc-job"</span> deleted</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">7）定时任务<span class="jill"></span>CronJob(CJ)</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">CronJob<span class="jill"></span>控制器以 Job<span class="jill"></span>控制器资源为其管控对象，并借助它管理<span class="jill"></span>pod<span class="jill"></span>资源对象，Job<span class="jill"></span>控制器定义的作业任务在其控制器资源创建之后便会立即执行，但<span class="jill"></span>CronJob<span class="jill"></span>可以以类似于<span class="jill"></span>Linux<span class="jill"></span>操作系统的周期性任务作业计划的方式控制其运行</span><span class="inline-wrap"><b>时间点</b></span><span class="inline-wrap">及</span><span class="inline-wrap"><b>重复运行</b></span><span class="inline-wrap">的方式。也就是说，</span><span class="inline-wrap"><b>CronJob<span class="jill"></span>可以在特定的时间点(反复的)去运行<span class="jill"></span>job<span class="jill"></span>任务</b></span><span class="inline-wrap">。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/16454257686611645425768594.png" style="width: 637px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">CronJob<span class="jill"></span>的资源清单文件：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob <span class="token comment"># 类型       </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs名称 </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> cronjob
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token comment"># cron格式的作业调度运行时间点,用于控制任务在什么时间执行</span>
  <span class="token key atrule">concurrencyPolicy</span><span class="token punctuation">:</span> <span class="token comment"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span>
  <span class="token key atrule">failedJobHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># 为失败的任务执行保留的历史记录数，默认为1</span>
  <span class="token key atrule">successfulJobHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># 为成功的任务执行保留的历史记录数，默认为3</span>
  <span class="token key atrule">startingDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token comment"># 启动作业错误的超时时长</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span> <span class="token comment"># job控制器模板，用于为cronjob控制器生成job对象;下面其实就是job的定义</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span>
      <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">selector</span><span class="token punctuation">:</span>
        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
          <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
        <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> 规则
          <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>counter<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
          <span class="token key atrule">labels</span><span class="token punctuation">:</span>
            <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never 
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done"</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Markdown" class="marker"></div><pre>需要重点解释的几个选项：
schedule: cron表达式，用于指定任务的执行时间
    <span class="token italic"><span class="token punctuation">*</span><span class="token content">/1    </span><span class="token punctuation">*</span></span>      <span class="token italic"><span class="token punctuation">*</span><span class="token content">    </span><span class="token punctuation">*</span></span>     *
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>分钟</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>小时</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>日</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>月份</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>星期</span><span class="token punctuation">></span></span>

<span class="token code keyword">    分钟 值从 0 到 59.
    小时 值从 0 到 23.
    日 值从 1 到 31.
    月 值从 1 到 12.
    星期 值从 0 到 6, 0 代表星期日
    多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每...</span>
concurrencyPolicy:
    Allow:   允许Jobs并发运行(默认)
    Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行
    Replace: 替换，取消当前正在运行的作业并用新作业替换它</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>pc-cronjob.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>cronjob
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> cronjob
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"*/1 * * * *"</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done"</span><span class="token punctuation">]</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建cronjob</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pc-cronjob.yaml</span>
cronjob.batch/pc-cronjob created

<span class="token comment"># 查看cronjob</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get cronjobs -n dev</span>
NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
pc-cronjob   */1 * * * *   False     <span class="token number">0</span>        <span class="token operator">&lt;</span>none<span class="token operator">></span>          6s

<span class="token comment"># 查看job</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get jobs -n dev</span>
NAME                    COMPLETIONS   DURATION   AGE
pc-cronjob-1592587800   <span class="token number">1</span>/1           28s        3m26s
pc-cronjob-1592587860   <span class="token number">1</span>/1           28s        2m26s
pc-cronjob-1592587920   <span class="token number">1</span>/1           28s        86s

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
pc-cronjob-1592587800-x4tsm   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          2m24s
pc-cronjob-1592587860-r5gv4   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          84s
pc-cronjob-1592587920-9dxxq   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          24s


<span class="token comment"># 删除cronjob</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  delete -f pc-cronjob.yaml</span>
cronjob.batch <span class="token string">"pc-cronjob"</span> deleted</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">5.3 Service<span class="jill"></span>详解</span></h3><h4 class="wolai-block"><span class="inline-wrap">1）Service<span class="jill"></span>介绍</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>kubernetes<span class="jill"></span>中，pod<span class="jill"></span>是应用程序的载体，我们可以通过<span class="jill"></span>pod<span class="jill"></span>的<span class="jill"></span>ip<span class="jill"></span>来访问应用程序，但是<span class="jill"></span>pod<span class="jill"></span>的<span class="jill"></span>ip<span class="jill"></span>地址不是固定的，这也就意味着不方便直接采用<span class="jill"></span>pod<span class="jill"></span>的<span class="jill"></span>ip<span class="jill"></span>对服务进行访问。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">为了解决这个问题，kubernetes<span class="jill"></span>提供了<span class="jill"></span>Service<span class="jill"></span>资源，Service<span class="jill"></span>会对提供同一个服务的多个<span class="jill"></span>pod<span class="jill"></span>进行聚合，并且提供一个统一的入口地址。通过访问<span class="jill"></span>Service<span class="jill"></span>的入口地址就能访问到后面的<span class="jill"></span>pod<span class="jill"></span>服务。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226003143515.png" style="width: 715.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Service<span class="jill"></span>在很多情况下只是一个概念，真正起作用的其实是<span class="jill"></span>kube-proxy<span class="jill"></span>服务进程，每个<span class="jill"></span>Node<span class="jill"></span>节点上都运行着一个<span class="jill"></span>kube-proxy<span class="jill"></span>服务进程。当创建<span class="jill"></span>Service<span class="jill"></span>的时候会通过<span class="jill"></span>api-server<span class="jill"></span>向<span class="jill"></span>etcd<span class="jill"></span>写入创建的<span class="jill"></span>service<span class="jill"></span>的信息，而<span class="jill"></span>kube-proxy<span class="jill"></span>会基于监听的机制发现这种<span class="jill"></span>Service<span class="jill"></span>的变动，然后</span><span class="inline-wrap"><b>它会将最新的<span class="jill"></span>Service<span class="jill"></span>信息转换成对应的访问规则</b></span><span class="inline-wrap">。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/25/20220225235902007.png" style="width: 698.6666666666666px"/></figure></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre># 10.97.97.97:80 是service提供的访问入口
# 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，
# kube-proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去
# 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上访问都可以。
[root@node1 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.97.97.97:80 rr
  -> 10.244.1.39:80               Masq    1      0          0
  -> 10.244.1.40:80               Masq    1      0          0
  -> 10.244.2.33:80               Masq    1      0          0</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">kube-proxy<span class="jill"></span>目前支持三种工作模式:</span></div></div><h4 class="wolai-block"><span class="inline-wrap">2）userspace 模式</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">userspace<span class="jill"></span>模式下，kube-proxy<span class="jill"></span>会为每一个<span class="jill"></span>Service<span class="jill"></span>创建一个监听端口，发向<span class="jill"></span>Cluster IP<span class="jill"></span>的请求被<span class="jill"></span>Iptables<span class="jill"></span>规则重定向到<span class="jill"></span>kube-proxy<span class="jill"></span>监听的端口上，kube-proxy<span class="jill"></span>根据<span class="jill"></span>LB<span class="jill"></span>算法选择一个提供服务的<span class="jill"></span>Pod<span class="jill"></span>并和其建立链接，以将请求转发到<span class="jill"></span>Pod<span class="jill"></span>上。  该模式下，kube-proxy<span class="jill"></span>充当了一个四层负责均衡器的角色。由于<span class="jill"></span>kube-proxy<span class="jill"></span>运行在<span class="jill"></span>userspace<span class="jill"></span>中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226003156760.png" style="width: 515.7575459475925px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">3）iptables 模式</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">iptables<span class="jill"></span>模式下，kube-proxy<span class="jill"></span>为<span class="jill"></span>service<span class="jill"></span>后端的每个<span class="jill"></span>Pod<span class="jill"></span>创建对应的<span class="jill"></span>iptables<span class="jill"></span>规则，直接将发向<span class="jill"></span>Cluster IP<span class="jill"></span>的请求重定向到一个<span class="jill"></span>Pod IP。  该模式下<span class="jill"></span>kube-proxy<span class="jill"></span>不承担四层负责均衡器的角色，只负责创建<span class="jill"></span>iptables<span class="jill"></span>规则。该模式的优点是较<span class="jill"></span>userspace<span class="jill"></span>模式效率更高，但不能提供灵活的<span class="jill"></span>LB<span class="jill"></span>策略，当后端<span class="jill"></span>Pod<span class="jill"></span>不可用时也无法进行重试。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226003159364.png" style="width: 558px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">4）ipvs 模式(重要,以循)</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">ipvs<span class="jill"></span>模式和<span class="jill"></span>iptables<span class="jill"></span>类似，kube-proxy<span class="jill"></span>监控<span class="jill"></span>Pod<span class="jill"></span>的变化并创建相应的<span class="jill"></span>ipvs<span class="jill"></span>规则。ipvs<span class="jill"></span>相对<span class="jill"></span>iptables<span class="jill"></span>转发效率更高。除此以外，ipvs<span class="jill"></span>支持更多的<span class="jill"></span>LB<span class="jill"></span>算法。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/25/20220225235902622.png" style="width: 546.6666666666666px"/></figure></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 此模式必须安装ipvs内核模块，否则会降级为iptables</span>
<span class="token comment"># 开启ipvs</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit cm kube-proxy -n kube-system</span>
<span class="token comment"># 修改mode: "ipvs"</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">10.97</span>.97.97:80 rr
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">5）Service<span class="jill"></span>类型</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Service<span class="jill"></span>的资源清单文件：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service  <span class="token comment"># 资源类型</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  <span class="token comment"># 资源版本</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service <span class="token comment"># 资源名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名空间</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 描述</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 标签选择器，用于确定当前service代理哪些pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token comment"># Service类型，指定service的访问方式</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span>  <span class="token comment"># 虚拟服务的ip地址</span>
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> <span class="token comment"># session亲和性，支持ClientIP、None两个选项</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 端口信息</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP 
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3017</span>  <span class="token comment"># service端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5003</span> <span class="token comment"># pod端口</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31122</span> <span class="token comment"># 主机端口</span></pre></div></code-block><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ClusterIP：默认值，它是<span class="jill"></span>Kubernetes<span class="jill"></span>系统自动分配的虚拟<span class="jill"></span>IP，只能在集群内部访问</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">NodePort：将<span class="jill"></span>Service<span class="jill"></span>通过指定的<span class="jill"></span>Node<span class="jill"></span>上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ExternalName： 把集群外部的服务引入集群内部，直接使用</span></li></ul><h4 class="wolai-block"><span class="inline-wrap">6）Service<span class="jill"></span>使用</span></h4><h4 class="wolai-block"><span class="inline-wrap">——实验环境准备</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在使用<span class="jill"></span>service<span class="jill"></span>之前，首先利用<span class="jill"></span>Deployment<span class="jill"></span>创建出<span class="jill"></span>3<span class="jill"></span>个<span class="jill"></span>pod，注意要为<span class="jill"></span>pod<span class="jill"></span>设置</span><span class="inline-wrap"><code>app=nginx-pod</code></span><span class="inline-wrap">的标签</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>deployment.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment      
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span> 
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f deployment.yaml</span>
deployment.apps/pc-deployment created

<span class="token comment"># 查看pod详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide --show-labels</span>
NAME                             READY   STATUS     IP            NODE     LABELS
pc-deployment-66cb59b984-8p84h   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.1.39   node1    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
pc-deployment-66cb59b984-vx8vx   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.2.33   node2    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
pc-deployment-66cb59b984-wnncx   <span class="token number">1</span>/1     Running    <span class="token number">10.244</span>.1.40   node1    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># 为了方便后面的测试，修改下三台nginx的index.html页面（三台修改的IP地址不一致）</span>
<span class="token comment"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
<span class="token comment"># echo "10.244.2.4" > /usr/share/nginx/html/index.html</span>

<span class="token comment">#修改完毕之后，访问测试</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.1.39</span>
<span class="token number">10.244</span>.1.39
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.33</span>
<span class="token number">10.244</span>.2.33
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.1.40</span>
<span class="token number">10.244</span>.1.40</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——ClusterIP<span class="jill"></span>类型的<span class="jill"></span>Service</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>service-clusterip.yaml<span class="jill"></span>文件</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>clusterip
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97 <span class="token comment"># service的ip地址，如果不写，默认会生成一个</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token comment"># Service端口       </span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># pod端口</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-clusterip.yaml</span>
service/service-clusterip created

<span class="token comment"># 查看service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev -o wide</span>
NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
service-clusterip   ClusterIP   <span class="token number">10.97</span>.97.97   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP    13s   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># 查看service的详细信息</span>
<span class="token comment"># 在这里有一个Endpoints列表，里面就是当前service可以负载到的服务入口</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc service-clusterip -n dev</span>
Name:              service-clusterip
Namespace:         dev
Labels:            <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
Type:              ClusterIP
IP:                <span class="token number">10.97</span>.97.97
Port:              <span class="token operator">&lt;</span>unset<span class="token operator">></span>  <span class="token number">80</span>/TCP
TargetPort:        <span class="token number">80</span>/TCP
Endpoints:         <span class="token number">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80
Session Affinity:  None
Events:            <span class="token operator">&lt;</span>none<span class="token operator">></span>

<span class="token comment"># 查看ipvs的映射规则</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
TCP  <span class="token number">10.97</span>.97.97:80 rr
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

<span class="token comment"># 访问10.97.97.97:80观察效果</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.97.97.97:80</span>
<span class="token number">10.244</span>.2.33</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——Endpoint</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Endpoint<span class="jill"></span>是<span class="jill"></span>kubernetes<span class="jill"></span>中的一个资源对象，存储在<span class="jill"></span>etcd<span class="jill"></span>中，用来记录一个<span class="jill"></span>service<span class="jill"></span>对应的所有<span class="jill"></span>pod<span class="jill"></span>的访问地址，它是根据<span class="jill"></span>service<span class="jill"></span>配置文件中<span class="jill"></span>selector<span class="jill"></span>描述产生的。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">一个<span class="jill"></span>Service<span class="jill"></span>由一组<span class="jill"></span>Pod<span class="jill"></span>组成，这些<span class="jill"></span>Pod<span class="jill"></span>通过<span class="jill"></span>Endpoints<span class="jill"></span>暴露出来，</span><span class="inline-wrap"><b>Endpoints<span class="jill"></span>是实现实际服务的端点集合</b></span><span class="inline-wrap">。换句话说，service<span class="jill"></span>和<span class="jill"></span>pod<span class="jill"></span>之间的联系是通过<span class="jill"></span>endpoints<span class="jill"></span>实现的。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/25/20220225235511684.png" style="width: 724.6666666666666px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>负载分发策略</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">对<span class="jill"></span>Service<span class="jill"></span>的访问被分发到了后端的<span class="jill"></span>Pod<span class="jill"></span>上去，目前<span class="jill"></span>kubernetes<span class="jill"></span>提供了两种负载分发策略：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">如果不定义，默认使用<span class="jill"></span>kube-proxy<span class="jill"></span>的策略，比如随机、轮询</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个<span class="jill"></span>Pod<span class="jill"></span>上</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">此模式可以使在<span class="jill"></span>spec<span class="jill"></span>中添加</span><span class="inline-wrap"><code>sessionAffinity:ClientIP</code></span><span class="inline-wrap">选项</span></div></div></li></ul><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 查看ipvs的映射规则【rr 轮询】</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
TCP  <span class="token number">10.97</span>.97.97:80 rr
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

<span class="token comment"># 循环访问测试</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># while true;do curl 10.97.97.97:80; sleep 5; done;</span>
<span class="token number">10.244</span>.1.40
<span class="token number">10.244</span>.1.39
<span class="token number">10.244</span>.2.33
<span class="token number">10.244</span>.1.40
<span class="token number">10.244</span>.1.39
<span class="token number">10.244</span>.2.33

<span class="token comment"># 修改分发策略----sessionAffinity:ClientIP</span>

<span class="token comment"># 查看ipvs规则【persistent 代表持久】</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -Ln</span>
TCP  <span class="token number">10.97</span>.97.97:80 rr persistent <span class="token number">10800</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.39:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.1.40:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">></span> <span class="token number">10.244</span>.2.33:80               Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>

<span class="token comment"># 循环访问测试</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># while true;do curl 10.97.97.97; sleep 5; done;</span>
<span class="token number">10.244</span>.2.33
<span class="token number">10.244</span>.2.33
<span class="token number">10.244</span>.2.33
  
<span class="token comment"># 删除service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f service-clusterip.yaml</span>
<span class="token function">service</span> <span class="token string">"service-clusterip"</span> deleted</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——HeadLiness<span class="jill"></span>类型的<span class="jill"></span>Service</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在某些场景中，开发人员可能不想使用<span class="jill"></span>Service<span class="jill"></span>提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes<span class="jill"></span>提供了<span class="jill"></span>HeadLiness Service，这类<span class="jill"></span>Service<span class="jill"></span>不会分配<span class="jill"></span>Cluster IP，如果想要访问<span class="jill"></span>service，只能通过<span class="jill"></span>service<span class="jill"></span>的域名进行查询。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>service-headliness.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>headliness
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None <span class="token comment"># 将clusterIP设置为None，即可创建headliness Service</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-headliness.yaml</span>
service/service-headliness created

<span class="token comment"># 获取service， 发现CLUSTER-IP未分配</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc service-headliness -n dev -o wide</span>
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE   SELECTOR
service-headliness   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP    11s   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># 查看service详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc service-headliness  -n dev</span>
Name:              service-headliness
Namespace:         dev
Labels:            <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Selector:          <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod
Type:              ClusterIP
IP:                None
Port:              <span class="token operator">&lt;</span>unset<span class="token operator">></span>  <span class="token number">80</span>/TCP
TargetPort:        <span class="token number">80</span>/TCP
Endpoints:         <span class="token number">10.244</span>.1.39:80,10.244.1.40:80,10.244.2.33:80
Session Affinity:  None
Events:            <span class="token operator">&lt;</span>none<span class="token operator">></span>

<span class="token comment"># 查看域名的解析情况</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
/ <span class="token comment"># cat /etc/resolv.conf</span>
nameserver <span class="token number">10.96</span>.0.10
search dev.svc.cluster.local svc.cluster.local cluster.local

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span>
service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.1.40
service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.1.39
service-headliness.dev.svc.cluster.local. <span class="token number">30</span> IN A <span class="token number">10.244</span>.2.33</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——NodePort<span class="jill"></span>类型的<span class="jill"></span>Service</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在之前的样例中，创建的<span class="jill"></span>Service<span class="jill"></span>的<span class="jill"></span>ip<span class="jill"></span>地址只有集群内部才可以访问，如果希望将<span class="jill"></span>Service<span class="jill"></span>暴露给集群外部使用，那么就要使用到另外一种类型的<span class="jill"></span>Service，称为<span class="jill"></span>NodePort<span class="jill"></span>类型。NodePort<span class="jill"></span>的工作原理其实就是</span><span class="inline-wrap"><b>将<span class="jill"></span>service<span class="jill"></span>的端口映射到<span class="jill"></span>Node<span class="jill"></span>的一个端口上</b></span><span class="inline-wrap">，然后就可以通过</span><span class="inline-wrap"><code>NodeIp:NodePort</code></span><span class="inline-wrap">来访问<span class="jill"></span>service<span class="jill"></span>了。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226003218450.png" style="width: 362px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>service-nodeport.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>nodeport
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># service类型</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30002</span> <span class="token comment"># 指定绑定的node的端口(默认的取值范围是：30000-32767), 如果不指定，会默认分配</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f service-nodeport.yaml</span>
service/service-nodeport created

<span class="token comment"># 查看service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev -o wide</span>
NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>       SELECTOR
service-nodeport   NodePort   <span class="token number">10.105</span>.64.191   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30002/TCP  <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-pod

<span class="token comment"># 接下来可以通过电脑主机的浏览器去访问集群中任意一个nodeip的30002端口，即可访问到pod</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——LoadBalancer<span class="jill"></span>类型的<span class="jill"></span>Service</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">LoadBalancer<span class="jill"></span>和<span class="jill"></span>NodePort<span class="jill"></span>很相似，目的都是向外部暴露一个端口，区别在于<span class="jill"></span>LoadBalancer<span class="jill"></span>会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/25/20220225235904349.png" style="width: 734px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">——ExternalName<span class="jill"></span>类型的<span class="jill"></span>Service</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">ExternalName<span class="jill"></span>类型的<span class="jill"></span>Service<span class="jill"></span>用于引入集群外部的服务，它通过</span><span class="inline-wrap"><code>externalName</code></span><span class="inline-wrap">属性指定外部一个服务的地址，然后在集群内部访问此<span class="jill"></span>service<span class="jill"></span>就可以访问到外部的服务了。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226003240866.png" style="width: 519.3333333333334px"/></figure></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre>apiVersion: v1
kind: Service
metadata:
  name: service-externalname
  namespace: dev
spec:
  type: ExternalName <span class="token comment"># service类型</span>
  externalName: www.baidu.com  <span class="token comment">#改成ip地址也可以</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建service</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  create -f service-externalname.yaml</span>
service/service-externalname created

<span class="token comment"># 域名解析</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span>
service-externalname.dev.svc.cluster.local. <span class="token number">30</span> IN CNAME www.baidu.com.
www.baidu.com.          <span class="token number">30</span>      IN      CNAME   www.a.shifen.com.
www.a.shifen.com.       <span class="token number">30</span>      IN      A       <span class="token number">39.156</span>.66.18
www.a.shifen.com.       <span class="token number">30</span>      IN      A       <span class="token number">39.156</span>.66.14</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">最后：对于<span class="jill"></span>pod<span class="jill"></span>内访问其它<span class="jill"></span>service ，还可以用：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">nginx.dev.svc.cluster.local 进行访问<span class="jill"></span>svc</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">(svcName.namespace.svc.cluster.local)</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">7.4 Ingress<span class="jill"></span>介绍</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在前面课程中已经提到，Service<span class="jill"></span>对集群之外暴露服务的主要方式有两种：NotePort<span class="jill"></span>和<span class="jill"></span>LoadBalancer，但是这两种方式，都有一定的缺点：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">NodePort<span class="jill"></span>方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">LB<span class="jill"></span>方式的缺点是每个<span class="jill"></span>service<span class="jill"></span>需要一个<span class="jill"></span>LB，浪费、麻烦，并且需要<span class="jill"></span>kubernetes<span class="jill"></span>之外设备的支持</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">基于这种现状，kubernetes<span class="jill"></span>提供了<span class="jill"></span>Ingress<span class="jill"></span>资源对象，Ingress<span class="jill"></span>只需要一个<span class="jill"></span>NodePort<span class="jill"></span>或者一个<span class="jill"></span>LB<span class="jill"></span>就可以满足暴露多个<span class="jill"></span>Service<span class="jill"></span>的需求。工作机制大致如下图表示：</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/25/20220225235904483.png" style="width: 661.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">实际上，Ingress<span class="jill"></span>相当于一个<span class="jill"></span>7<span class="jill"></span>层的负载均衡器，是<span class="jill"></span>kubernetes<span class="jill"></span>对反向代理的一个抽象，它的工作原理类似于<span class="jill"></span>Nginx，可以理解成在</span><span class="inline-wrap"><b>Ingress<span class="jill"></span>里建立诸多映射规则，Ingress Controller<span class="jill"></span>通过监听这些配置规则并转化成<span class="jill"></span>Nginx<span class="jill"></span>的反向代理配置 , 然后对外部提供服务</b></span><span class="inline-wrap">。在这里有两个核心概念：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ingress：kubernetes<span class="jill"></span>中的一个对象，作用是定义请求如何转发到<span class="jill"></span>service<span class="jill"></span>的规则</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ingress controller：具体实现反向代理及负载均衡的程序，对<span class="jill"></span>ingress<span class="jill"></span>定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如<span class="jill"></span>Nginx, Contour, Haproxy<span class="jill"></span>等等</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">Ingress（以<span class="jill"></span>Nginx<span class="jill"></span>为例）的工作原理如下：</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">用户编写<span class="jill"></span>Ingress<span class="jill"></span>规则，说明哪个域名对应<span class="jill"></span>kubernetes<span class="jill"></span>集群中的哪个<span class="jill"></span>Service</span></li><li><div class="marker"></div><span class="inline-wrap">Ingress<span class="jill"></span>控制器动态感知<span class="jill"></span>Ingress<span class="jill"></span>服务规则的变化，然后生成一段对应的<span class="jill"></span>Nginx<span class="jill"></span>反向代理配置</span></li><li><div class="marker"></div><span class="inline-wrap">Ingress<span class="jill"></span>控制器会将生成的<span class="jill"></span>Nginx<span class="jill"></span>配置写入到一个运行着的<span class="jill"></span>Nginx<span class="jill"></span>服务中，并动态更新</span></li><li><div class="marker"></div><span class="inline-wrap">到此为止，其实真正在工作的就是一个<span class="jill"></span>Nginx<span class="jill"></span>了，内部配置了用户定义的请求转发规则</span></li></ol><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226003254007.png" style="width: 604px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——环境准备 搭建<span class="jill"></span>ingress<span class="jill"></span>环境</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Makefile" class="marker"></div><pre><span class="token comment"># 创建文件夹</span>
[root<span class="token operator">@</span>k8s-master01 ~]<span class="token comment"># mkdir ingress-controller</span>
[root<span class="token operator">@</span>k8s-master01 ~]<span class="token comment"># cd ingress-controller/</span>

<span class="token comment"># 获取ingress-nginx，本次案例使用的是0.30版本</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span>

<span class="token comment"># 修改mandatory.yaml文件中的仓库</span>
<span class="token comment"># 修改quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span>
<span class="token comment"># 为quay.mirrors.ustc.edu.cn/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span>
<span class="token comment"># 创建ingress-nginx</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl apply -f ./</span>

<span class="token comment"># 查看ingress-nginx</span>
kubectl create -f mandatory.yaml

[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl get pod -n ingress-nginx</span>
NAME                                           READY   STATUS    RESTARTS   AGE
pod/nginx-ingress-controller-fbf967dd5-4qpbp   1/1     Running   0          12h

<span class="token comment"># 查看service</span>
[root<span class="token operator">@</span>k8s-master01 ingress-controller]<span class="token comment"># kubectl get svc -n ingress-nginx</span>
NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                      AGE
<span class="token symbol">ingress-nginx   NodePort   10.98.75.163   &lt;none>        80</span><span class="token punctuation">:</span>32240/TCP,443<span class="token punctuation">:</span>31335/TCP   11h</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——准备<span class="jill"></span>service<span class="jill"></span>和<span class="jill"></span>pod</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">为了后面的实验比较方便，创建如下图所示的模型</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226003307457.png" style="width: 606.6666666666666px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>tomcat-nginx.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
        <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>8.5<span class="token punctuation">-</span>jre10<span class="token punctuation">-</span>slim
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f tomcat-nginx.yaml</span>

<span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n dev</span>
NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
nginx-service    ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP     48s
tomcat-service   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8080</span>/TCP   48s</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——Http<span class="jill"></span>代理</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>ingress-http.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>http
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f ingress-http.yaml</span>
ingress.extensions/ingress-http created

<span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ing ingress-http -n dev</span>
NAME           HOSTS                                  ADDRESS   PORTS   AGE
ingress-http   nginx.itheima.com,tomcat.itheima.com             <span class="token number">80</span>      22s

<span class="token comment"># 查看详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ing ingress-http  -n dev</span>
<span class="token punctuation">..</span>.
Rules:
Host                Path  Backends
----                ----  --------
nginx.itheima.com   / nginx-service:80 <span class="token punctuation">(</span><span class="token number">10.244</span>.1.96:80,10.244.1.97:80,10.244.2.112:80<span class="token punctuation">)</span>
tomcat.itheima.com  / tomcat-service:8080<span class="token punctuation">(</span><span class="token number">10.244</span>.1.94:8080,10.244.1.95:8080,10.244.2.111:8080<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.

<span class="token comment"># 接下来,在本地电脑上配置host文件,解析上面的两个域名到192.168.109.100(master)上</span>
<span class="token comment"># 然后,就可以分别访问tomcat.itheima.com:32240  和  nginx.itheima.com:32240 查看效果了</span>
<span class="token comment"># 域名的端口http与https不同：kubectl get svc -n ingress-nginx</span>
kubectl get svc -n ingress-nginx
</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——Https<span class="jill"></span>代理</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建证书</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 生成证书</span>
openssl req -x509 -sha256 -nodes -days <span class="token number">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="token string">"/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com"</span>

<span class="token comment"># 创建密钥</span>
kubectl create secret tls tls-secret --key tls.key --cert tls.crt</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>ingress-https.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>https
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx.itheima.com
      <span class="token punctuation">-</span> tomcat.itheima.com
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>secret <span class="token comment"># 指定秘钥</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.itheima.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f ingress-https.yaml</span>
ingress.extensions/ingress-https created

<span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ing ingress-https -n dev</span>
NAME            HOSTS                                  ADDRESS         PORTS     AGE
ingress-https   nginx.itheima.com,tomcat.itheima.com   <span class="token number">10.104</span>.184.38   <span class="token number">80</span>, <span class="token number">443</span>   2m42s

<span class="token comment"># 查看详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe ing ingress-https -n dev</span>
<span class="token punctuation">..</span>.
TLS:
  tls-secret terminates nginx.itheima.com,tomcat.itheima.com
Rules:
Host              Path Backends
----              ---- --------
nginx.itheima.com  /  nginx-service:80 <span class="token punctuation">(</span><span class="token number">10.244</span>.1.97:80,10.244.1.98:80,10.244.2.119:80<span class="token punctuation">)</span>
tomcat.itheima.com /  tomcat-service:8080<span class="token punctuation">(</span><span class="token number">10.244</span>.1.99:8080,10.244.2.117:8080,10.244.2.120:8080<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.

<span class="token comment"># 下面可以通过浏览器访问https://nginx.itheima.com:31335 和 https://tomcat.itheima.com:31335来查看了</span>
<span class="token comment"># 域名的端口http与https不同：kubectl get svc -n ingress-nginx</span>
kubectl get svc -n ingress-nginx
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h3 class="wolai-block"><span class="inline-wrap">5.4 数据存储</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在前面已经提到，容器的生命周期可能很短，会被频繁地创建和销毁。那么容器在销毁时，保存在容器中的数据也会被清除。这种结果对用户来说，在某些情况下是不乐意看到的。为了持久化保存容器的数据，kubernetes<span class="jill"></span>引入了<span class="jill"></span>Volume<span class="jill"></span>的概念。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Volume<span class="jill"></span>是<span class="jill"></span>Pod<span class="jill"></span>中能够被多个容器访问的共享目录，它被定义在<span class="jill"></span>Pod<span class="jill"></span>上，然后被一个<span class="jill"></span>Pod<span class="jill"></span>里的多个容器挂载到具体的文件目录下，kubernetes<span class="jill"></span>通过<span class="jill"></span>Volume<span class="jill"></span>实现同一个<span class="jill"></span>Pod<span class="jill"></span>中不同容器之间的数据共享以及数据的持久化存储。Volume<span class="jill"></span>的生命容器不与<span class="jill"></span>Pod<span class="jill"></span>中单个容器的生命周期相关，当容器终止或者重启时，Volume<span class="jill"></span>中的数据也不会丢失。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">kubernetes<span class="jill"></span>的<span class="jill"></span>Volume<span class="jill"></span>支持多种类型，比较常见的有下面几个：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">简单存储：EmptyDir、HostPath、NFS</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">高级存储：PV、PVC</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">配置存储：ConfigMap、Secret</span></li></ul><h4 class="wolai-block"><span class="inline-wrap">1） 基本存储</span></h4><h4 class="wolai-block"><span class="inline-wrap">——EmptyDir</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">EmptyDir<span class="jill"></span>是最基础的<span class="jill"></span>Volume<span class="jill"></span>类型，一个<span class="jill"></span>EmptyDir<span class="jill"></span>就是<span class="jill"></span>Host<span class="jill"></span>上的一个空目录。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">EmptyDir<span class="jill"></span>是在<span class="jill"></span>Pod<span class="jill"></span>被分配到<span class="jill"></span>Node<span class="jill"></span>时创建的，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为<span class="jill"></span>kubernetes<span class="jill"></span>会</span><span class="red inline-wrap">自动分配一个目录</span><span class="inline-wrap">，当<span class="jill"></span>Pod<span class="jill"></span>销毁时， EmptyDir<span class="jill"></span>中的数据也会被永久删除。 EmptyDir<span class="jill"></span>用途如下：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，通过一个容器之间文件共享的案例来使用一下<span class="jill"></span>EmptyDir。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在一个<span class="jill"></span>Pod<span class="jill"></span>中准备两个容器<span class="jill"></span>nginx<span class="jill"></span>和<span class="jill"></span>busybox，然后声明一个<span class="jill"></span>Volume<span class="jill"></span>分别挂在到两个容器的目录中，然后<span class="jill"></span>nginx<span class="jill"></span>容器负责向<span class="jill"></span>Volume<span class="jill"></span>中写日志，busybox<span class="jill"></span>中通过命令将日志内容读到控制台。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226145948189.png" style="width: 647.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个<span class="jill"></span>volume-emptydir.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>emptydir
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将logs-volume挂在到nginx容器中，对应的目录为 /var/log/nginx</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> <span class="token comment"># 初始命令，动态读取指定文件中内容</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>  <span class="token comment"># 将logs-volume 挂在到busybox容器中，对应的目录为 /logs</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 声明volume， name为logs-volume，类型为emptyDir</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-emptydir.yaml</span>
pod/volume-emptydir created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-emptydir -n dev -o wide</span>
NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> 
volume-emptydir       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          97s   <span class="token number">10.42</span>.2.9   node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># 通过podIp访问nginx</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.42.2.9</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment"># 通过kubectl logs命令查看指定容器的标准输出</span>
<span class="token comment"># 下面的-f volume-emptydir,volume-emptydir不是文件</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f volume-emptydir -n dev -c busybox  </span>
<span class="token number">10.42</span>.1.0 - - <span class="token punctuation">[</span><span class="token number">27</span>/Jun/2021:15:08:54 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——HostPath</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">上节课提到，EmptyDir<span class="jill"></span>中数据不会被持久化，它会随着<span class="jill"></span>Pod<span class="jill"></span>的结束而销毁，如果想简单的将数据持久化到主机中，可以选择<span class="jill"></span>HostPath。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">HostPath 就是将<span class="jill"></span>Node<span class="jill"></span>主机中一个实际目录挂在到<span class="jill"></span>Pod<span class="jill"></span>中，以供容器使用，这样的设计就可以保证<span class="jill"></span>Pod<span class="jill"></span>销毁了，但是数据依据可以存在于<span class="jill"></span>Node<span class="jill"></span>主机上。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/25/20220225235912075.png" style="width: 753.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建一个<span class="jill"></span>volume-hostpath.yaml：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>hostpath
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> 
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/logs
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate  <span class="token comment"># 目录存在就使用，不存在就先创建后使用</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>关于type的值的一点说明：
    DirectoryOrCreate 目录存在就使用，不存在就先创建后使用
    Directory   目录必须存在
    FileOrCreate  文件存在就使用，不存在就先创建后使用
    File 文件必须存在 
    Socket  unix套接字必须存在
    CharDevice  字符设备必须存在
    BlockDevice 块设备必须存在</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-hostpath.yaml</span>
pod/volume-hostpath created

<span class="token comment"># 查看Pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-hostpath -n dev -o wide</span>
NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
pod-volume-hostpath   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          16s   <span class="token number">10.42</span>.2.10     node1  <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>

<span class="token comment">#访问nginx</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># curl 10.42.2.10</span>

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f volume-emptydir -n dev -c busybox</span>
<span class="token comment"># !!接下来就可以查看pod部署的主机 "node1" 上的/root/logs 目录下查看存储的文件了</span>
<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ls /root/logs/</span>
access.log  error.log

<span class="token comment"># 同样的道理，如果在此目录下创建一个文件，到容器中也是可以看到的</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——NFS</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">HostPath<span class="jill"></span>可以解决数据持久化的问题，但是一旦<span class="jill"></span>Node<span class="jill"></span>节点故障了，Pod<span class="jill"></span>如果转移到了别的节点，又会出现问题了，此时需要准备单独的网络存储系统，比较常用的用<span class="jill"></span>NFS、CIFS。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">NFS<span class="jill"></span>是一个网络文件存储系统，可以搭建一台<span class="jill"></span>NFS<span class="jill"></span>服务器，然后将<span class="jill"></span>Pod<span class="jill"></span>中的存储直接连接到<span class="jill"></span>NFS<span class="jill"></span>系统上，这样的话，无论<span class="jill"></span>Pod<span class="jill"></span>在节点上怎么转移，只要<span class="jill"></span>Node<span class="jill"></span>跟<span class="jill"></span>NFS<span class="jill"></span>的对接没问题，数据就可以成功访问。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150004128.png" style="width: 864px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1）首先要准备<span class="jill"></span>nfs<span class="jill"></span>的服务器，这里为了简单，直接是<span class="jill"></span>master<span class="jill"></span>节点做<span class="jill"></span>nfs<span class="jill"></span>服务器</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 在nfs上安装nfs服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># yum install nfs-utils -y</span>

<span class="token comment"># 准备一个共享目录</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkdir /root/data/nfs -pv</span>

<span class="token comment"># 将共享目录以读写权限暴露给192.168.5.0/24网段中的所有主机</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/exports #追加下面一行信息</span>
/root/data/nfs     <span class="token number">192.168</span>.109.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>

<span class="token comment"># 启动nfs服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart nfs</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）接下来，要在的每个<span class="jill"></span>node<span class="jill"></span>节点上都安装下<span class="jill"></span>nfs，这样的目的是为了<span class="jill"></span>node<span class="jill"></span>节点可以驱动<span class="jill"></span>nfs<span class="jill"></span>设备</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 在node上安装nfs服务，注意不需要启动</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install nfs-utils -y</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）接下来，就可以编写<span class="jill"></span>pod<span class="jill"></span>的配置文件了，创建<span class="jill"></span>volume-nfs.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>nfs
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"tail -f /logs/access.log"</span><span class="token punctuation">]</span> 
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /logs
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs<span class="token punctuation">-</span>volume
    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100  <span class="token comment">#nfs服务器地址</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/nfs <span class="token comment">#共享文件路径</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">4）最后，运行下<span class="jill"></span>pod，观察结果</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f volume-nfs.yaml</span>
pod/volume-nfs created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods volume-nfs -n dev</span>
NAME                  READY   STATUS    RESTARTS   AGE
volume-nfs        <span class="token number">2</span>/2     Running   <span class="token number">0</span>          2m9s

<span class="token comment"># 查看nfs服务器上的共享目录，发现已经有文件了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># ls /root/data/nfs</span>
access.log  error.log</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">2）高级存储</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">前面已经学习了使用<span class="jill"></span>NFS<span class="jill"></span>提供存储，此时就要求用户会搭建<span class="jill"></span>NFS<span class="jill"></span>系统，并且会在<span class="jill"></span>yaml<span class="jill"></span>配置<span class="jill"></span>nfs。由于<span class="jill"></span>kubernetes<span class="jill"></span>支持的存储系统有很多，要求客户全都掌握，显然不现实。为了能够屏蔽底层存储实现的细节，方便用户使用， kubernetes<span class="jill"></span>引入<span class="jill"></span>PV<span class="jill"></span>和<span class="jill"></span>PVC<span class="jill"></span>两种资源对象。</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">PV（Persistent Volume）是持久化卷的意思，是对底层的共享存储的一种抽象。一般情况下<span class="jill"></span>PV<span class="jill"></span>由<span class="jill"></span>kubernetes<span class="jill"></span>管理员进行创建和配置，它与底层具体的共享存储技术有关，并通过插件完成与共享存储的对接。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">PVC（Persistent Volume Claim）是持久卷声明的意思，是用户对于存储需求的一种声明。换句话说，PVC<span class="jill"></span>其实就是用户向<span class="jill"></span>kubernetes<span class="jill"></span>系统发出的一种资源需求申请。</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150009412.png" style="width: 732.6666666666666px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用了<span class="jill"></span>PV<span class="jill"></span>和<span class="jill"></span>PVC<span class="jill"></span>之后，工作可以得到进一步的细分：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">存储：存储工程师维护</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">PV： kubernetes<span class="jill"></span>管理员维护</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">PVC：kubernetes<span class="jill"></span>用户维护</span></li></ul><h4 class="wolai-block"><span class="inline-wrap">——PV</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">PV<span class="jill"></span>是存储资源的抽象，下面是资源清单文件:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1  
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span> <span class="token comment"># 存储类型，与底层真正存储对应</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>  <span class="token comment"># 存储能力，目前只支持存储空间的设置</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>  <span class="token comment"># 访问模式</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span>
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> <span class="token comment"># 回收策略</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">PV 的关键配置参数说明：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>存储类型</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">底层实际存储的类型，kubernetes<span class="jill"></span>支持多种存储类型，每种存储类型的配置都有所差异</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>存储能力（capacity）</b></span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">目前只支持存储空间的设置( storage=1Gi )，不过未来可能会加入<span class="jill"></span>IOPS、吞吐量等指标的配置</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>访问模式（accessModes）</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">用于描述用户应用对存储资源的访问权限，访问权限包括下面几种方式：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ReadWriteOnce（RWO）：读写权限，但是只能被单个节点挂载</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ReadOnlyMany（ROX）： 只读权限，可以被多个节点挂载</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ReadWriteMany（RWX）：读写权限，可以被多个节点挂载</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>需要注意的是，底层不同的存储类型可能支持的访问模式不同</code></span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>回收策略（persistentVolumeReclaimPolicy）</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">当<span class="jill"></span>PV<span class="jill"></span>不再被使用了之后，对其的处理方式。目前支持三种策略：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Retain （保留） 保留数据，需要管理员手工清理数据</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Recycle（回收） 清除 PV 中的数据，效果相当于执行 rm -rf /thevolume/*</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Delete （删除） 与 PV 相连的后端存储完成 volume 的删除操作，当然这常见于云服务商的存储服务</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>需要注意的是，底层不同的存储类型可能支持的回收策略不同</code></span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>存储类别</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">PV<span class="jill"></span>可以通过<span class="jill"></span>storageClassName<span class="jill"></span>参数指定一个存储类别</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">具有特定类别的<span class="jill"></span>PV<span class="jill"></span>只能与请求了该类别的<span class="jill"></span>PVC<span class="jill"></span>进行绑定</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">未设定类别的<span class="jill"></span>PV<span class="jill"></span>则只能与不请求任何类别的<span class="jill"></span>PVC<span class="jill"></span>进行绑定</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>状态（status）</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">一个 PV 的生命周期中，可能会处于<span class="jill"></span>4<span class="jill"></span>中不同的阶段：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Available（可用）： 表示可用状态，还未被任何 PVC 绑定</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Bound（已绑定）： 表示 PV 已经被 PVC 绑定</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Released（已释放）： 表示 PVC 被删除，但是资源还未被集群重新声明</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Failed（失败）： 表示该 PV 的自动回收失败</span></li></ul></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>实验</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用<span class="jill"></span>NFS<span class="jill"></span>作为存储，来演示<span class="jill"></span>PV<span class="jill"></span>的使用，创建<span class="jill"></span>3<span class="jill"></span>个<span class="jill"></span>PV，对应<span class="jill"></span>NFS<span class="jill"></span>中的<span class="jill"></span>3<span class="jill"></span>个暴露的路径。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1) 准备<span class="jill"></span>NFS<span class="jill"></span>环境</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建目录</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># mkdir /root/data/{pv1,pv2,pv3} -pv</span>

<span class="token comment"># 暴露服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/exports</span>
/root/data/pv1     <span class="token number">192.168</span>.109.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>
/root/data/pv2     <span class="token number">192.168</span>.109.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>
/root/data/pv3     <span class="token number">192.168</span>.109.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>

<span class="token comment"># 重启服务</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment">#  systemctl restart nfs</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2) 创建<span class="jill"></span>pv.yaml</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv1
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv2
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100
    
<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  pv3
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span> 
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 3Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/data/pv3
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.109.100</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建 pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pv.yaml</span>
persistentvolume/pv1 created
persistentvolume/pv2 created
persistentvolume/pv3 created

<span class="token comment"># 查看pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -o wide</span>
NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE
pv1    1Gi        RWX            Retain        Available    10s   Filesystem
pv2    2Gi        RWX            Retain        Available    10s   Filesystem
pv3    3Gi        RWX            Retain        Available    9s    Filesystem</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——PVC</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">PVC<span class="jill"></span>是资源的申请，用来声明对存储空间、访问模式、存储类别需求信息。下面是资源清单文件:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token comment"># 访问模式</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 采用标签对PV选择</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token comment"># 存储类别</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 请求空间</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">PVC 的关键配置参数说明：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>访问模式（accessModes）</b></span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">用于描述用户应用对存储资源的访问权限</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>选择条件（selector）</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">通过<span class="jill"></span>Label Selector<span class="jill"></span>的设置，可使<span class="jill"></span>PVC<span class="jill"></span>对于系统中己存在的<span class="jill"></span>PV<span class="jill"></span>进行筛选</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>存储类别（storageClassName）</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">PVC<span class="jill"></span>在定义时可以设定需要的后端存储的类别，只有设置了该<span class="jill"></span>class<span class="jill"></span>的<span class="jill"></span>pv<span class="jill"></span>才能被系统选出</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>资源请求（Resources ）</b></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">描述对存储资源的请求</span></div></div></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>实验</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1) 创建<span class="jill"></span>pvc.yaml，申请<span class="jill"></span>pv</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc3
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pvc.yaml</span>
persistentvolumeclaim/pvc1 created
persistentvolumeclaim/pvc2 created
persistentvolumeclaim/pvc3 created

<span class="token comment"># 查看pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc  -n dev -o wide</span>
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem
pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem
pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem

<span class="token comment"># 查看pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -o wide</span>
NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem
pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem
pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem   </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2) 创建<span class="jill"></span>pods.yaml, 使用<span class="jill"></span>pv</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod1 >> /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc1
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"while true;do echo pod2 >> /root/out.txt; sleep 10; done;"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc2
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pods.yaml</span>
pod/pod1 created
pod/pod2 created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   
pod1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.69   node1   
pod2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          14s   <span class="token number">10.244</span>.1.70   node1  

<span class="token comment"># 查看pvc</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc -n dev -o wide</span>
NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE
pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem
pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem
pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem

<span class="token comment"># 查看pv</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pv -n dev -o wide</span>
NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE
pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem
pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem
pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem

<span class="token comment"># 查看nfs中的文件存储</span>
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /root/data/pv1/out.txt</span>
node1
node1
<span class="token punctuation">[</span>root@nfs ~<span class="token punctuation">]</span><span class="token comment"># more /root/data/pv2/out.txt</span>
node2
node2</pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——生命周期</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">PVC<span class="jill"></span>和<span class="jill"></span>PV<span class="jill"></span>是一一对应的，PV<span class="jill"></span>和<span class="jill"></span>PVC<span class="jill"></span>之间的相互作用遵循以下生命周期：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>资源供应</b></span><span class="inline-wrap">：管理员手动创建底层存储和<span class="jill"></span>PV</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>资源绑定</b></span><span class="inline-wrap">：用户创建<span class="jill"></span>PVC，kubernetes<span class="jill"></span>负责根据<span class="jill"></span>PVC<span class="jill"></span>的声明去寻找<span class="jill"></span>PV，并绑定</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">在用户定义好<span class="jill"></span>PVC<span class="jill"></span>之后，系统将根据<span class="jill"></span>PVC<span class="jill"></span>对存储资源的请求在已存在的<span class="jill"></span>PV<span class="jill"></span>中选择一个满足条件的</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">一旦找到，就将该<span class="jill"></span>PV<span class="jill"></span>与用户定义的<span class="jill"></span>PVC<span class="jill"></span>进行绑定，用户的应用就可以使用这个<span class="jill"></span>PVC<span class="jill"></span>了</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">如果找不到，PVC<span class="jill"></span>则会无限期处于<span class="jill"></span>Pending<span class="jill"></span>状态，直到等到系统管理员创建了一个符合其要求的<span class="jill"></span>PV</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">PV<span class="jill"></span>一旦绑定到某个<span class="jill"></span>PVC<span class="jill"></span>上，就会被这个<span class="jill"></span>PVC<span class="jill"></span>独占，不能再与其他<span class="jill"></span>PVC<span class="jill"></span>进行绑定了</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>资源使用</b></span><span class="inline-wrap">：用户可在<span class="jill"></span>pod<span class="jill"></span>中像<span class="jill"></span>volume<span class="jill"></span>一样使用<span class="jill"></span>pvc</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">Pod<span class="jill"></span>使用<span class="jill"></span>Volume<span class="jill"></span>的定义，将<span class="jill"></span>PVC<span class="jill"></span>挂载到容器内的某个路径进行使用。</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>资源释放</b></span><span class="inline-wrap">：用户删除<span class="jill"></span>pvc<span class="jill"></span>来释放<span class="jill"></span>pv</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">当存储资源使用完毕后，用户可以删除<span class="jill"></span>PVC，与该<span class="jill"></span>PVC<span class="jill"></span>绑定的<span class="jill"></span>PV<span class="jill"></span>将会被标记为“已释放”，但还不能立刻与其他<span class="jill"></span>PVC<span class="jill"></span>进行绑定。通过之前<span class="jill"></span>PVC<span class="jill"></span>写入的数据可能还被留在存储设备上，只有在清除之后该<span class="jill"></span>PV<span class="jill"></span>才能再次使用。</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>资源回收</b></span><span class="inline-wrap">：kubernetes<span class="jill"></span>根据<span class="jill"></span>pv<span class="jill"></span>设置的回收策略进行资源的回收</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">对于<span class="jill"></span>PV，管理员可以设定回收策略，用于设置与之绑定的<span class="jill"></span>PVC<span class="jill"></span>释放资源之后如何处理遗留数据的问题。只有<span class="jill"></span>PV<span class="jill"></span>的存储空间完成回收，才能供新的<span class="jill"></span>PVC<span class="jill"></span>绑定和使用</span></div></div></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150021649.png" style="width: 812.6666666666666px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">3）配置存储</span></h4><h4 class="wolai-block"><span class="inline-wrap">——ConfigMap</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">ConfigMap<span class="jill"></span>是一种比较特殊的存储卷，它的主要作用是用来存储配置信息的。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建<span class="jill"></span>configmap.yaml，内容如下：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">info</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    username:admin
    password:123456</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，使用此配置文件创建<span class="jill"></span>configmap</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建configmap</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f configmap.yaml</span>
configmap/configmap created

<span class="token comment"># 查看configmap详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe cm configmap -n dev</span>
Name:         configmap
Namespace:    dev
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span>

Data
<span class="token operator">==</span><span class="token operator">==</span>
info:
----
username:admin
password:123456

Events:  <span class="token operator">&lt;</span>none<span class="token operator">></span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">接下来创建一个<span class="jill"></span>pod-configmap.yaml，将上面创建的<span class="jill"></span>configmap<span class="jill"></span>挂载进去</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>configmap
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将configmap挂载到目录</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /configmap/config
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment"># 引用configmap</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-configmap.yaml</span>
pod/pod-configmap created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-configmap -n dev</span>
NAME            READY   STATUS    RESTARTS   AGE
pod-configmap   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s

<span class="token comment">#进入容器</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pod-configmap -n dev /bin/sh</span>
<span class="token comment"># cd /configmap/config/</span>
<span class="token comment"># ls</span>
info
<span class="token comment"># more info</span>
username:admin
password:123456

<span class="token comment"># 可以看到映射已经成功，每个configmap都映射成了一个目录</span>
<span class="token comment"># key--->文件     value---->文件中的内容</span>
<span class="token comment"># 此时如果更新configmap的内容, 容器中的值也会动态更新</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">——Secret</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>kubernetes<span class="jill"></span>中，还存在一种和<span class="jill"></span>ConfigMap<span class="jill"></span>非常类似的对象，称为<span class="jill"></span>Secret<span class="jill"></span>对象。它主要用于存储敏感信息，例如密码、秘钥、证书等等。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">1) 首先使用<span class="jill"></span>base64<span class="jill"></span>对数据进行编码</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># echo -n 'admin' | base64 #准备username</span>
<span class="token assign-left variable">YWRtaW4</span><span class="token operator">=</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># echo -n '123456' | base64 #准备password</span>
MTIzNDU2</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2) 接下来编写<span class="jill"></span>secret.yaml，并创建<span class="jill"></span>Secret</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> YWRtaW4=
  <span class="token key atrule">password</span><span class="token punctuation">:</span> MTIzNDU2</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建secret</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f secret.yaml</span>
secret/secret created

<span class="token comment"># 查看secret详情</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe secret secret -n dev</span>
Name:         secret
Namespace:    dev
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
Type:  Opaque
Data
<span class="token operator">==</span><span class="token operator">==</span>
password:  <span class="token number">6</span> bytes
username:  <span class="token number">5</span> bytes</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3) 创建<span class="jill"></span>pod-secret.yaml，将上面创建的<span class="jill"></span>secret<span class="jill"></span>挂载进去：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>secret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment"># 将secret挂载到目录</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /secret/config
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> secret</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-secret.yaml</span>
pod/pod-secret created

<span class="token comment"># 查看pod</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-secret -n dev</span>
NAME            READY   STATUS    RESTARTS   AGE
pod-secret      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m28s

<span class="token comment"># 进入容器，查看secret信息，发现已经自动解码了</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it pod-secret /bin/sh -n dev</span>
/ <span class="token comment"># ls /secret/config/</span>
password  username
/ <span class="token comment"># more /secret/config/username</span>
admin
/ <span class="token comment"># more /secret/config/password</span>
<span class="token number">123456</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">至此，已经实现了利用<span class="jill"></span>secret<span class="jill"></span>实现了信息的编码。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">5.4 安全认证</span></h3><h4 class="wolai-block"><span class="inline-wrap">1）访问控制概述</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Kubernetes<span class="jill"></span>作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。所谓的安全性其实就是保证对<span class="jill"></span>Kubernetes<span class="jill"></span>的各种</span><span class="inline-wrap"><b>客户端</b></span><span class="inline-wrap">进行</span><span class="inline-wrap"><b>认证和鉴权</b></span><span class="inline-wrap">操作。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>客户端</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>Kubernetes<span class="jill"></span>集群中，客户端通常有两类：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>User Account</b></span><span class="inline-wrap">：一般是独立于<span class="jill"></span>kubernetes<span class="jill"></span>之外的其他服务管理的用户账号。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><b>Service Account</b></span><span class="inline-wrap">：kubernetes<span class="jill"></span>管理的账号，用于为<span class="jill"></span>Pod<span class="jill"></span>中的服务进程在访问<span class="jill"></span>Kubernetes<span class="jill"></span>时提供身份标识。</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150027635.png" style="width: 571.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>认证、授权与准入控制</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">ApiServer<span class="jill"></span>是访问及管理资源对象的唯一入口。任何一个请求访问<span class="jill"></span>ApiServer，都要经过下面三个流程：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Authentication（认证）：身份鉴别，只有正确的账号才能够通过认证</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Authorization（授权）： 判断用户是否有权限对访问的资源执行特定的动作</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Admission Control（准入控制）：用于补充授权机制以实现更加精细的访问控制功能。</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150031825.png" style="width: 678px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">2）认证管理</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Kubernetes<span class="jill"></span>集群安全的最关键点在于如何识别并认证客户端身份，它提供了<span class="jill"></span>3<span class="jill"></span>种客户端身份认证方式：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">HTTP Base<span class="jill"></span>认证：通过用户名<span class="jill"></span>+<span class="jill"></span>密码的方式认证</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>这种认证方式是把“用户名:密码”用BASE64算法进行编码后的字符串放在HTTP请求中的Header Authorization域里发送给服务端。服务端收到后进行解码，获取用户名及密码，然后进行用户身份认证的过程。</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">HTTP Token<span class="jill"></span>认证：通过一个<span class="jill"></span>Token<span class="jill"></span>来识别合法用户</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>这种认证方式是用一个很长的难以被模仿的字符串--Token来表明客户身份的一种方式。每个Token对应一个用户名，当客户端发起API调用请求时，需要在HTTP Header里放入Token，API Server接到Token后会跟服务器中保存的token进行比对，然后进行用户身份认证的过程。</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">HTTPS<span class="jill"></span>证书认证：基于<span class="jill"></span>CA<span class="jill"></span>根证书签名的双向数字证书认证方式</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>这种认证方式是安全性最高的一种方式，但是同时也是操作起来最麻烦的一种方式。
</pre></div></code-block></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150035435.png" style="width: 653.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>HTTPS<span class="jill"></span>认证大体分为<span class="jill"></span>3<span class="jill"></span>个过程：</b></span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">证书申请和下发</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>HTTPS通信双方的服务器向CA机构申请证书，CA机构下发根证书、服务端证书及私钥给申请者</pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">客户端和服务端的双向认证</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>1> 客户端向服务器端发起请求，服务端下发自己的证书给客户端，
   客户端接收到证书后，通过私钥解密证书，在证书中获得服务端的公钥，
   客户端利用服务器端的公钥认证证书中的信息，如果一致，则认可这个服务器
2> 客户端发送自己的证书给服务器端，服务端接收到证书后，通过私钥解密证书，
   在证书中获得客户端的公钥，并用该公钥认证证书信息，确认客户端是否合法</pre></div></code-block></li><li><div class="marker"></div><span class="inline-wrap">服务器端和客户端进行通信</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>服务器端和客户端协商好加密方案后，客户端会产生一个随机的秘钥并加密，然后发送到服务器端。
服务器端接收这个秘钥后，双方接下来通信的所有内容都通过该随机秘钥加密</pre></div></code-block></li></ol><blockquote class="wolai-block"><span class="inline-wrap">注意: Kubernetes<span class="jill"></span>允许同时配置多种认证方式，只要其中任意一个方式认证通过即可</span></blockquote><h4 class="wolai-block"><span class="inline-wrap">3）授权管理</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">授权发生在认证成功之后，通过认证就可以知道请求用户是谁， 然后<span class="jill"></span>Kubernetes<span class="jill"></span>会根据事先定义的授权策略来决定用户是否有权限访问，这个过程就称为授权。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">每个发送到<span class="jill"></span>ApiServer<span class="jill"></span>的请求都带上了用户和资源的信息：比如发送请求的用户、请求的路径、请求的动作等，授权就是根据这些信息和授权策略进行比较，如果符合策略，则认为授权通过，否则会返回错误。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">API Server<span class="jill"></span>目前支持以下几种授权策略：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">AlwaysDeny：表示拒绝所有请求，一般用于测试</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">AlwaysAllow：允许接收所有请求，相当于集群不需要授权流程（Kubernetes<span class="jill"></span>默认的策略）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ABAC：基于属性的访问控制，表示使用用户配置的授权规则对用户请求进行匹配和控制</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Webhook：通过调用外部<span class="jill"></span>REST<span class="jill"></span>服务对用户进行授权</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Node：是一种专用模式，用于对<span class="jill"></span>kubelet<span class="jill"></span>发出的请求进行访问控制</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">RBAC：基于角色的访问控制（kubeadm<span class="jill"></span>安装方式下的默认选项）</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">RBAC(Role-Based Access Control) 基于角色的访问控制，主要是在描述一件事情：</span><span class="inline-wrap"><b>给哪些对象授予了哪些权限</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">其中涉及到了下面几个概念：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">对象：User、Groups、ServiceAccount</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">角色：代表着一组定义在资源上的可操作动作(权限)的集合</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">绑定：将定义好的角色跟用户绑定在一起</span></li></ul><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150046794.png" style="width: 607.3333333333334px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">RBAC<span class="jill"></span>引入了<span class="jill"></span>4<span class="jill"></span>个顶级资源对象：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Role、ClusterRole：角色，用于指定一组权限</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">RoleBinding、ClusterRoleBinding：角色绑定，用于将角色（权限）赋予给对象</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Role、ClusterRole</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">一个角色就是一组权限的集合，这里的权限都是许可形式的（白名单）。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># Role只能对命名空间内的资源进行授权，需要指定nameapce</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>  <span class="token comment"># 支持的API组列表,"" 空字符串，表示核心API群</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span> <span class="token comment"># 支持的资源对象列表</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span> <span class="token comment"># 允许的对资源对象的操作方法列表</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># ClusterRole可以对集群范围内资源、跨namespaces的范围资源、非资源类型进行授权</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">需要详细说明的是，rules<span class="jill"></span>中的参数：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">apiGroups: 支持的<span class="jill"></span>API<span class="jill"></span>组列表</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token string">""</span>,<span class="token string">"apps"</span>, <span class="token string">"autoscaling"</span>, <span class="token string">"batch"</span></pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">resources：支持的资源对象列表</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token string">"services"</span>, <span class="token string">"endpoints"</span>, <span class="token string">"pods"</span>,<span class="token string">"secrets"</span>,<span class="token string">"configmaps"</span>,<span class="token string">"crontabs"</span>,<span class="token string">"deployments"</span>,<span class="token string">"jobs"</span>,
<span class="token string">"nodes"</span>,<span class="token string">"rolebindings"</span>,<span class="token string">"clusterroles"</span>,<span class="token string">"daemonsets"</span>,<span class="token string">"replicasets"</span>,<span class="token string">"statefulsets"</span>,
<span class="token string">"horizontalpodautoscalers"</span>,<span class="token string">"replicationcontrollers"</span>,<span class="token string">"cronjobs"</span></pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">verbs：对资源对象的操作方法列表</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token string">"get"</span>, <span class="token string">"list"</span>, <span class="token string">"watch"</span>, <span class="token string">"create"</span>, <span class="token string">"update"</span>, <span class="token string">"patch"</span>, <span class="token string">"delete"</span>, <span class="token string">"exec"</span></pre></div></code-block></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>RoleBinding、ClusterRoleBinding</b></span></div></div><div class="wolai-block wolai-text"><div><span class="red inline-wrap">角色绑定用来把一个角色绑定到一个目标对象上，绑定目标可以是<span class="jill"></span>User、Group<span class="jill"></span>或者<span class="jill"></span>ServiceAccount。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># RoleBinding可以将同一namespace中的subject绑定到某个Role下，则此subject即具有该Role定义的权限</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># ClusterRoleBinding在整个集群级别和所有namespaces将特定的subject与ClusterRole绑定，授予权限</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole<span class="token punctuation">-</span>binding
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>RoleBinding<span class="jill"></span>引用<span class="jill"></span>ClusterRole<span class="jill"></span>进行授权</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">RoleBinding<span class="jill"></span>可以引用<span class="jill"></span>ClusterRole，对属于同一命名空间内<span class="jill"></span>ClusterRole<span class="jill"></span>定义的资源主体进行授权。</span></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>一种很常用的做法就是，集群管理员为集群范围预定义好一组角色（ClusterRole），然后在多个命名空间中重复使用这些ClusterRole。这样可以大幅提高授权管理工作效率，也使得各个命名空间下的基础性授权规则与使用体验保持一致。</pre></div></code-block></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token comment"># 虽然authorization-clusterrole是一个集群角色，但是因为使用了RoleBinding</span>
<span class="token comment"># 所以heima只能读取dev命名空间中的资源</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding<span class="token punctuation">-</span>ns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> heima
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>clusterrole
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h4 class="wolai-block"><span class="inline-wrap">——</span><span class="red inline-wrap"><b>实战：创建一个只能管理<span class="jill"></span>dev<span class="jill"></span>空间下<span class="jill"></span>Pods<span class="jill"></span>资源的账号</b></span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">1) </span><span class="red inline-wrap">创建账号</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 1) 创建证书</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># cd /etc/kubernetes/pki/</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># (umask 077;openssl genrsa -out devman.key 2048)</span>

<span class="token comment"># 2) 用apiserver的证书去签署</span>
<span class="token comment"># 2-1) 签名申请，申请的用户是devman,组是devgroup</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl req -new -key devman.key -out devman.csr -subj "/CN=devman/O=devgroup"     </span>
<span class="token comment"># 2-2) 签署证书</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span>

<span class="token comment"># 3) 设置集群、用户、上下文信息</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https://192.168.109.100:6443</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span>

<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span>

<span class="token comment"># 切换账户到devman</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span>
Switched to context <span class="token string">"devman@kubernetes"</span><span class="token builtin class-name">.</span>

<span class="token comment"># 查看dev下pod，发现没有权限</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: pods is forbidden: User <span class="token string">"devman"</span> cannot list resource <span class="token string">"pods"</span> <span class="token keyword">in</span> API group <span class="token string">""</span> <span class="token keyword">in</span> the namespace <span class="token string">"dev"</span>

</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="red inline-wrap">2） 创建<span class="jill"></span>Role<span class="jill"></span>和<span class="jill"></span>RoleBinding，为<span class="jill"></span>devman<span class="jill"></span>用户授权</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 切换到admin账户</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span>
Switched to context <span class="token string">"kubernetes-admin@kubernetes"</span><span class="token builtin class-name">.</span>
<span class="token punctuation">[</span>root@k8s-master pki<span class="token punctuation">]</span><span class="token comment"># vim dev-role.yaml</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">dev-role.yaml：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="YAML" class="marker"></div><pre><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span>
  
<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authorization<span class="token punctuation">-</span>role<span class="token punctuation">-</span>binding
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> User
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devman
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dev<span class="token punctuation">-</span>role
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl create -f dev-role.yaml</span>
role.rbac.authorization.k8s.io/dev-role created
rolebinding.rbac.authorization.k8s.io/authorization-role-binding created</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="red inline-wrap">3) 切换账户，再次验证</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 切换账户到devman</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context devman@kubernetes</span>
Switched to context <span class="token string">"devman@kubernetes"</span><span class="token builtin class-name">.</span>

<span class="token comment"># 再次查看</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev</span>
NAME                                 READY   STATUS             RESTARTS   AGE
nginx-deployment-66cb59b984-8wp2k    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h
nginx-deployment-66cb59b984-dc46j    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h
nginx-deployment-66cb59b984-thfck    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          4d1h

<span class="token comment"># 为了不影响后面的学习,切回admin账户</span>
<span class="token punctuation">[</span>root@k8s-master01 pki<span class="token punctuation">]</span><span class="token comment"># kubectl config use-context kubernetes-admin@kubernetes</span>
Switched to context <span class="token string">"kubernetes-admin@kubernetes"</span><span class="token builtin class-name">.</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">4）准入控制</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">通过了前面的认证和授权之后，还需要经过准入控制处理通过之后，apiserver<span class="jill"></span>才会处理这个请求。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">准入控制是一个可配置的控制器列表，可以通过在<span class="jill"></span>Api-Server<span class="jill"></span>上通过命令行设置选择执行哪些准入控制器：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,
                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">只有当所有的准入控制器都检查通过之后，apiserver<span class="jill"></span>才执行该请求，否则返回拒绝。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">当前可配置的<span class="jill"></span>Admission Control<span class="jill"></span>准入控制如下：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">AlwaysAdmit：允许所有请求</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">AlwaysDeny：禁止所有请求，一般用于测试</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">AlwaysPullImages：在启动容器之前总去下载镜像</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">DenyExecOnPrivileged：它会拦截所有想在<span class="jill"></span>Privileged Container<span class="jill"></span>上执行命令的请求</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ImagePolicyWebhook：这个插件将允许后端的一个<span class="jill"></span>Webhook<span class="jill"></span>程序来完成<span class="jill"></span>admission controller<span class="jill"></span>的功能。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Service Account：实现<span class="jill"></span>ServiceAccount<span class="jill"></span>实现了自动化</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">SecurityContextDeny：这个插件将使用<span class="jill"></span>SecurityContext<span class="jill"></span>的<span class="jill"></span>Pod<span class="jill"></span>中的定义全部失效</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ResourceQuota：用于资源配额管理目的，观察所有请求，确保在<span class="jill"></span>namespace<span class="jill"></span>上的配额不会超标</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">LimitRanger：用于资源限制管理，作用于<span class="jill"></span>namespace<span class="jill"></span>上，确保对<span class="jill"></span>Pod<span class="jill"></span>进行资源限制</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">InitialResources：为未设置资源请求与限制的<span class="jill"></span>Pod，根据其镜像的历史资源的使用情况进行设置</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">NamespaceLifecycle：如果尝试在一个不存在的<span class="jill"></span>namespace<span class="jill"></span>中创建资源对象，则该创建请求将被拒绝。当删除一个<span class="jill"></span>namespace<span class="jill"></span>时，系统将会删除该<span class="jill"></span>namespace<span class="jill"></span>中所有对象。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">DefaultStorageClass：为了实现共享存储的动态供应，为未指定<span class="jill"></span>StorageClass<span class="jill"></span>或<span class="jill"></span>PV<span class="jill"></span>的<span class="jill"></span>PVC<span class="jill"></span>尝试匹配默认的<span class="jill"></span>StorageClass，尽可能减少用户在申请<span class="jill"></span>PVC<span class="jill"></span>时所需了解的后端存储细节</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">DefaultTolerationSeconds：这个插件为那些没有设置<span class="jill"></span>forgiveness tolerations<span class="jill"></span>并具有<span class="jill"></span>notready:NoExecute<span class="jill"></span>和<span class="jill"></span>unreachable:NoExecute<span class="jill"></span>两种<span class="jill"></span>taints<span class="jill"></span>的<span class="jill"></span>Pod<span class="jill"></span>设置默认的“容忍”时间，为<span class="jill"></span>5min</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">PodSecurityPolicy：这个插件用于在创建或修改<span class="jill"></span>Pod<span class="jill"></span>时决定是否根据<span class="jill"></span>Pod<span class="jill"></span>的<span class="jill"></span>security context<span class="jill"></span>和可用的<span class="jill"></span>PodSecurityPolicy<span class="jill"></span>对<span class="jill"></span>Pod<span class="jill"></span>的安全策略进行控制</span></li></ul><h3 class="wolai-block"><span class="inline-wrap">5.5 DashBoard</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">之前在<span class="jill"></span>kubernetes<span class="jill"></span>中完成的所有操作都是通过命令行工具<span class="jill"></span>kubectl<span class="jill"></span>完成的。其实，为了提供更丰富的用户体验，kubernetes<span class="jill"></span>还开发了一个基于<span class="jill"></span>web<span class="jill"></span>的用户界面（Dashboard）。用户可以使用<span class="jill"></span>Dashboard<span class="jill"></span>部署容器化的应用，还可以监控应用的状态，执行故障排查以及管理<span class="jill"></span>kubernetes<span class="jill"></span>中各种资源。</span></div></div><h4 class="wolai-block"><span class="inline-wrap">1）部署<span class="jill"></span>Dashboard</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">1) 下载<span class="jill"></span>yaml，并运行<span class="jill"></span>Dashboard</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 下载yaml</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># wget  https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span>

<span class="token comment"># 修改kubernetes-dashboard的Service类型</span>
<span class="token function">vim</span> recommended.yaml

kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort  <span class="token comment"># 新增</span>
  ports:
    - port: <span class="token number">443</span>
      targetPort: <span class="token number">8443</span>
      nodePort: <span class="token number">30009</span>  <span class="token comment"># 新增</span>
  selector:
    k8s-app: kubernetes-dashboard

<span class="token comment"># 部署</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create -f recommended.yaml</span>

<span class="token comment"># 查看namespace下的kubernetes-dashboard下的资源</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod,svc -n kubernetes-dashboard</span>
NAME                                            READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          111s
pod/kubernetes-dashboard-56484d4c5-z95z5        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          111s

NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
service/dashboard-metrics-scraper  ClusterIP  <span class="token number">10.96</span>.89.218    <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token number">8000</span>/TCP        111s
service/kubernetes-dashboard       NodePort   <span class="token number">10.104</span>.178.171  <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token number">443</span>:30009/TCP   111s

<span class="token comment">#下面先获取token，我们再进行登录，用的是"https"协议访问的，http不行！！</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">2）创建访问账户，获取<span class="jill"></span>token</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Bash" class="marker"></div><pre><span class="token comment"># 创建账号</span>
<span class="token punctuation">[</span>root@k8s-master01-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span>

<span class="token comment"># 授权</span>
<span class="token punctuation">[</span>root@k8s-master01-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span>

<span class="token comment"># 获取账号token</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span>
dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   <span class="token number">3</span>      2m35s

<span class="token comment">#注意，下面用到上面的输出，即 ”dashboard-admin-token-xbqhh“</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span>
Name:         dashboard-admin-token-xbqhh
Namespace:    kubernetes-dashboard
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">></span>
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
namespace:  <span class="token number">20</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw
ca.crt:     <span class="token number">1025</span> bytes</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">3）通过浏览器访问<span class="jill"></span>Dashboard<span class="jill"></span>的<span class="jill"></span>UI</span></div></div><div class="wolai-block wolai-text"><div><span class="red inline-wrap">注意，使用<span class="jill"></span>https 协议访问 &quot;kubectl get pod,svc -n kubernetes-dashboard&quot; 的&quot;service/kubernetes-dashboard&quot;</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在登录页面上输入上面的<span class="jill"></span>token</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150102805.png" style="width: 686.6666666666666px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">出现下面的页面代表成功</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150109189.png" style="width: 1274px"/></figure></div><h4 class="wolai-block"><span class="inline-wrap">2）使用<span class="jill"></span>DashBoard</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">本章节以<span class="jill"></span>Deployment<span class="jill"></span>为例演示<span class="jill"></span>DashBoard<span class="jill"></span>的使用</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>查看</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">选择指定的命名空间</span><span class="inline-wrap"><code>dev</code></span><span class="inline-wrap">，然后点击</span><span class="inline-wrap"><code>Deployments</code></span><span class="inline-wrap">，查看<span class="jill"></span>dev<span class="jill"></span>空间下的所有<span class="jill"></span>deployment</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150113921.png" style="width: 1260px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>扩缩容</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在</span><span class="inline-wrap"><code>Deployment</code></span><span class="inline-wrap">上点击</span><span class="inline-wrap"><code>规模</code></span><span class="inline-wrap">，然后指定</span><span class="inline-wrap"><code>目标副本数量</code></span><span class="inline-wrap">，点击确定</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150119908.png" style="width: 1055.3333333333333px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>编辑</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在</span><span class="inline-wrap"><code>Deployment</code></span><span class="inline-wrap">上点击</span><span class="inline-wrap"><code>编辑</code></span><span class="inline-wrap">，然后修改</span><span class="inline-wrap"><code>yaml<span class="jill"></span>文件</code></span><span class="inline-wrap">，点击确定</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150125364.png" style="width: 1038px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>查看<span class="jill"></span>Pod</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">点击</span><span class="inline-wrap"><code>Pods</code></span><span class="inline-wrap">, 查看<span class="jill"></span>pods<span class="jill"></span>列表</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/26/20220226150127895.png" style="width: 1252.6666666666667px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>操作<span class="jill"></span>Pod</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">选中某个<span class="jill"></span>Pod，可以对其执行日志（logs）、进入执行（exec）、编辑、删除操作</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="https://cdn.jsdelivr.net/gh/18476305640/typora@master/image/2022/02/25/20220225235848282.png" style="width: 1020px"/></figure></div><blockquote class="wolai-block"><span class="inline-wrap">Dashboard<span class="jill"></span>提供了<span class="jill"></span>kubectl<span class="jill"></span>的绝大部分功能，这里不再一一演示</span></blockquote><div class="wolai-block wolai-text"><div><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">[root@k8s-master ~]# kubectl get pod -n dev -o wide
</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">[root@k8s-master ~]# kubectl get pod -n dev -o wide</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-sub-page wolai-block"><div class="page-icon icon-image" style="background-image: url(&quot;media/1641538346333.png&quot;)"></div><a href="kubernetes%20%E5%AE%9E%E7%94%A8%E7%AF%87/Kubernetes%20%E5%AE%9E%E7%94%A8%E7%AF%87.html"><span>Kubernetes 实用篇</span></a></div><div class="wolai-block wolai-text"><div><br/></div></div><div class="wolai-sub-page wolai-block"><div data-symbol="📙" class="page-icon"></div><a href="k8s-%E8%A8%98/K8S-%E8%A8%98.html"><span>K8S-記</span></a></div></article><footer></footer></body></html>